<!-- Generated by SpecStory -->

<!-- cursor Session 9e3b5609-9aa3-45d0-bb3b-cb8c4fd256d0 (2025-10-21 10:04Z) -->

# ä¼˜åŒ–å®‰è£…kubeadmã€kubeletã€kubectlæ–‡æ¡£ (2025-10-21 10:04Z)

_**User (2025-10-22 09:42Z)**_

@è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md ä¼˜åŒ–æ–‡æ¡£ï¼Œæ·»åŠ æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸ

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·å¸Œæœ›æˆ‘ä¼˜åŒ–è¿™ä¸ªæ–‡æ¡£ï¼Œå¹¶æ·»åŠ æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸçš„å†…å®¹ã€‚è®©æˆ‘åˆ†æä¸€ä¸‹å½“å‰æ–‡æ¡£çš„ç»“æ„ï¼Œç„¶åæ·»åŠ ç›¸åº”çš„æ£€æŸ¥æ­¥éª¤ã€‚

å½“å‰æ–‡æ¡£åŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š
1. å‰æè¯´æ˜
2. ç¬¬ä¸€æ­¥ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡
3. ç¬¬äºŒæ­¥ï¼šå®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainerdï¼‰
4. ç¬¬ä¸‰æ­¥ï¼šå®‰è£…kubeletã€kubeadmã€kubectl
5. ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–MasterèŠ‚ç‚¹
6. ç¬¬äº”æ­¥ï¼šWorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤
7. éªŒè¯é›†ç¾¤çŠ¶æ€
8. å¸¸è§é—®é¢˜è§£å†³

æˆ‘éœ€è¦åœ¨æ¯ä¸ªå…³é”®æ­¥éª¤åæ·»åŠ æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸçš„å†…å®¹ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤ŸéªŒè¯æ¯ä¸€æ­¥æ˜¯å¦æ­£ç¡®å®Œæˆã€‚ä¼˜åŒ–åŒ…æ‹¬ï¼š

1. åœ¨æ¯ä¸ªæ­¥éª¤åæ·»åŠ éªŒè¯å‘½ä»¤
2. è¯´æ˜é¢„æœŸè¾“å‡ºç»“æœ
3. æä¾›æ›´è¯¦ç»†çš„æ£€æŸ¥æ–¹æ³•
4. å¢åŠ ä¸­é—´æ­¥éª¤çš„éªŒè¯

è®©æˆ‘è¯»å–æ–‡ä»¶å¹¶è¿›è¡Œä¼˜åŒ–ã€‚</details></think>

---

æˆ‘æ¥ä¼˜åŒ–è¿™ä¸ªæ–‡æ¡£ï¼Œåœ¨å…³é”®æ­¥éª¤åæ·»åŠ æ£€æŸ¥éªŒè¯ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½èƒ½ç¡®è®¤å®‰è£…æˆåŠŸã€‚

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 31, lines removed: undefined

```diff
@@ -102,4 +102,35 @@
  sysctl --system
  ```
+ 
+ 
+ #### 1.8 éªŒè¯åŸºç¡€ç¯å¢ƒé…ç½®
+ ```bash
+ # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€ï¼ˆåº”æ˜¾ç¤ºinactive/deadï¼‰
+ systemctl status firewalld
+ 
+ # æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆåº”æ˜¾ç¤ºDisabledæˆ–Permissiveï¼‰
+ getenforce
+ 
+ # æ£€æŸ¥swapçŠ¶æ€ï¼ˆSwapè¡Œåº”å…¨ä¸º0ï¼‰
+ free -m
+ 
+ # æ£€æŸ¥ä¸»æœºåï¼ˆåº”æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹è®¾ç½®çš„ä¸»æœºåï¼‰
+ hostname
+ 
+ # æ£€æŸ¥hostsè§£æï¼ˆåº”èƒ½pingé€šå…¶ä»–èŠ‚ç‚¹ï¼‰
+ ping -c 2 k8s-master-gz
+ ping -c 2 k8s-woker01-gz
+ ping -c 2 k8s-woker02-gz
+ 
+ # æ£€æŸ¥å†…æ ¸æ¨¡å—ï¼ˆåº”æœ‰è¿”å›ç»“æœï¼‰
+ lsmod | grep overlay
+ lsmod | grep br_netfilter
+ 
+ # æ£€æŸ¥å†…æ ¸å‚æ•°ï¼ˆæ‰€æœ‰å€¼åº”ä¸º1ï¼‰
+ sysctl net.bridge.bridge-nf-call-iptables
+ sysctl net.bridge.bridge-nf-call-ip6tables
+ sysctl net.ipv4.ip_forward
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šé˜²ç«å¢™å…³é—­ã€SELinuxå…³é—­ã€swapä¸º0ã€èŠ‚ç‚¹äº’é€šã€å†…æ ¸å‚æ•°æ­£ç¡®åŠ è½½ã€‚
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç»§ç»­æ·»åŠ å¯¹å®¹å™¨è¿è¡Œæ—¶å®‰è£…çš„æ£€æŸ¥æ­¥éª¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 18, lines removed: undefined

```diff
@@ -171,4 +171,22 @@
  systemctl enable containerd
  ```
+ 
+ 
+ #### 2.3 éªŒè¯Containerdå®‰è£…
+ ```bash
+ # æ£€æŸ¥containerdæœåŠ¡çŠ¶æ€ï¼ˆåº”æ˜¾ç¤ºactive/runningï¼‰
+ systemctl status containerd
+ 
+ # æ£€æŸ¥containerdç‰ˆæœ¬
+ containerd --version
+ 
+ # éªŒè¯containerdé…ç½®ï¼ˆæ£€æŸ¥å…³é”®é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼‰
+ grep "registry.aliyuncs.com" /etc/containerd/config.toml
+ grep "SystemdCgroup = true" /etc/containerd/config.toml
+ 
+ # æµ‹è¯•containerdè¿è¡Œï¼ˆåº”æ— æŠ¥é”™ï¼‰
+ ctr version
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šcontainerdæœåŠ¡è¿è¡Œæ­£å¸¸ã€é…ç½®æ–‡ä»¶ä¿®æ”¹æ­£ç¡®ã€å‘½ä»¤è¡Œå·¥å…·å¯ç”¨ã€‚
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç»§ç»­æ·»åŠ å¯¹kubeadmã€kubeletã€kubectlå®‰è£…çš„éªŒè¯æ­¥éª¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 17, lines removed: undefined

```diff
@@ -219,4 +219,21 @@
  systemctl enable --now kubelet
  ```
+ 
+ 
+ #### 3.3 éªŒè¯kubeç»„ä»¶å®‰è£…
+ ```bash
+ # æ£€æŸ¥ç»„ä»¶ç‰ˆæœ¬ï¼ˆåº”æ˜¾ç¤º1.28.0ï¼‰
+ kubelet --version
+ kubeadm version
+ kubectl version --client
+ 
+ # æ£€æŸ¥kubeletæœåŠ¡çŠ¶æ€ï¼ˆæ­¤æ—¶å¯èƒ½æ˜¾ç¤ºfailedï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œé›†ç¾¤åˆå§‹åŒ–åä¼šè‡ªåŠ¨æ¢å¤ï¼‰
+ systemctl status kubelet
+ 
+ # éªŒè¯kubeæºé…ç½®
+ dnf repolist | grep kubernetes
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šä¸‰ä¸ªç»„ä»¶ç‰ˆæœ¬å‡ä¸º1.28.0ã€kubernetesæºå·²å¯ç”¨ã€‚
+ > âš ï¸ **æ³¨æ„**ï¼šæ­¤æ—¶kubeletæœåŠ¡å¯èƒ½å¤„äºå¤±è´¥çŠ¶æ€ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œåœ¨æ‰§è¡Œkubeadm initåä¼šè‡ªåŠ¨æ¢å¤ã€‚
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æ·»åŠ masterèŠ‚ç‚¹åˆå§‹åŒ–åçš„è¯¦ç»†éªŒè¯æ­¥éª¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 8, lines removed: 1

```diff
@@ -264,5 +264,12 @@
  # éªŒè¯masterèŠ‚ç‚¹çŠ¶æ€ï¼ˆæ­¤æ—¶èŠ‚ç‚¹ä¸ºNotReadyï¼Œå› ä¸ºæœªå®‰è£…ç½‘ç»œæ’ä»¶ï¼‰
  kubectl get nodes
- ```
+ 
+ # æ£€æŸ¥kubectlé…ç½®æ˜¯å¦ç”Ÿæ•ˆ
+ kubectl cluster-info
+ 
+ # æŸ¥çœ‹kubeletæœåŠ¡çŠ¶æ€ï¼ˆæ­¤æ—¶åº”ä¸ºactive/runningï¼‰
+ systemctl status kubelet
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼škubectlå‘½ä»¤å¯æ­£å¸¸æ‰§è¡Œã€kubeletæœåŠ¡è¿è¡Œæ­£å¸¸ã€å¯ä»¥çœ‹åˆ°masterèŠ‚ç‚¹ï¼ˆçŠ¶æ€NotReadyæ­£å¸¸ï¼‰ã€‚
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç»§ç»­æ·»åŠ ç½‘ç»œæ’ä»¶å®‰è£…åçš„éªŒè¯ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 25, lines removed: undefined

```diff
@@ -288,7 +288,32 @@
  # éªŒè¯ç½‘ç»œæ’ä»¶çŠ¶æ€ï¼ˆæ‰€æœ‰podçŠ¶æ€ä¸ºRunningå³ä¸ºæˆåŠŸï¼‰
  kubectl get pods -n kube-flannel
+ 
+ # æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿç»„ä»¶podçŠ¶æ€
+ kubectl get pods -n kube-system
+ 
+ # æŸ¥çœ‹flannelæ—¥å¿—ï¼ˆç¡®è®¤æ— é”™è¯¯ï¼‰
+ kubectl logs -n kube-flannel -l app=flannel --tail=20
  ```
  
  - ç­‰å¾…2-3åˆ†é’Ÿï¼Œå†æ¬¡æ‰§è¡Œ`kubectl get nodes`ï¼ŒmasterèŠ‚ç‚¹çŠ¶æ€å˜ä¸º`Ready`ã€‚
+ 
+ #### 4.4 éªŒè¯MasterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ
+ ```bash
+ # æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼ˆåº”æ˜¾ç¤ºReadyï¼‰
+ kubectl get nodes
+ 
+ # æ£€æŸ¥æ‰€æœ‰ç³»ç»Ÿç»„ä»¶ï¼ˆæ‰€æœ‰podåº”ä¸ºRunningï¼‰
+ kubectl get pods -A
+ 
+ # éªŒè¯corednsæ˜¯å¦æ­£å¸¸è¿è¡Œ
+ kubectl get pods -n kube-system | grep coredns
+ 
+ # æ£€æŸ¥kube-systemå‘½åç©ºé—´ä¸‹æ‰€æœ‰ç»„ä»¶
+ kubectl get all -n kube-system
+ 
+ # æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
+ kubectl describe node k8s-master-gz
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šmasterèŠ‚ç‚¹çŠ¶æ€ä¸ºReadyã€æ‰€æœ‰ç³»ç»Ÿpodè¿è¡Œæ­£å¸¸ã€corednsæ­£å¸¸å¯åŠ¨ã€‚
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æ·»åŠ workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤åçš„éªŒè¯æ­¥éª¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 30, lines removed: undefined

```diff
@@ -333,4 +333,34 @@
    ```
  
+ 
+ #### 5.1 éªŒè¯WorkerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ
+ åœ¨workerèŠ‚ç‚¹æ‰§è¡Œjoinå‘½ä»¤åï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹éªŒè¯ï¼š
+ 
+ **åœ¨workerèŠ‚ç‚¹æœ¬åœ°éªŒè¯ï¼š**
+ ```bash
+ # æ£€æŸ¥kubeletæœåŠ¡çŠ¶æ€ï¼ˆåº”ä¸ºactive/runningï¼‰
+ systemctl status kubelet
+ 
+ # æŸ¥çœ‹kubeletæ—¥å¿—ï¼ˆç¡®è®¤è¿æ¥æˆåŠŸï¼‰
+ journalctl -xeu kubelet --no-pager | tail -30
+ ```
+ 
+ **åœ¨masterèŠ‚ç‚¹éªŒè¯ï¼ˆæ›´é‡è¦ï¼‰ï¼š**
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ï¼ˆåº”çœ‹åˆ°3ä¸ªèŠ‚ç‚¹ï¼ŒçŠ¶æ€å‡ä¸ºReadyï¼‰
+ kubectl get nodes
+ 
+ # æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
+ kubectl get nodes -o wide
+ 
+ # æ£€æŸ¥æ–°åŠ å…¥èŠ‚ç‚¹çš„è¯¦æƒ…
+ kubectl describe node k8s-woker01-gz
+ kubectl describe node k8s-woker02-gz
+ 
+ # éªŒè¯æ‰€æœ‰èŠ‚ç‚¹çš„podç½‘ç»œï¼ˆflannelåº”åœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œï¼‰
+ kubectl get pods -n kube-flannel -o wide
+ ```
+ > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šworkerèŠ‚ç‚¹kubeletè¿è¡Œæ­£å¸¸ã€åœ¨masterä¸Šå¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸ºReadyã€flannelåœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œã€‚
+ 
  
  ### **éªŒè¯é›†ç¾¤çŠ¶æ€ï¼ˆmasterèŠ‚ç‚¹æ‰§è¡Œï¼‰**
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦å¢å¼º"éªŒè¯é›†ç¾¤çŠ¶æ€"éƒ¨åˆ†ï¼Œæ·»åŠ æ›´å¤šçš„ç»¼åˆéªŒè¯å‘½ä»¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 113, lines removed: 3

```diff
@@ -364,12 +364,122 @@
  
  
- ### **éªŒè¯é›†ç¾¤çŠ¶æ€ï¼ˆmasterèŠ‚ç‚¹æ‰§è¡Œï¼‰**
+ ### **ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€ï¼ˆmasterèŠ‚ç‚¹æ‰§è¡Œï¼‰**
+ å®Œæˆæ‰€æœ‰èŠ‚ç‚¹éƒ¨ç½²åï¼Œè¿›è¡Œå…¨é¢çš„é›†ç¾¤å¥åº·æ£€æŸ¥ã€‚
+ 
+ #### 6.1 èŠ‚ç‚¹çŠ¶æ€éªŒè¯
  ```bash
  # æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ï¼ˆçŠ¶æ€å‡ä¸ºReadyå³ä¸ºæˆåŠŸï¼‰
  kubectl get nodes
  
- # æŸ¥çœ‹ç³»ç»Ÿç»„ä»¶çŠ¶æ€ï¼ˆæ‰€æœ‰podå‡ä¸ºRunningï¼‰
+ # æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬IPã€å®¹å™¨è¿è¡Œæ—¶ã€å†…æ ¸ç‰ˆæœ¬ç­‰ï¼‰
+ kubectl get nodes -o wide
+ 
+ # æ£€æŸ¥èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ
+ kubectl top nodes  # éœ€è¦å…ˆå®‰è£…metrics-serverï¼Œè‹¥æŠ¥é”™å¯è·³è¿‡
+ ```
+ 
+ 
+ #### 6.2 ç³»ç»Ÿç»„ä»¶éªŒè¯
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„podï¼ˆæ‰€æœ‰podå‡ä¸ºRunningï¼‰
+ kubectl get pods -A
+ 
+ # æŸ¥çœ‹kube-systemå‘½åç©ºé—´ç»„ä»¶çŠ¶æ€
  kubectl get pods -n kube-system
- ```
+ 
+ # æ£€æŸ¥å…³é”®ç»„ä»¶çŠ¶æ€
+ kubectl get componentstatuses  # è‹¥æ˜¾ç¤ºDeprecatedï¼Œå¯å¿½ç•¥
+ 
+ # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
+ kubectl cluster-info
+ ```
+ 
+ 
+ #### 6.3 ç½‘ç»œåŠŸèƒ½éªŒè¯
+ ```bash
+ # æŸ¥çœ‹flannelç½‘ç»œæ’ä»¶çŠ¶æ€ï¼ˆåº”åœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œï¼‰
+ kubectl get pods -n kube-flannel -o wide
+ 
+ # åˆ›å»ºæµ‹è¯•podéªŒè¯ç½‘ç»œè¿é€šæ€§
+ kubectl run test-nginx --image=nginx:alpine --port=80
+ kubectl expose pod test-nginx --port=80 --target-port=80
+ 
+ # ç­‰å¾…podè¿è¡Œ
+ kubectl get pods -w  # æŒ‰Ctrl+Cé€€å‡ºç›‘æ§
+ 
+ # æŸ¥çœ‹pod IP
+ kubectl get pods -o wide
+ 
+ # æµ‹è¯•podç½‘ç»œï¼ˆç”¨å¦ä¸€ä¸ªpodæµ‹è¯•è¿é€šæ€§ï¼‰
+ kubectl run test-curl --image=curlimages/curl --rm -it --restart=Never -- curl http://test-nginx
+ 
+ # æ¸…ç†æµ‹è¯•èµ„æº
+ kubectl delete pod test-nginx
+ kubectl delete svc test-nginx
+ ```
+ 
+ 
+ #### 6.4 DNSåŠŸèƒ½éªŒè¯
+ ```bash
+ # æ£€æŸ¥corednsçŠ¶æ€
+ kubectl get pods -n kube-system -l k8s-app=kube-dns
+ 
+ # æµ‹è¯•DNSè§£æ
+ kubectl run test-dns --image=busybox:1.28 --rm -it --restart=Never -- nslookup kubernetes.default
+ 
+ # è‹¥ä¸Šä¸€æ­¥æˆåŠŸï¼Œè¯´æ˜DNSæ­£å¸¸å·¥ä½œ
+ ```
+ 
+ 
+ #### 6.5 æŸ¥çœ‹é›†ç¾¤æ•´ä½“ä¿¡æ¯
+ ```bash
+ # æŸ¥çœ‹é›†ç¾¤ç‰ˆæœ¬ä¿¡æ¯
+ kubectl version
+ 
+ # æŸ¥çœ‹APIèµ„æºåˆ—è¡¨
+ kubectl api-resources
+ 
+ # æŸ¥çœ‹å‘½åç©ºé—´åˆ—è¡¨
+ kubectl get namespaces
+ 
+ # æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
+ kubectl describe nodes
+ 
+ # æŸ¥çœ‹é›†ç¾¤äº‹ä»¶ï¼ˆæ’æŸ¥é—®é¢˜æ—¶æœ‰ç”¨ï¼‰
+ kubectl get events -A --sort-by='.lastTimestamp'
+ ```
+ 
+ 
+ #### 6.6 éªŒè¯æˆåŠŸè¾“å‡ºç¤ºä¾‹
+ æ­£å¸¸æƒ…å†µä¸‹ï¼Œ`kubectl get nodes` å’Œ `kubectl get pods -A` åº”æœ‰ä»¥ä¸‹ç±»ä¼¼è¾“å‡ºï¼š
+ 
+ ```
+ # kubectl get nodes
+ NAME               STATUS   ROLES           AGE   VERSION
+ k8s-master-gz      Ready    control-plane   10m   v1.28.0
+ k8s-woker01-gz     Ready    <none>          5m    v1.28.0
+ k8s-woker02-gz     Ready    <none>          5m    v1.28.0
+ 
+ # kubectl get pods -A
+ NAMESPACE      NAME                                    READY   STATUS    RESTARTS   AGE
+ kube-flannel   kube-flannel-ds-xxxxx                   1/1     Running   0          8m
+ kube-flannel   kube-flannel-ds-yyyyy                   1/1     Running   0          5m
+ kube-flannel   kube-flannel-ds-zzzzz                   1/1     Running   0          5m
+ kube-system    coredns-xxxxxxxxxx-xxxxx                1/1     Running   0          10m
+ kube-system    coredns-xxxxxxxxxx-yyyyy                1/1     Running   0          10m
+ kube-system    etcd-k8s-master-gz                      1/1     Running   0          10m
+ kube-system    kube-apiserver-k8s-master-gz            1/1     Running   0          10m
+ kube-system    kube-controller-manager-k8s-master-gz   1/1     Running   0          10m
+ kube-system    kube-proxy-xxxxx                        1/1     Running   0          10m
+ kube-system    kube-proxy-yyyyy                        1/1     Running   0          5m
+ kube-system    kube-proxy-zzzzz                        1/1     Running   0          5m
+ kube-system    kube-scheduler-k8s-master-gz            1/1     Running   0          10m
+ ```
+ 
+ > âœ… **é›†ç¾¤éƒ¨ç½²æˆåŠŸæ ‡å‡†**ï¼š
+ > - æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸º `Ready`
+ > - æ‰€æœ‰ç³»ç»ŸpodçŠ¶æ€ä¸º `Running`
+ > - DNSè§£ææ­£å¸¸å·¥ä½œ
+ > - è·¨èŠ‚ç‚¹podç½‘ç»œäº’é€š
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨ç»§ç»­ä¼˜åŒ–å¸¸è§é—®é¢˜è§£å†³éƒ¨åˆ†ï¼Œæ·»åŠ æ›´å¤šçš„é—®é¢˜æ’æŸ¥å‘½ä»¤å’ŒéªŒè¯æ–¹æ³•ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 225, lines removed: 6

```diff
@@ -484,8 +484,227 @@
  
  
- ### **å¸¸è§é—®é¢˜è§£å†³**
- 1. **kubeletå¯åŠ¨å¤±è´¥**ï¼šæ£€æŸ¥swapæ˜¯å¦å…³é—­ï¼ˆ`free -m`ç¡®è®¤swapä¸º0ï¼‰ã€containerdçš„`SystemdCgroup`æ˜¯å¦è®¾ä¸º`true`ã€‚
- 2. **é•œåƒæ‹‰å–å¤±è´¥**ï¼šç¡®è®¤`--image-repository`æŒ‡å®šä¸ºé˜¿é‡Œæºï¼ˆ`registry.aliyuncs.com/google_containers`ï¼‰ã€‚
- 3. **èŠ‚ç‚¹NotReady**ï¼šæ£€æŸ¥ç½‘ç»œæ’ä»¶æ˜¯å¦éƒ¨ç½²æˆåŠŸï¼ˆ`kubectl get pods -n kube-flannel`ï¼‰ï¼Œæˆ–é˜²ç«å¢™æ˜¯å¦å½»åº•å…³é—­ã€‚
- 
- å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œk8sé›†ç¾¤ï¼ˆmaster+2 workerï¼‰å³éƒ¨ç½²å®Œæˆï¼Œå¯å¼€å§‹ä½¿ç”¨ã€‚
+ ### **ç¬¬ä¸ƒæ­¥ï¼šå¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³**
+ 
+ #### 7.1 kubeletå¯åŠ¨å¤±è´¥
+ **ç—‡çŠ¶**ï¼š`systemctl status kubelet` æ˜¾ç¤ºfailedçŠ¶æ€ï¼ˆåœ¨kubeadm initä¹‹åä¾ç„¶å¤±è´¥ï¼‰
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ ```bash
+ # 1. æ£€æŸ¥swapæ˜¯å¦å…³é—­ï¼ˆåº”ä¸º0ï¼‰
+ free -m
+ 
+ # 2. æ£€æŸ¥containerdé…ç½®
+ grep "SystemdCgroup" /etc/containerd/config.toml  # åº”ä¸ºtrue
+ 
+ # 3. æŸ¥çœ‹kubeletè¯¦ç»†æ—¥å¿—
+ journalctl -xeu kubelet -n 50
+ 
+ # 4. æ£€æŸ¥kubeleté…ç½®æ–‡ä»¶
+ ls -la /etc/kubernetes/kubelet.conf
+ cat /var/lib/kubelet/config.yaml
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ ```bash
+ # é‡æ–°å…³é—­swap
+ swapoff -a
+ sed -i '/swap/s/^/#/' /etc/fstab
+ 
+ # ä¿®æ­£containerdé…ç½®
+ sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
+ systemctl restart containerd
+ 
+ # é‡å¯kubelet
+ systemctl restart kubelet
+ ```
+ 
+ 
+ #### 7.2 é•œåƒæ‹‰å–å¤±è´¥
+ **ç—‡çŠ¶**ï¼špodçŠ¶æ€æ˜¾ç¤ºImagePullBackOffæˆ–ErrImagePull
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ ```bash
+ # æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯
+ kubectl describe pod <pod-name> -n <namespace>
+ 
+ # æŸ¥çœ‹containerdé•œåƒåˆ—è¡¨
+ crictl images
+ 
+ # æ‰‹åŠ¨æ‹‰å–é•œåƒæµ‹è¯•
+ crictl pull registry.aliyuncs.com/google_containers/pause:3.9
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ ```bash
+ # ç¡®è®¤containerdé…ç½®ä½¿ç”¨äº†é˜¿é‡Œé•œåƒ
+ grep "sandbox_image" /etc/containerd/config.toml
+ 
+ # è‹¥æœªé…ç½®ï¼Œæ‰‹åŠ¨ä¿®æ”¹
+ sed -i "s#sandbox_image = \"k8s.gcr.io/pause.*\"#sandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.9\"#g" /etc/containerd/config.toml
+ systemctl restart containerd
+ 
+ # é‡æ–°éƒ¨ç½²å¤±è´¥çš„pod
+ kubectl delete pod <pod-name> -n <namespace>
+ ```
+ 
+ 
+ #### 7.3 èŠ‚ç‚¹çŠ¶æ€NotReady
+ **ç—‡çŠ¶**ï¼š`kubectl get nodes` æ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€ä¸ºNotReady
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ ```bash
+ # æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
+ kubectl describe node <node-name>
+ 
+ # æ£€æŸ¥ç½‘ç»œæ’ä»¶çŠ¶æ€
+ kubectl get pods -n kube-flannel
+ 
+ # æŸ¥çœ‹kubeletæ—¥å¿—
+ journalctl -xeu kubelet -n 100
+ 
+ # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
+ systemctl status firewalld
+ 
+ # æ£€æŸ¥å†…æ ¸æ¨¡å—
+ lsmod | grep br_netfilter
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ ```bash
+ # é‡æ–°éƒ¨ç½²flannelç½‘ç»œæ’ä»¶
+ kubectl delete -f kube-flannel.yml
+ kubectl apply -f kube-flannel.yml
+ 
+ # ç¡®ä¿é˜²ç«å¢™å…³é—­
+ systemctl stop firewalld
+ systemctl disable firewalld
+ 
+ # é‡å¯kubelet
+ systemctl restart kubelet
+ ```
+ 
+ 
+ #### 7.4 workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤
+ **ç—‡çŠ¶**ï¼šæ‰§è¡Œkubeadm joinæ—¶æŠ¥é”™
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ ```bash
+ # åœ¨workerèŠ‚ç‚¹æ£€æŸ¥ä¸masterçš„è¿é€šæ€§
+ ping 172.16.0.10
+ telnet 172.16.0.10 6443
+ 
+ # æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼ˆåœ¨masterèŠ‚ç‚¹ï¼‰
+ kubeadm token list
+ 
+ # æŸ¥çœ‹åŠ å…¥å¤±è´¥çš„è¯¦ç»†æ—¥å¿—ï¼ˆåœ¨workerèŠ‚ç‚¹ï¼‰
+ journalctl -xeu kubelet -n 100
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ ```bash
+ # åœ¨masterèŠ‚ç‚¹é‡æ–°ç”Ÿæˆjoinå‘½ä»¤
+ kubeadm token create --print-join-command
+ 
+ # åœ¨workerèŠ‚ç‚¹å…ˆé‡ç½®ï¼ˆè‹¥ä¹‹å‰joinå¤±è´¥ï¼‰
+ kubeadm reset -f
+ systemctl restart kubelet
+ 
+ # ä½¿ç”¨æ–°çš„joinå‘½ä»¤é‡æ–°åŠ å…¥
+ kubeadm join 172.16.0.10:6443 --token <new-token> --discovery-token-ca-cert-hash sha256:<hash>
+ ```
+ 
+ 
+ #### 7.5 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€
+ **ç—‡çŠ¶**ï¼š`kubectl get pods -n kube-system` æ˜¾ç¤ºcorednsä¸ºPending
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ ```bash
+ # æŸ¥çœ‹coredns podè¯¦æƒ…
+ kubectl describe pod -n kube-system -l k8s-app=kube-dns
+ 
+ # æ£€æŸ¥ç½‘ç»œæ’ä»¶æ˜¯å¦å®‰è£…
+ kubectl get pods -n kube-flannel
+ 
+ # æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦Ready
+ kubectl get nodes
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ ```bash
+ # ç¡®ä¿å…ˆå®‰è£…ç½‘ç»œæ’ä»¶
+ kubectl apply -f kube-flannel.yml
+ 
+ # ç­‰å¾…flannelå¯åŠ¨åï¼Œcorednsä¼šè‡ªåŠ¨è°ƒåº¦
+ kubectl get pods -n kube-system -w
+ ```
+ 
+ 
+ #### 7.6 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰podçŠ¶æ€å’Œé‡å¯æ¬¡æ•°
+ kubectl get pods -A -o wide
+ 
+ # æŸ¥çœ‹æœ€è¿‘çš„é›†ç¾¤äº‹ä»¶
+ kubectl get events -A --sort-by='.lastTimestamp' | tail -30
+ 
+ # æŸ¥çœ‹ç‰¹å®špodçš„æ—¥å¿—
+ kubectl logs <pod-name> -n <namespace>
+ 
+ # è¿›å…¥podå†…éƒ¨æ’æŸ¥
+ kubectl exec -it <pod-name> -n <namespace> -- /bin/sh
+ 
+ # å®Œå…¨é‡ç½®é›†ç¾¤ï¼ˆæ…ç”¨ï¼Œä¼šåˆ é™¤æ‰€æœ‰é…ç½®ï¼‰
+ kubeadm reset -f
+ rm -rf /etc/kubernetes/
+ rm -rf /var/lib/kubelet/
+ rm -rf /var/lib/etcd/
+ rm -rf $HOME/.kube/
+ ```
+ 
+ 
+ #### 7.7 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•
+ åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´ï¼š
+ ```bash
+ # æ£€æŸ¥å„é¡¹é…ç½®
+ echo "=== é˜²ç«å¢™çŠ¶æ€ ==="
+ systemctl status firewalld | grep Active
+ 
+ echo "=== SELinuxçŠ¶æ€ ==="
+ getenforce
+ 
+ echo "=== SwapçŠ¶æ€ ==="
+ free -m | grep Swap
+ 
+ echo "=== ContainerdçŠ¶æ€ ==="
+ systemctl status containerd | grep Active
+ 
+ echo "=== KubeletçŠ¶æ€ ==="
+ systemctl status kubelet | grep Active
+ 
+ echo "=== ç»„ä»¶ç‰ˆæœ¬ ==="
+ kubelet --version
+ kubeadm version --short
+ kubectl version --client --short
+ 
+ echo "=== å†…æ ¸å‚æ•° ==="
+ sysctl net.ipv4.ip_forward
+ sysctl net.bridge.bridge-nf-call-iptables
+ ```
+ 
+ ---
+ 
+ ### **æ€»ç»“**
+ å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤å¹¶é€šè¿‡éªŒè¯åï¼Œæ‚¨çš„Kubernetesé›†ç¾¤ï¼ˆ1 master + 2 workerï¼‰å³éƒ¨ç½²å®Œæˆã€‚
+ 
+ **å¿«é€ŸéªŒè¯æ¸…å•**ï¼š
+ - âœ… æ‰€æœ‰èŠ‚ç‚¹é˜²ç«å¢™ã€SELinuxã€Swapå·²å…³é—­
+ - âœ… ContainerdæœåŠ¡è¿è¡Œæ­£å¸¸
+ - âœ… kubeletã€kubeadmã€kubectlç‰ˆæœ¬ä¸€è‡´
+ - âœ… MasterèŠ‚ç‚¹åˆå§‹åŒ–æˆåŠŸ
+ - âœ… ç½‘ç»œæ’ä»¶ï¼ˆFlannelï¼‰æ­£å¸¸è¿è¡Œ
+ - âœ… WorkerèŠ‚ç‚¹æˆåŠŸåŠ å…¥é›†ç¾¤
+ - âœ… æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸ºReady
+ - âœ… æ‰€æœ‰ç³»ç»ŸPodçŠ¶æ€ä¸ºRunning
+ - âœ… DNSè§£ææ­£å¸¸å·¥ä½œ
+ 
+ ç°åœ¨å¯ä»¥å¼€å§‹éƒ¨ç½²æ‚¨çš„åº”ç”¨äº†ï¼
```

</details>

---

<think><details><summary>Thought Process</summary>æ–‡æ¡£ä¼˜åŒ–å·²å®Œæˆï¼Œç°åœ¨æ·»åŠ ä¸€ä¸ªç›®å½•ç»“æ„ï¼Œè®©æ–‡æ¡£æ›´æ˜“äºå¯¼èˆªã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 51, lines removed: 4

```diff
@@ -1,6 +1,53 @@
- ä»¥ä¸‹æ˜¯åœ¨å›½å†…CentOS 9èŠ‚ç‚¹ï¼ˆmaster+2 workerï¼‰ä¸Šä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeletã€kubeadmã€kubectlçš„è¯¦ç»†æµç¨‹ï¼ŒåŒ…å«ç¯å¢ƒå‡†å¤‡ã€ä¾èµ–å®‰è£…ã€ç»„ä»¶éƒ¨ç½²ç­‰æ­¥éª¤ï¼š
- 
- 
- ### **å‰æè¯´æ˜**
+ # ä½¿ç”¨é˜¿é‡Œæºå®‰è£…Kubernetesé›†ç¾¤å®Œæ•´æŒ‡å—
+ 
+ ä»¥ä¸‹æ˜¯åœ¨å›½å†…CentOS 9èŠ‚ç‚¹ï¼ˆmaster+2 workerï¼‰ä¸Šä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeletã€kubeadmã€kubectlçš„è¯¦ç»†æµç¨‹ï¼ŒåŒ…å«ç¯å¢ƒå‡†å¤‡ã€ä¾èµ–å®‰è£…ã€ç»„ä»¶éƒ¨ç½²å’Œå…¨é¢éªŒè¯ç­‰æ­¥éª¤ã€‚
+ 
+ 
+ ## **ç›®å½•**
+ - [å‰æè¯´æ˜](#å‰æè¯´æ˜)
+ - [ç¬¬ä¸€æ­¥ï¼šæ‰€æœ‰èŠ‚ç‚¹çš„åŸºç¡€ç¯å¢ƒå‡†å¤‡](#ç¬¬ä¸€æ­¥æ‰€æœ‰èŠ‚ç‚¹çš„åŸºç¡€ç¯å¢ƒå‡†å¤‡å¿…åš)
+   - [1.1 å…³é—­é˜²ç«å¢™](#11-å…³é—­é˜²ç«å¢™k8séœ€è¦ç›´æ¥è®¿é—®èŠ‚ç‚¹ç«¯å£)
+   - [1.2 å…³é—­SELinux](#12-å…³é—­selinuxé¿å…æƒé™æ‹¦æˆª)
+   - [1.3 å…³é—­Swap](#13-å…³é—­swapk8sè¦æ±‚ç¦ç”¨swap)
+   - [1.4 é…ç½®ä¸»æœºåä¸Hostsè§£æ](#14-é…ç½®ä¸»æœºåä¸hostsè§£æç¡®ä¿èŠ‚ç‚¹é—´äº’é€š)
+   - [1.5 æ—¶é—´åŒæ­¥](#15-æ—¶é—´åŒæ­¥é¿å…èŠ‚ç‚¹æ—¶é—´ä¸ä¸€è‡´å¯¼è‡´è¯ä¹¦é—®é¢˜)
+   - [1.6 åŠ è½½k8sæ‰€éœ€å†…æ ¸æ¨¡å—](#16-åŠ è½½k8sæ‰€éœ€å†…æ ¸æ¨¡å—)
+   - [1.7 é…ç½®å†…æ ¸å‚æ•°](#17-é…ç½®å†…æ ¸å‚æ•°ä¼˜åŒ–ç½‘ç»œè½¬å‘)
+   - [1.8 éªŒè¯åŸºç¡€ç¯å¢ƒé…ç½®](#18-éªŒè¯åŸºç¡€ç¯å¢ƒé…ç½®)
+ - [ç¬¬äºŒæ­¥ï¼šæ‰€æœ‰èŠ‚ç‚¹å®‰è£…å®¹å™¨è¿è¡Œæ—¶](#ç¬¬äºŒæ­¥æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å®¹å™¨è¿è¡Œæ—¶containerd)
+   - [2.1 å®‰è£…Containerd](#21-å®‰è£…containerdä½¿ç”¨é˜¿é‡Œæº)
+   - [2.2 é…ç½®Containerd](#22-é…ç½®containerdé€‚é…k8sè¦æ±‚)
+   - [2.3 éªŒè¯Containerdå®‰è£…](#23-éªŒè¯containerdå®‰è£…)
+ - [ç¬¬ä¸‰æ­¥ï¼šæ‰€æœ‰èŠ‚ç‚¹å®‰è£…kubeç»„ä»¶](#ç¬¬ä¸‰æ­¥æ‰€æœ‰èŠ‚ç‚¹å®‰è£…kubeletkubeadmkubectlé˜¿é‡Œæº)
+   - [3.1 æ·»åŠ é˜¿é‡Œk8sæº](#31-æ·»åŠ é˜¿é‡Œk8sæº)
+   - [3.2 å®‰è£…kubeç»„ä»¶](#32-å®‰è£…kubeç»„ä»¶)
+   - [3.3 éªŒè¯kubeç»„ä»¶å®‰è£…](#33-éªŒè¯kubeç»„ä»¶å®‰è£…)
+ - [ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–MasterèŠ‚ç‚¹](#ç¬¬å››æ­¥åˆå§‹åŒ–masterèŠ‚ç‚¹ä»…åœ¨masteræ‰§è¡Œ)
+   - [4.1 åˆå§‹åŒ–é›†ç¾¤](#41-åˆå§‹åŒ–é›†ç¾¤å…³é”®æ­¥éª¤)
+   - [4.2 é…ç½®kubectlæƒé™](#42-é…ç½®kubectlæƒé™masterèŠ‚ç‚¹)
+   - [4.3 å®‰è£…ç½‘ç»œæ’ä»¶](#43-å®‰è£…ç½‘ç»œæ’ä»¶flannelmasterèŠ‚ç‚¹)
+   - [4.4 éªŒè¯MasterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ](#44-éªŒè¯masterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ)
+ - [ç¬¬äº”æ­¥ï¼šWorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤](#ç¬¬äº”æ­¥workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»…åœ¨workeræ‰§è¡Œ)
+   - [5.1 éªŒè¯WorkerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ](#51-éªŒè¯workerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ)
+ - [ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€](#ç¬¬å…­æ­¥å…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€masterèŠ‚ç‚¹æ‰§è¡Œ)
+   - [6.1 èŠ‚ç‚¹çŠ¶æ€éªŒè¯](#61-èŠ‚ç‚¹çŠ¶æ€éªŒè¯)
+   - [6.2 ç³»ç»Ÿç»„ä»¶éªŒè¯](#62-ç³»ç»Ÿç»„ä»¶éªŒè¯)
+   - [6.3 ç½‘ç»œåŠŸèƒ½éªŒè¯](#63-ç½‘ç»œåŠŸèƒ½éªŒè¯)
+   - [6.4 DNSåŠŸèƒ½éªŒè¯](#64-dnsåŠŸèƒ½éªŒè¯)
+   - [6.5 æŸ¥çœ‹é›†ç¾¤æ•´ä½“ä¿¡æ¯](#65-æŸ¥çœ‹é›†ç¾¤æ•´ä½“ä¿¡æ¯)
+   - [6.6 éªŒè¯æˆåŠŸè¾“å‡ºç¤ºä¾‹](#66-éªŒè¯æˆåŠŸè¾“å‡ºç¤ºä¾‹)
+ - [ç¬¬ä¸ƒæ­¥ï¼šå¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³](#ç¬¬ä¸ƒæ­¥å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³)
+   - [7.1 kubeletå¯åŠ¨å¤±è´¥](#71-kubeletå¯åŠ¨å¤±è´¥)
+   - [7.2 é•œåƒæ‹‰å–å¤±è´¥](#72-é•œåƒæ‹‰å–å¤±è´¥)
+   - [7.3 èŠ‚ç‚¹çŠ¶æ€NotReady](#73-èŠ‚ç‚¹çŠ¶æ€notready)
+   - [7.4 workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤](#74-workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤)
+   - [7.5 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€](#75-corednsä¸€ç›´å¤„äºpendingçŠ¶æ€)
+   - [7.6 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤](#76-é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤)
+   - [7.7 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•](#77-éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•)
+ - [æ€»ç»“](#æ€»ç»“)
+ 
+ ---
+ 
+ ## **å‰æè¯´æ˜**
  - èŠ‚ç‚¹ä¿¡æ¯ï¼š
    - masterèŠ‚ç‚¹ï¼šä¸»æœºå`k8s-master-gz`ï¼ŒIP`172.16.0.10`
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨è®©æˆ‘ç»™æ–‡æ¡£æ·»åŠ ä¸€ä¸ªå¿«é€Ÿä¸€é”®éªŒè¯è„šæœ¬éƒ¨åˆ†ï¼Œè®©ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°æ£€æŸ¥æ•´ä¸ªé›†ç¾¤çŠ¶æ€ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 294, lines removed: 14

```diff
@@ -741,17 +741,297 @@
  ---
  
- ### **æ€»ç»“**
- å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤å¹¶é€šè¿‡éªŒè¯åï¼Œæ‚¨çš„Kubernetesé›†ç¾¤ï¼ˆ1 master + 2 workerï¼‰å³éƒ¨ç½²å®Œæˆã€‚
+ ## **é™„å½•ï¼šä¸€é”®éªŒè¯è„šæœ¬**
...
- **å¿«é€ŸéªŒè¯æ¸…å•**ï¼š
- - âœ… æ‰€æœ‰èŠ‚ç‚¹é˜²ç«å¢™ã€SELinuxã€Swapå·²å…³é—­
- - âœ… ContainerdæœåŠ¡è¿è¡Œæ­£å¸¸
- - âœ… kubeletã€kubeadmã€kubectlç‰ˆæœ¬ä¸€è‡´
- - âœ… MasterèŠ‚ç‚¹åˆå§‹åŒ–æˆåŠŸ
- - âœ… ç½‘ç»œæ’ä»¶ï¼ˆFlannelï¼‰æ­£å¸¸è¿è¡Œ
- - âœ… WorkerèŠ‚ç‚¹æˆåŠŸåŠ å…¥é›†ç¾¤
- - âœ… æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸ºReady
- - âœ… æ‰€æœ‰ç³»ç»ŸPodçŠ¶æ€ä¸ºRunning
- - âœ… DNSè§£ææ­£å¸¸å·¥ä½œ
- 
- ç°åœ¨å¯ä»¥å¼€å§‹éƒ¨ç½²æ‚¨çš„åº”ç”¨äº†ï¼
+ ### A.1 é›†ç¾¤å¥åº·æ£€æŸ¥è„šæœ¬ï¼ˆåœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼‰
+ å°†ä»¥ä¸‹è„šæœ¬ä¿å­˜ä¸º `k8s-health-check.sh`ï¼Œç”¨äºå¿«é€Ÿæ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€ï¼š
+ 
+ ```bash
+ #!/bin/bash
+ # Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥è„šæœ¬
+ # åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ
+ 
+ echo "========================================"
+ echo "   Kubernetes é›†ç¾¤å¥åº·æ£€æŸ¥æŠ¥å‘Š"
+ echo "========================================"
+ echo ""
+ 
+ # 1. èŠ‚ç‚¹çŠ¶æ€æ£€æŸ¥
+ echo "ã€1ã€‘èŠ‚ç‚¹çŠ¶æ€æ£€æŸ¥"
+ echo "----------------------------------------"
+ kubectl get nodes -o wide
+ NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
+ READY_COUNT=$(kubectl get nodes --no-headers | grep -w "Ready" | wc -l)
+ echo ""
+ echo "èŠ‚ç‚¹æ€»æ•°: $NODE_COUNT | ReadyèŠ‚ç‚¹æ•°: $READY_COUNT"
+ if [ "$NODE_COUNT" -eq "$READY_COUNT" ]; then
+     echo "âœ… æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€æ­£å¸¸"
+ else
+     echo "âŒ å­˜åœ¨å¼‚å¸¸èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥"
+ fi
+ echo ""
+ 
+ # 2. ç³»ç»Ÿç»„ä»¶æ£€æŸ¥
+ echo "ã€2ã€‘ç³»ç»Ÿç»„ä»¶çŠ¶æ€æ£€æŸ¥"
+ echo "----------------------------------------"
+ kubectl get pods -n kube-system
+ SYSTEM_PODS=$(kubectl get pods -n kube-system --no-headers | wc -l)
+ RUNNING_PODS=$(kubectl get pods -n kube-system --no-headers | grep -w "Running" | wc -l)
+ echo ""
+ echo "ç³»ç»ŸPodæ€»æ•°: $SYSTEM_PODS | RunningçŠ¶æ€: $RUNNING_PODS"
+ if [ "$SYSTEM_PODS" -eq "$RUNNING_PODS" ]; then
+     echo "âœ… æ‰€æœ‰ç³»ç»Ÿç»„ä»¶è¿è¡Œæ­£å¸¸"
+ else
+     echo "âŒ å­˜åœ¨å¼‚å¸¸ç³»ç»Ÿç»„ä»¶ï¼Œè¯·æ£€æŸ¥"
+ fi
+ echo ""
+ 
+ # 3. ç½‘ç»œæ’ä»¶æ£€æŸ¥
+ echo "ã€3ã€‘ç½‘ç»œæ’ä»¶çŠ¶æ€æ£€æŸ¥"
+ echo "----------------------------------------"
+ kubectl get pods -n kube-flannel
+ FLANNEL_PODS=$(kubectl get pods -n kube-flannel --no-headers | wc -l)
+ FLANNEL_RUNNING=$(kubectl get pods -n kube-flannel --no-headers | grep -w "Running" | wc -l)
+ echo ""
+ echo "Flannel Podæ€»æ•°: $FLANNEL_PODS | RunningçŠ¶æ€: $FLANNEL_RUNNING"
+ if [ "$FLANNEL_PODS" -eq "$FLANNEL_RUNNING" ] && [ "$FLANNEL_PODS" -eq "$NODE_COUNT" ]; then
+     echo "âœ… ç½‘ç»œæ’ä»¶åœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œæ­£å¸¸"
+ else
+     echo "âŒ ç½‘ç»œæ’ä»¶å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥"
+ fi
+ echo ""
+ 
+ # 4. CoreDNSæ£€æŸ¥
+ echo "ã€4ã€‘CoreDNSçŠ¶æ€æ£€æŸ¥"
+ echo "----------------------------------------"
+ kubectl get pods -n kube-system -l k8s-app=kube-dns
+ COREDNS_COUNT=$(kubectl get pods -n kube-system -l k8s-app=kube-dns --no-headers | grep -w "Running" | wc -l)
+ echo ""
+ if [ "$COREDNS_COUNT" -ge 2 ]; then
+     echo "âœ… CoreDNSè¿è¡Œæ­£å¸¸"
+ else
+     echo "âŒ CoreDNSå­˜åœ¨é—®é¢˜"
+ fi
+ echo ""
+ 
+ # 5. é›†ç¾¤ä¿¡æ¯
+ echo "ã€5ã€‘é›†ç¾¤åŸºæœ¬ä¿¡æ¯"
+ echo "----------------------------------------"
+ kubectl cluster-info
+ echo ""
+ kubectl version --short 2>/dev/null || kubectl version
+ echo ""
+ 
+ # 6. èµ„æºä½¿ç”¨æƒ…å†µï¼ˆå¯é€‰ï¼‰
+ echo "ã€6ã€‘èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ"
+ echo "----------------------------------------"
+ kubectl top nodes 2>/dev/null || echo "âš ï¸  æœªå®‰è£…metrics-serverï¼Œè·³è¿‡èµ„æºæ£€æŸ¥"
+ echo ""
+ 
+ # 7. æœ€è¿‘äº‹ä»¶
+ echo "ã€7ã€‘æœ€è¿‘é›†ç¾¤äº‹ä»¶ï¼ˆæœ€å10æ¡ï¼‰"
+ echo "----------------------------------------"
+ kubectl get events -A --sort-by='.lastTimestamp' | tail -10
+ echo ""
+ 
+ # æ€»ç»“
+ echo "========================================"
+ echo "              æ£€æŸ¥å®Œæˆ"
+ echo "========================================"
+ echo ""
+ echo "å¿«é€ŸéªŒè¯å‘½ä»¤ï¼š"
+ echo "  kubectl get nodes              # æŸ¥çœ‹èŠ‚ç‚¹"
+ echo "  kubectl get pods -A            # æŸ¥çœ‹æ‰€æœ‰Pod"
+ echo "  kubectl get events -A          # æŸ¥çœ‹äº‹ä»¶"
+ echo ""
+ ```
+ 
+ **ä½¿ç”¨æ–¹æ³•**ï¼š
+ ```bash
+ # èµ‹äºˆæ‰§è¡Œæƒé™
+ chmod +x k8s-health-check.sh
+ 
+ # æ‰§è¡Œæ£€æŸ¥
+ ./k8s-health-check.sh
+ ```
+ 
+ 
+ ### A.2 èŠ‚ç‚¹ç¯å¢ƒæ£€æŸ¥è„šæœ¬ï¼ˆæ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰
+ å°†ä»¥ä¸‹è„šæœ¬ä¿å­˜ä¸º `node-env-check.sh`ï¼Œç”¨äºæ£€æŸ¥å•ä¸ªèŠ‚ç‚¹çš„åŸºç¡€ç¯å¢ƒï¼š
+ 
+ ```bash
+ #!/bin/bash
+ # KubernetesèŠ‚ç‚¹ç¯å¢ƒæ£€æŸ¥è„šæœ¬
+ # åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ
+ 
+ echo "========================================"
+ echo "   K8sèŠ‚ç‚¹ç¯å¢ƒæ£€æŸ¥æŠ¥å‘Š"
+ echo "========================================"
+ echo "ä¸»æœºå: $(hostname)"
+ echo "æ‰§è¡Œæ—¶é—´: $(date)"
+ echo ""
+ 
+ # 1. é˜²ç«å¢™æ£€æŸ¥
+ echo "ã€1ã€‘é˜²ç«å¢™çŠ¶æ€"
+ echo "----------------------------------------"
+ FIREWALL_STATUS=$(systemctl is-active firewalld)
+ if [ "$FIREWALL_STATUS" == "inactive" ]; then
+     echo "âœ… é˜²ç«å¢™å·²å…³é—­"
+ else
+     echo "âŒ é˜²ç«å¢™ä»åœ¨è¿è¡Œ: $FIREWALL_STATUS"
+ fi
+ echo ""
+ 
+ # 2. SELinuxæ£€æŸ¥
+ echo "ã€2ã€‘SELinuxçŠ¶æ€"
+ echo "----------------------------------------"
+ SELINUX_STATUS=$(getenforce)
+ if [ "$SELINUX_STATUS" == "Disabled" ] || [ "$SELINUX_STATUS" == "Permissive" ]; then
+     echo "âœ… SELinuxå·²å…³é—­: $SELINUX_STATUS"
+ else
+     echo "âŒ SELinuxä»åœ¨è¿è¡Œ: $SELINUX_STATUS"
+ fi
+ echo ""
+ 
+ # 3. Swapæ£€æŸ¥
+ echo "ã€3ã€‘SwapçŠ¶æ€"
+ echo "----------------------------------------"
+ SWAP_SIZE=$(free -m | grep Swap | awk '{print $2}')
+ if [ "$SWAP_SIZE" -eq 0 ]; then
+     echo "âœ… Swapå·²å…³é—­"
+ else
+     echo "âŒ Swapä»å¯ç”¨: ${SWAP_SIZE}MB"
+ fi
+ free -m | grep Swap
+ echo ""
+ 
+ # 4. å†…æ ¸æ¨¡å—æ£€æŸ¥
+ echo "ã€4ã€‘å†…æ ¸æ¨¡å—æ£€æŸ¥"
+ echo "----------------------------------------"
+ OVERLAY=$(lsmod | grep overlay | wc -l)
+ NETFILTER=$(lsmod | grep br_netfilter | wc -l)
+ if [ "$OVERLAY" -gt 0 ] && [ "$NETFILTER" -gt 0 ]; then
+     echo "âœ… å¿…éœ€å†…æ ¸æ¨¡å—å·²åŠ è½½"
+ else
+     echo "âŒ å†…æ ¸æ¨¡å—ç¼ºå¤±"
+ fi
+ echo "overlay: $OVERLAY"
+ echo "br_netfilter: $NETFILTER"
+ echo ""
+ 
+ # 5. å†…æ ¸å‚æ•°æ£€æŸ¥
+ echo "ã€5ã€‘å†…æ ¸å‚æ•°æ£€æŸ¥"
+ echo "----------------------------------------"
+ IP_FORWARD=$(sysctl -n net.ipv4.ip_forward)
+ IPTABLES=$(sysctl -n net.bridge.bridge-nf-call-iptables)
+ IP6TABLES=$(sysctl -n net.bridge.bridge-nf-call-ip6tables)
+ if [ "$IP_FORWARD" -eq 1 ] && [ "$IPTABLES" -eq 1 ] && [ "$IP6TABLES" -eq 1 ]; then
+     echo "âœ… å†…æ ¸å‚æ•°é…ç½®æ­£ç¡®"
+ else
+     echo "âŒ å†…æ ¸å‚æ•°é…ç½®é”™è¯¯"
+ fi
+ echo "net.ipv4.ip_forward: $IP_FORWARD"
+ echo "net.bridge.bridge-nf-call-iptables: $IPTABLES"
+ echo "net.bridge.bridge-nf-call-ip6tables: $IP6TABLES"
+ echo ""
+ 
+ # 6. ContainerdæœåŠ¡æ£€æŸ¥
+ echo "ã€6ã€‘ContainerdæœåŠ¡çŠ¶æ€"
+ echo "----------------------------------------"
+ CONTAINERD_STATUS=$(systemctl is-active containerd)
+ if [ "$CONTAINERD_STATUS" == "active" ]; then
+     echo "âœ… Containerdè¿è¡Œæ­£å¸¸"
+     containerd --version
+ else
+     echo "âŒ Containerdæœªè¿è¡Œ: $CONTAINERD_STATUS"
+ fi
+ echo ""
+ 
+ # 7. KubeletæœåŠ¡æ£€æŸ¥
+ echo "ã€7ã€‘KubeletæœåŠ¡çŠ¶æ€"
+ echo "----------------------------------------"
+ KUBELET_STATUS=$(systemctl is-active kubelet)
+ if [ "$KUBELET_STATUS" == "active" ]; then
+     echo "âœ… Kubeletè¿è¡Œæ­£å¸¸"
+     kubelet --version
+ else
+     echo "âš ï¸  KubeletçŠ¶æ€: $KUBELET_STATUS (åˆå§‹åŒ–å‰ä¸ºå¤±è´¥çŠ¶æ€æ˜¯æ­£å¸¸çš„)"
+ fi
+ echo ""
+ 
+ # 8. ç»„ä»¶ç‰ˆæœ¬æ£€æŸ¥
+ echo "ã€8ã€‘K8sç»„ä»¶ç‰ˆæœ¬"
+ echo "----------------------------------------"
+ kubelet --version 2>/dev/null
+ kubeadm version --short 2>/dev/null || kubeadm version
+ kubectl version --client --short 2>/dev/null || kubectl version --client
+ echo ""
+ 
+ # 9. ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
+ echo "ã€9ã€‘èŠ‚ç‚¹é—´ç½‘ç»œè¿é€šæ€§"
+ echo "----------------------------------------"
+ echo "æµ‹è¯•MasterèŠ‚ç‚¹è¿é€šæ€§:"
+ ping -c 2 172.16.0.10 > /dev/null 2>&1 && echo "âœ… MasterèŠ‚ç‚¹å¯è¾¾" || echo "âŒ MasterèŠ‚ç‚¹ä¸å¯è¾¾"
+ ping -c 2 k8s-master-gz > /dev/null 2>&1 && echo "âœ… Masterä¸»æœºåè§£ææ­£å¸¸" || echo "âŒ Masterä¸»æœºåè§£æå¤±è´¥"
+ echo ""
+ 
+ echo "========================================"
+ echo "              æ£€æŸ¥å®Œæˆ"
+ echo "========================================"
+ ```
+ 
+ **ä½¿ç”¨æ–¹æ³•**ï¼š
+ ```bash
+ # èµ‹äºˆæ‰§è¡Œæƒé™
+ chmod +x node-env-check.sh
+ 
+ # æ‰§è¡Œæ£€æŸ¥
+ ./node-env-check.sh
+ ```
+ 
+ ---
+ 
+ ## **æ€»ç»“**
+ 
+ å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤å¹¶é€šè¿‡éªŒè¯åï¼Œæ‚¨çš„Kubernetesé›†ç¾¤ï¼ˆ1 master + 2 workerï¼‰å³éƒ¨ç½²å®Œæˆã€‚
+ 
+ ### **å¿«é€ŸéªŒè¯æ¸…å•**
+ - âœ… æ‰€æœ‰èŠ‚ç‚¹é˜²ç«å¢™ã€SELinuxã€Swapå·²å…³é—­
+ - âœ… ContainerdæœåŠ¡è¿è¡Œæ­£å¸¸
+ - âœ… kubeletã€kubeadmã€kubectlç‰ˆæœ¬ä¸€è‡´
+ - âœ… MasterèŠ‚ç‚¹åˆå§‹åŒ–æˆåŠŸ
+ - âœ… ç½‘ç»œæ’ä»¶ï¼ˆFlannelï¼‰æ­£å¸¸è¿è¡Œ
+ - âœ… WorkerèŠ‚ç‚¹æˆåŠŸåŠ å…¥é›†ç¾¤
+ - âœ… æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸ºReady
+ - âœ… æ‰€æœ‰ç³»ç»ŸPodçŠ¶æ€ä¸ºRunning
+ - âœ… DNSè§£ææ­£å¸¸å·¥ä½œ
+ 
+ ### **ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®**
+ 1. **éƒ¨ç½²Dashboard**ï¼šå®‰è£…Kubernetes Dashboardå¯è§†åŒ–ç•Œé¢
+ 2. **é…ç½®å­˜å‚¨**ï¼šæ ¹æ®éœ€è¦é…ç½®NFSã€Cephç­‰æŒä¹…åŒ–å­˜å‚¨
+ 3. **å®‰è£…Ingress**ï¼šéƒ¨ç½²Nginx Ingress Controllerå®ç°å¤–éƒ¨è®¿é—®
+ 4. **ç›‘æ§å‘Šè­¦**ï¼šéƒ¨ç½²Prometheus + Grafanaç›‘æ§ç³»ç»Ÿ
+ 5. **æ—¥å¿—æ”¶é›†**ï¼šéƒ¨ç½²EFKï¼ˆElasticsearch + Fluentd + Kibanaï¼‰æ—¥å¿—ç³»ç»Ÿ
+ 
+ ### **å¸¸ç”¨ç®¡ç†å‘½ä»¤**
+ ```bash
+ # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
+ kubectl get nodes
+ kubectl get pods -A
+ kubectl cluster-info
+ 
+ # æŸ¥çœ‹èµ„æºä½¿ç”¨
+ kubectl top nodes
+ kubectl top pods -A
+ 
+ # æ•…éšœæ’æŸ¥
+ kubectl describe node <node-name>
+ kubectl logs <pod-name> -n <namespace>
+ kubectl get events -A
+ 
+ # èŠ‚ç‚¹ç»´æŠ¤
+ kubectl drain <node-name> --ignore-daemonsets  # é©±é€èŠ‚ç‚¹
+ kubectl cordon <node-name>                      # æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦
+ kubectl uncordon <node-name>                    # æ¢å¤èŠ‚ç‚¹è°ƒåº¦
+ ```
+ 
+ ğŸ‰ **æ­å–œï¼ç°åœ¨å¯ä»¥å¼€å§‹éƒ¨ç½²æ‚¨çš„åº”ç”¨äº†ï¼**
```

</details>

---

<think><details><summary>Thought Process</summary>æ–‡æ¡£ä¼˜åŒ–å®Œæˆï¼è®©æˆ‘æ€»ç»“ä¸€ä¸‹æˆ‘æ‰€åšçš„æ”¹è¿›ï¼š

1. æ·»åŠ äº†æ ‡é¢˜å’Œç›®å½•ç»“æ„ï¼Œæ–¹ä¾¿å¯¼èˆª
2. åœ¨æ¯ä¸ªå…³é”®æ­¥éª¤åæ·»åŠ äº†è¯¦ç»†çš„éªŒè¯å‘½ä»¤å’Œæ£€æŸ¥æ–¹æ³•
3. æ·»åŠ äº†é¢„æœŸè¾“å‡ºç»“æœè¯´æ˜
4. æ‰©å±•äº†å¸¸è§é—®é¢˜æ’æŸ¥éƒ¨åˆ†ï¼Œæä¾›äº†ç—‡çŠ¶ã€æ’æŸ¥æ­¥éª¤å’Œè§£å†³æ–¹æ³•
5. æ·»åŠ äº†ä¸¤ä¸ªå®ç”¨çš„ä¸€é”®éªŒè¯è„šæœ¬ï¼ˆé›†ç¾¤å¥åº·æ£€æŸ¥å’ŒèŠ‚ç‚¹ç¯å¢ƒæ£€æŸ¥ï¼‰
6. æ·»åŠ äº†æ€»ç»“éƒ¨åˆ†ï¼ŒåŒ…å«å¿«é€ŸéªŒè¯æ¸…å•ã€ä¸‹ä¸€æ­¥å»ºè®®å’Œå¸¸ç”¨å‘½ä»¤

ç°åœ¨æ–‡æ¡£æ›´åŠ å®Œå–„ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¯ä¸€æ­¥éƒ½æ¸…æ¥šåœ°éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸã€‚</details></think>

---

å®Œæˆï¼æˆ‘å·²ç»å…¨é¢ä¼˜åŒ–äº†æ–‡æ¡£ï¼Œä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

## ğŸ“‹ **ä¼˜åŒ–å†…å®¹æ€»ç»“**

### 1. **æ·»åŠ äº†å®Œæ•´çš„ç›®å½•ç»“æ„**
- ä¾¿äºå¿«é€Ÿå¯¼èˆªåˆ°å„ä¸ªç« èŠ‚
- æ¸…æ™°çš„å±‚çº§å…³ç³»

### 2. **æ¯ä¸ªå…³é”®æ­¥éª¤åéƒ½æ·»åŠ äº†éªŒè¯æ£€æŸ¥**
- **1.8** - åŸºç¡€ç¯å¢ƒé…ç½®éªŒè¯
- **2.3** - Containerdå®‰è£…éªŒè¯
- **3.3** - kubeç»„ä»¶å®‰è£…éªŒè¯
- **4.2/4.4** - MasterèŠ‚ç‚¹åˆå§‹åŒ–éªŒè¯
- **5.1** - WorkerèŠ‚ç‚¹åŠ å…¥éªŒè¯
- **ç¬¬å…­æ­¥** - å…¨é¢é›†ç¾¤çŠ¶æ€éªŒè¯ï¼ˆ6ä¸ªå­ç« èŠ‚ï¼‰

### 3. **å¤§å¹…æ‰©å±•äº†é—®é¢˜æ’æŸ¥éƒ¨åˆ†ï¼ˆç¬¬ä¸ƒæ­¥ï¼‰**
åŒ…å«7ä¸ªå¸¸è§é—®é¢˜çš„è¯¦ç»†è§£å†³æ–¹æ¡ˆï¼š
- kubeletå¯åŠ¨å¤±è´¥
- é•œåƒæ‹‰å–å¤±è´¥
- èŠ‚ç‚¹NotReady
- workerèŠ‚ç‚¹æ— æ³•åŠ å…¥
- corednså¼‚å¸¸
- é€šç”¨æ’æŸ¥å‘½ä»¤
- ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•

### 4. **æ·»åŠ äº†å®ç”¨å·¥å…·ï¼ˆé™„å½•ï¼‰**
- **é›†ç¾¤å¥åº·æ£€æŸ¥è„šæœ¬**ï¼šä¸€é”®æ£€æŸ¥æ•´ä¸ªé›†ç¾¤çŠ¶æ€
- **èŠ‚ç‚¹ç¯å¢ƒæ£€æŸ¥è„šæœ¬**ï¼šæ£€æŸ¥å•ä¸ªèŠ‚ç‚¹çš„åŸºç¡€é…ç½®

### 5. **å¢å¼ºäº†æ€»ç»“éƒ¨åˆ†**
- å¿«é€ŸéªŒè¯æ¸…å•
- ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®ï¼ˆDashboardã€å­˜å‚¨ã€Ingressç­‰ï¼‰
- å¸¸ç”¨ç®¡ç†å‘½ä»¤é€ŸæŸ¥

### 6. **æ¯ä¸ªéªŒè¯ç‚¹éƒ½æ ‡æ³¨äº†**
- âœ… æˆåŠŸæ ‡å‡†
- âš ï¸ æ³¨æ„äº‹é¡¹
- é¢„æœŸè¾“å‡ºç¤ºä¾‹

ç°åœ¨è¿™ä»½æ–‡æ¡£ä¸ä»…å‘Šè¯‰ç”¨æˆ·å¦‚ä½•å®‰è£…ï¼Œè¿˜èƒ½åœ¨æ¯ä¸€æ­¥éƒ½ç¡®è®¤å®‰è£…æ˜¯å¦æˆåŠŸï¼Œå¤§å¤§é™ä½äº†éƒ¨ç½²å¤±è´¥çš„é£é™©ï¼ğŸ‰

---

_**User (2025-10-22 10:21Z)**_

è¿™æ˜¯ä»€ä¹ˆé—®é¢˜ï¼š[root@k8s-woker01-gz ~]# kubelet --version
Kubernetes v1.28.0
[root@k8s-woker01-gz ~]# kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"28", GitVersion:"v1.28.0", GitCommit:"855e7c48de7388eb330da0f8d9d2394ee818fb8d", GitTreeState:"clean", BuildDate:"2023-08-15T10:20:15Z", GoVersion:"go1.20.7", Compiler:"gc", Platform:"linux/amd64"}
[root@k8s-woker01-gz ~]# kubectl version --client
Client Version: v1.28.0
Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3
[root@k8s-woker01-gz ~]# systemctl status kubelet
â— kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; preset: disabled)
    Drop-In: /usr/lib/systemd/system/kubelet.service.d
             â””â”€10-kubeadm.conf
     Active: active (running) since Wed 2025-10-22 18:15:32 CST; 2min 19s ago
       Docs: https://kubernetes.io/docs/
   Main PID: 58547 (kubelet)
      Tasks: 10 (limit: 47979)
     Memory: 34.2M (peak: 35.3M)
        CPU: 2.175s
     CGroup: /system.slice/kubelet.service
             â””â”€58547 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/k>

Oct 22 18:17:30 k8s-woker01-gz kubelet[58547]: E1022 18:17:30.076352   58547 pod_workers.go:1300] "Error syncing pod, skipping" err="failed to \"CreatePodSandbox>
Oct 22 18:17:32 k8s-woker01-gz kubelet[58547]: E1022 18:17:32.479943   58547 kubelet_node_status.go:452] "Node not becoming ready in time after startup"
Oct 22 18:17:32 k8s-woker01-gz kubelet[58547]: E1022 18:17:32.543284   58547 kubelet.go:2855] "Container runtime network not ready" networkReady="NetworkReady=fa>
Oct 22 18:17:34 k8s-woker01-gz kubelet[58547]: E1022 18:17:34.248690   58547 remote_runtime.go:193] "RunPodSandbox from runtime service failed" err="rpc error: c>
Oct 22 18:17:34 k8s-woker01-gz kubelet[58547]: E1022 18:17:34.248756   58547 kuberuntime_sandbox.go:72] "Failed to create sandbox for pod" err="rpc error: code =>
Oct 22 18:17:34 k8s-woker01-gz kubelet[58547]: E1022 18:17:34.248791   58547 kuberuntime_manager.go:1119] "CreatePodSandbox for pod failed" err="rpc error: code >
Oct 22 18:17:34 k8s-woker01-gz kubelet[58547]: E1022 18:17:34.248868   58547 pod_workers.go:1300] "Error syncing pod, skipping" err="failed to \"CreatePodSandbox>
Oct 22 18:17:37 k8s-woker01-gz kubelet[58547]: E1022 18:17:37.544503   58547 kubelet.go:2855] "Container runtime network not ready" networkReady="NetworkReady=fa>
Oct 22 18:17:42 k8s-woker01-gz kubelet[58547]: E1022 18:17:42.545128   58547 kubelet.go:2855] "Container runtime network not ready" networkReady="NetworkReady=fa>
Oct 22 18:17:47 k8s-woker01-gz kubelet[58547]: E1022 18:17:47.546190   58547 kubelet.go:2855] "Container runtime network not ready" networkReady="NetworkReady=fa>

[root@k8s-woker01-gz ~]# systemctl status kubeadm
Unit kubeadm.service could not be found.
[root@k8s-woker01-gz ~]# systemctl status kubectl
Unit kubectl.service could not be found.
[root@k8s-woker01-gz ~]# 

master:[root@k8s-master-gz ~]# kubectl get nodes
NAME             STATUS     ROLES           AGE     VERSION
k8s-master-gz    Ready      control-plane   87m     v1.28.2
k8s-woker01-gz   NotReady   <none>          2m51s   v1.28.0
[root@k8s-master-gz ~]#

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šworkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤åçŠ¶æ€ä¸ºNotReadyã€‚è®©æˆ‘åˆ†æä¸€ä¸‹é—®é¢˜ï¼š

1. **workerèŠ‚ç‚¹çš„kubeletæ­£åœ¨è¿è¡Œ**ï¼Œä½†æ˜¯æœ‰é”™è¯¯æ—¥å¿—
2. **å…³é”®é”™è¯¯ä¿¡æ¯**ï¼š
   - "Container runtime network not ready" networkReady="NetworkReady=false"
   - "Node not becoming ready in time after startup"
   - "CreatePodSandbox" å¤±è´¥

3. **ç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜**ï¼š
   - MasterèŠ‚ç‚¹ï¼šv1.28.2
   - WorkerèŠ‚ç‚¹ï¼šv1.28.0
   è™½ç„¶å°ç‰ˆæœ¬ä¸åŒï¼Œä½†è¿™ä¸åº”è¯¥æ˜¯ä¸»è¦é—®é¢˜

4. **ä¸»è¦é—®é¢˜æ˜¯ç½‘ç»œæ’ä»¶**ï¼š
   - é”™è¯¯ä¿¡æ¯æ˜ç¡®æ˜¾ç¤º "Container runtime network not ready"
   - è¿™é€šå¸¸æ„å‘³ç€ç½‘ç»œæ’ä»¶ï¼ˆflannelï¼‰æ²¡æœ‰åœ¨workerèŠ‚ç‚¹ä¸Šæ­£å¸¸è¿è¡Œ

è®©æˆ‘æä¾›è¯¦ç»†çš„æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆã€‚</details></think>

---

æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸€ä¸ª**ç½‘ç»œæ’ä»¶æœªå°±ç»ª**çš„é—®é¢˜ã€‚è®©æˆ‘å¸®æ‚¨åˆ†æå’Œè§£å†³ï¼š

## ğŸ” **é—®é¢˜è¯Šæ–­**

### å…³é”®é”™è¯¯ä¿¡æ¯ï¼š
```
Container runtime network not ready" networkReady="NetworkReady=false
Node not becoming ready in time after startup
CreatePodSandbox failed
```

è¿™è¡¨æ˜ **Flannelç½‘ç»œæ’ä»¶å°šæœªåœ¨workerèŠ‚ç‚¹ä¸Šè¿è¡Œ**ï¼Œå¯¼è‡´èŠ‚ç‚¹æ— æ³•åˆ›å»ºPodç½‘ç»œã€‚

### æ¬¡è¦é—®é¢˜ï¼š
- MasterèŠ‚ç‚¹ç‰ˆæœ¬ï¼š**v1.28.2**
- WorkerèŠ‚ç‚¹ç‰ˆæœ¬ï¼š**v1.28.0**  
- ç‰ˆæœ¬ä¸ä¸€è‡´å¯èƒ½ä¼šæœ‰å…¼å®¹æ€§é£é™©ï¼ˆè™½ç„¶å°ç‰ˆæœ¬å·®å¼‚é€šå¸¸å¯ä»¥å·¥ä½œï¼‰

---

## ğŸ› ï¸ **è§£å†³æ­¥éª¤**

### **ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥Flannelç½‘ç»œæ’ä»¶çŠ¶æ€ï¼ˆåœ¨MasterèŠ‚ç‚¹æ‰§è¡Œï¼‰**

---

Tool use: **run_terminal_cmd**

```bash
echo "è¯·åœ¨MasterèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥FlannelçŠ¶æ€ï¼š"
```

---

<think><details><summary>Thought Process</summary>ç”¨æˆ·è·³è¿‡äº†å‘½ä»¤ï¼Œæˆ‘åº”è¯¥ç›´æ¥ç»™å‡ºè§£å†³æ–¹æ¡ˆã€‚</details></think>

---

è¯·åœ¨**MasterèŠ‚ç‚¹**æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’æŸ¥å’Œä¿®å¤ï¼š

### **1. æ£€æŸ¥Flannelç½‘ç»œæ’ä»¶çŠ¶æ€**

```bash
# æŸ¥çœ‹flannel podsçŠ¶æ€
kubectl get pods -n kube-flannel -o wide

# æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„pods
kubectl get pods -A

# æ£€æŸ¥workerèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node k8s-woker01-gz
```

**æœŸæœ›ç»“æœ**ï¼šåº”è¯¥çœ‹åˆ°flannelåœ¨æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬k8s-woker01-gzï¼‰ä¸Šè¿è¡Œ

---

### **2. å¦‚æœFlannelæœªå®‰è£…æˆ–è¿è¡Œå¼‚å¸¸ï¼Œé‡æ–°éƒ¨ç½²**

```bash
# ä¸‹è½½flannelé…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰ï¼‰
wget https://raw.githubusercontent.com/flannel-io/flannel/v0.22.0/Documentation/kube-flannel.yml

# æˆ–ä½¿ç”¨å›½å†…é•œåƒ
wget https://gitee.com/mirrors/flannel/raw/v0.22.0/Documentation/kube-flannel.yml

# æ›¿æ¢é•œåƒä¸ºé˜¿é‡Œæºï¼ˆé¿å…æ‹‰å–å¤±è´¥ï¼‰
sed -i "s#quay.io/coreos/flannel#registry.cn-hangzhou.aliyuncs.com/kubernetes-minions/flannel#g" kube-flannel.yml

# éƒ¨ç½²æˆ–é‡æ–°éƒ¨ç½²flannel
kubectl apply -f kube-flannel.yml

# æŸ¥çœ‹flanneléƒ¨ç½²è¿›åº¦
kubectl get pods -n kube-flannel -w
```

---

### **3. æ£€æŸ¥Flannel DaemonSetæ˜¯å¦è¦†ç›–æ‰€æœ‰èŠ‚ç‚¹**

```bash
# æŸ¥çœ‹flannel DaemonSetçŠ¶æ€
kubectl get daemonset -n kube-flannel

# åº”è¯¥æ˜¾ç¤ºç±»ä¼¼ï¼š
# NAME              DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE
# kube-flannel-ds   2         2         2       2            2
```

---

### **4. åœ¨WorkerèŠ‚ç‚¹æ£€æŸ¥Containerdé…ç½®**

å¦‚æœFlannelå·²è¿è¡Œä½†workerèŠ‚ç‚¹ä»ç„¶NotReadyï¼Œåœ¨**WorkerèŠ‚ç‚¹**æ‰§è¡Œï¼š

```bash
# æ£€æŸ¥containerdé…ç½®ä¸­çš„ç½‘ç»œæ’ä»¶é…ç½®
grep -A 10 "\[plugins.\"io.containerd.grpc.v1.cri\".cni\]" /etc/containerd/config.toml

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# [plugins."io.containerd.grpc.v1.cri".cni]
#   bin_dir = "/opt/cni/bin"
#   conf_dir = "/etc/cni/net.d"

# æ£€æŸ¥CNIé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /etc/cni/net.d/

# æŸ¥çœ‹CNIç½‘ç»œé…ç½®
cat /etc/cni/net.d/10-flannel.conflist
```

---

### **5. é‡å¯WorkerèŠ‚ç‚¹çš„Kubeletï¼ˆå¦‚æœéœ€è¦ï¼‰**

```bash
# åœ¨workerèŠ‚ç‚¹æ‰§è¡Œ
systemctl restart kubelet

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -xeu kubelet -f
```

---

### **6. åœ¨MasterèŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€æ¢å¤**

```bash
# ç­‰å¾…2-3åˆ†é’ŸåæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node k8s-woker01-gz | tail -30
```

---

## ğŸ“ **å…³äºç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜**

è™½ç„¶å½“å‰v1.28.0å’Œv1.28.2çš„å·®å¼‚ä¸å¤§ï¼Œä½†å»ºè®®ç»Ÿä¸€ç‰ˆæœ¬ï¼š

### **é€‰é¡¹1ï¼šå‡çº§WorkerèŠ‚ç‚¹åˆ°v1.28.2ï¼ˆæ¨èï¼‰**

```bash
# åœ¨workerèŠ‚ç‚¹æ‰§è¡Œ
dnf install -y kubelet-1.28.2 kubeadm-1.28.2 kubectl-1.28.2 --disableexcludes=kubernetes

# é‡å¯kubelet
systemctl restart kubelet

# åœ¨masteræŸ¥çœ‹ç‰ˆæœ¬
kubectl get nodes -o wide
```

### **é€‰é¡¹2ï¼šé™çº§MasterèŠ‚ç‚¹åˆ°v1.28.0ï¼ˆä¸æ¨èï¼‰**

å¦‚æœéœ€è¦é™çº§ï¼Œè¿‡ç¨‹è¾ƒå¤æ‚ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæ“ä½œã€‚

---

## âœ… **å¿«é€Ÿæ’æŸ¥æ£€æŸ¥æ¸…å•**

åœ¨**MasterèŠ‚ç‚¹**ä¾æ¬¡æ‰§è¡Œï¼š

```bash
# 1. æ£€æŸ¥æ‰€æœ‰podsçŠ¶æ€
kubectl get pods -A | grep -E "flannel|NAMESPACE"

# 2. æ£€æŸ¥flannelæ—¥å¿—
kubectl logs -n kube-flannel -l app=flannel --tail=50

# 3. æ£€æŸ¥workerèŠ‚ç‚¹è¯¦æƒ…
kubectl describe node k8s-woker01-gz | grep -A 20 "Conditions:"

# 4. æŸ¥çœ‹é›†ç¾¤äº‹ä»¶
kubectl get events -A --sort-by='.lastTimestamp' | tail -20
```

---

## ğŸ¯ **é¢„æœŸç»“æœ**

æ­£å¸¸æƒ…å†µä¸‹ï¼Œflanneléƒ¨ç½²å2-3åˆ†é’Ÿå†…ï¼š

```bash
kubectl get nodes
# è¾“å‡ºåº”ä¸ºï¼š
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   90m   v1.28.2
k8s-woker01-gz   Ready    <none>          5m    v1.28.0  # çŠ¶æ€å˜ä¸ºReady
```

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ“ä½œåä»ç„¶æœ‰é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. `kubectl get pods -n kube-flannel -o wide` çš„è¾“å‡º
2. `kubectl logs -n kube-flannel <flannel-pod-name>` çš„æ—¥å¿—
3. WorkerèŠ‚ç‚¹ä¸Š `ls -la /etc/cni/net.d/` çš„è¾“å‡º

è¿™æ ·æˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®æ‚¨æ’æŸ¥ï¼

---

_**User (2025-10-22 10:21Z)**_

NAME             STATUS     ROLES           AGE     VERSION
k8s-master-gz    Ready      control-plane   87m     v1.28.2
k8s-woker01-gz   NotReady   <none>          2m51s   v1.28.0
[root@k8s-master-gz ~]# kubectl get pods -n kube-system | grep -E "calico|flannel|weave|cilium"
[root@k8s-master-gz ~]# kubectl get pods -n kube-flannel -o wide
NAME                    READY   STATUS     RESTARTS   AGE    IP            NODE             NOMINATED NODE   READINESS GATES
kube-flannel-ds-sgrls   1/1     Running    0          44m    172.16.0.10   k8s-master-gz    <none>           <none>
kube-flannel-ds-x4kxg   0/1     Init:0/2   0          7m5s   172.16.1.10   k8s-woker01-gz   <none>           <none>
[root@k8s-master-gz ~]# kubectl get pods -A
NAMESPACE      NAME                                    READY   STATUS              RESTARTS   AGE
kube-flannel   kube-flannel-ds-sgrls                   1/1     Running             0          44m
kube-flannel   kube-flannel-ds-x4kxg                   0/1     Init:0/2            0          7m14s
kube-system    coredns-66f779496c-glgk4                1/1     Running             0          91m
kube-system    coredns-66f779496c-r72vl                1/1     Running             0          91m
kube-system    etcd-k8s-master-gz                      1/1     Running             4          92m
kube-system    kube-apiserver-k8s-master-gz            1/1     Running             0          92m
kube-system    kube-controller-manager-k8s-master-gz   1/1     Running             0          92m
kube-system    kube-proxy-6jmhf                        0/1     ContainerCreating   0          7m14s
kube-system    kube-proxy-xck94                        1/1     Running             0          91m
kube-system    kube-scheduler-k8s-master-gz            1/1     Running             0          92m
[root@k8s-master-gz ~]# kubectl describe node k8s-woker01-gz
Name:               k8s-woker01-gz
Roles:              <none>
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=k8s-woker01-gz
                    kubernetes.io/os=linux
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: unix:///var/run/containerd/containerd.sock
                    node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Wed, 22 Oct 2025 18:15:33 +0800
Taints:             node.kubernetes.io/not-ready:NoExecute
                    node.kubernetes.io/not-ready:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  k8s-woker01-gz
  AcquireTime:     <unset>
  RenewTime:       Wed, 22 Oct 2025 18:22:52 +0800
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletNotReady              container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized
Addresses:
  InternalIP:  172.16.1.10
  Hostname:    k8s-woker01-gz
Capacity:
  cpu:                2
  ephemeral-storage:  41670636Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             7719304Ki
  pods:               110
Allocatable:
  cpu:                2
  ephemeral-storage:  38403658075
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             7616904Ki
  pods:               110
System Info:
  Machine ID:                 0e084b8463f64dd780e2e456a44082f0
  System UUID:                0e084b84-63f6-4dd7-80e2-e456a44082f0
  Boot ID:                    7a483049-a686-484a-b82f-247538af1aa3
  Kernel Version:             5.14.0-624.el9.x86_64
  OS Image:                   CentOS Stream 9
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  containerd://1.7.28
  Kubelet Version:            v1.28.0
  Kube-Proxy Version:         v1.28.0
PodCIDR:                      10.244.1.0/24
PodCIDRs:                     10.244.1.0/24
Non-terminated Pods:          (2 in total)
  Namespace                   Name                     CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                     ------------  ----------  ---------------  -------------  ---
  kube-flannel                kube-flannel-ds-x4kxg    100m (5%)     0 (0%)      50Mi (0%)        0 (0%)         7m23s
  kube-system                 kube-proxy-6jmhf         0 (0%)        0 (0%)      0 (0%)           0 (0%)         7m23s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests   Limits
  --------           --------   ------
  cpu                100m (5%)  0 (0%)
  memory             50Mi (0%)  0 (0%)
  ephemeral-storage  0 (0%)     0 (0%)
  hugepages-1Gi      0 (0%)     0 (0%)
  hugepages-2Mi      0 (0%)     0 (0%)
Events:
  Type    Reason                   Age                    From             Message
  ----    ------                   ----                   ----             -------
  Normal  NodeHasSufficientMemory  7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasSufficientMemory
  Normal  NodeHasNoDiskPressure    7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasNoDiskPressure
  Normal  NodeHasSufficientPID     7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasSufficientPID
  Normal  RegisteredNode           7m21s                  node-controller  Node k8s-woker01-gz event: Registered Node k8s-woker01-gz in Controller
[root@k8s-master-gz ~]# 

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç°åœ¨é—®é¢˜å¾ˆæ¸…æ¥šäº†ï¼š

1. **flannel pod åœ¨ worker èŠ‚ç‚¹ä¸Šå¡åœ¨ Init:0/2 çŠ¶æ€**
   - `kube-flannel-ds-x4kxg   0/1     Init:0/2   0          7m5s   172.16.1.10   k8s-woker01-gz`
   - è¿™æ„å‘³ç€ flannel çš„åˆå§‹åŒ–å®¹å™¨æ²¡æœ‰æˆåŠŸè¿è¡Œ

2. **kube-proxy ä¹Ÿå¡åœ¨ ContainerCreating çŠ¶æ€**
   - `kube-proxy-6jmhf                        0/1     ContainerCreating   0          7m14s`

3. **å…³é”®é”™è¯¯ä¿¡æ¯**ï¼š
   - `container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized`
   - `cni plugin not initialized` è¯´æ˜ CNI æ’ä»¶æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ CNI åˆå§‹åŒ–é—®é¢˜ï¼Œflannel çš„ init å®¹å™¨éœ€è¦ï¼š
1. å®‰è£… CNI äºŒè¿›åˆ¶æ–‡ä»¶åˆ° `/opt/cni/bin`
2. åˆ›å»º CNI é…ç½®æ–‡ä»¶åˆ° `/etc/cni/net.d/`

ä½†æ˜¯å®ƒå¡åœ¨ Init:0/2ï¼Œè¯´æ˜ç¬¬ä¸€ä¸ª init å®¹å™¨å°±æ²¡æœ‰æˆåŠŸã€‚

æˆ‘éœ€è¦è®©ç”¨æˆ·æ£€æŸ¥ï¼š
1. flannel pod çš„è¯¦ç»†çŠ¶æ€å’Œæ—¥å¿—
2. worker èŠ‚ç‚¹ä¸Šçš„ CNI ç›®å½•æƒé™
3. å¯èƒ½çš„é•œåƒæ‹‰å–é—®é¢˜</details></think>

---

## ğŸ” **é—®é¢˜ç¡®è®¤**

å¾ˆå¥½ï¼ç°åœ¨é—®é¢˜éå¸¸æ˜ç¡®äº†ï¼š

**æ ¸å¿ƒé—®é¢˜**ï¼šFlannelçš„Podåœ¨workerèŠ‚ç‚¹ä¸Šå¡åœ¨ **Init:0/2** çŠ¶æ€ï¼Œå¯¼è‡´CNIæ’ä»¶æœªåˆå§‹åŒ–ã€‚

å…³é”®ä¿¡æ¯ï¼š
```
kube-flannel-ds-x4kxg   0/1     Init:0/2   0   7m5s   172.16.1.10   k8s-woker01-gz
```
- **Init:0/2** è¡¨ç¤º2ä¸ªåˆå§‹åŒ–å®¹å™¨éƒ½è¿˜æ²¡å®Œæˆï¼Œç¬¬ä¸€ä¸ªå°±å¡ä½äº†
- é”™è¯¯ï¼š`cni plugin not initialized` - CNIæ’ä»¶æœªåˆå§‹åŒ–

---

## ğŸ› ï¸ **æ’æŸ¥å’Œè§£å†³æ­¥éª¤**

### **1. æŸ¥çœ‹Flannel Podçš„è¯¦ç»†çŠ¶æ€å’Œæ—¥å¿—**

åœ¨**MasterèŠ‚ç‚¹**æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# æŸ¥çœ‹flannel podçš„è¯¦ç»†ä¿¡æ¯
kubectl describe pod kube-flannel-ds-x4kxg -n kube-flannel

# æŸ¥çœ‹initå®¹å™¨çš„æ—¥å¿—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
kubectl logs kube-flannel-ds-x4kxg -n kube-flannel -c install-cni

# å¦‚æœä¸Šé¢å‘½ä»¤æŠ¥é”™ï¼Œå°è¯•æŸ¥çœ‹å¦ä¸€ä¸ªinitå®¹å™¨
kubectl logs kube-flannel-ds-x4kxg -n kube-flannel -c install-cni-plugin

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬initå®¹å™¨ï¼‰
kubectl get pod kube-flannel-ds-x4kxg -n kube-flannel -o jsonpath='{.spec.initContainers[*].name}'
```

**è¯·å°†è¿™äº›å‘½ä»¤çš„è¾“å‡ºæä¾›ç»™æˆ‘**ï¼Œç‰¹åˆ«æ˜¯ `describe` å’Œ `logs` çš„è¾“å‡ºã€‚

---

### **2. åœ¨WorkerèŠ‚ç‚¹æ£€æŸ¥CNIç›®å½•å’Œæƒé™**

åœ¨ **k8s-woker01-gz (172.16.1.10)** èŠ‚ç‚¹æ‰§è¡Œï¼š

```bash
# æ£€æŸ¥CNI binç›®å½•
ls -la /opt/cni/bin/
# å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
mkdir -p /opt/cni/bin

# æ£€æŸ¥CNIé…ç½®ç›®å½•
ls -la /etc/cni/net.d/
# å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
mkdir -p /etc/cni/net.d

# æ£€æŸ¥ç›®å½•æƒé™
ls -ld /opt/cni/ /etc/cni/

# æŸ¥çœ‹containerdçš„CNIé…ç½®
grep -A 5 "cni" /etc/containerd/config.toml | grep -E "bin_dir|conf_dir"
```

---

### **3. æ£€æŸ¥é•œåƒæ‹‰å–æƒ…å†µ**

åœ¨ **WorkerèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹å·²æ‹‰å–çš„é•œåƒ
crictl images | grep flannel

# æ‰‹åŠ¨å°è¯•æ‹‰å–flannelé•œåƒï¼ˆæµ‹è¯•ç½‘ç»œï¼‰
crictl pull registry.cn-hangzhou.aliyuncs.com/kubernetes-minions/flannel:v0.22.0

# æˆ–è€…åŸå§‹é•œåƒæº
crictl pull docker.io/flannel/flannel:v0.22.0
```

---

### **4. ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨åˆå§‹åŒ–CNI**

å¦‚æœinitå®¹å™¨ä¸€ç›´æ— æ³•å®Œæˆï¼Œå¯ä»¥åœ¨ **WorkerèŠ‚ç‚¹** æ‰‹åŠ¨åˆå§‹åŒ–CNIï¼š

```bash
# ä¸‹è½½CNIæ’ä»¶ï¼ˆå¦‚æœç›®å½•ä¸ºç©ºï¼‰
CNI_VERSION="v1.3.0"
mkdir -p /opt/cni/bin
curl -L "https://github.com/containernetworking/plugins/releases/download/${CNI_VERSION}/cni-plugins-linux-amd64-${CNI_VERSION}.tgz" | tar -C /opt/cni/bin -xz

# æˆ–ä½¿ç”¨å›½å†…é•œåƒ
wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz
tar -xzf cni-plugins-linux-amd64-v1.3.0.tgz -C /opt/cni/bin

# éªŒè¯CNIæ’ä»¶
ls -lh /opt/cni/bin/

# åˆ›å»ºflannel CNIé…ç½®ï¼ˆæ‰‹åŠ¨ï¼‰
cat > /etc/cni/net.d/10-flannel.conflist << EOF
{
  "name": "cbr0",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "flannel",
      "delegate": {
        "hairpinMode": true,
        "isDefaultGateway": true
      }
    },
    {
      "type": "portmap",
      "capabilities": {
        "portMappings": true
      }
    }
  ]
}
EOF

# é‡å¯containerdå’Œkubelet
systemctl restart containerd
systemctl restart kubelet
```

---

### **5. åˆ é™¤å¹¶é‡å»ºFlannel Pod**

åœ¨ **MasterèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# åˆ é™¤å¡ä½çš„flannel podï¼ˆä¼šè‡ªåŠ¨é‡å»ºï¼‰
kubectl delete pod kube-flannel-ds-x4kxg -n kube-flannel

# è§‚å¯Ÿé‡å»ºè¿‡ç¨‹
kubectl get pods -n kube-flannel -w

# å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œå®Œå…¨é‡æ–°éƒ¨ç½²flannel
kubectl delete -f kube-flannel.yml
kubectl apply -f kube-flannel.yml
```

---

### **6. æ£€æŸ¥é˜²ç«å¢™å’ŒSELinuxï¼ˆåœ¨WorkerèŠ‚ç‚¹ï¼‰**

```bash
# ç¡®è®¤é˜²ç«å¢™å·²å…³é—­
systemctl status firewalld
# å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œå…³é—­å®ƒ
systemctl stop firewalld
systemctl disable firewalld

# ç¡®è®¤SELinuxå·²å…³é—­
getenforce
# å¦‚æœæ˜¾ç¤ºEnforcingï¼Œä¸´æ—¶å…³é—­
setenforce 0
```

---

## ğŸ“‹ **å¿«é€Ÿè¯Šæ–­æ£€æŸ¥æ¸…å•**

è¯·æŒ‰é¡ºåºæä¾›ä»¥ä¸‹ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘è¿›ä¸€æ­¥å®šä½é—®é¢˜ï¼š

**åœ¨MasterèŠ‚ç‚¹ï¼š**
```bash
# 1. Flannel podè¯¦ç»†ä¿¡æ¯
kubectl describe pod kube-flannel-ds-x4kxg -n kube-flannel

# 2. Initå®¹å™¨æ—¥å¿—
kubectl logs kube-flannel-ds-x4kxg -n kube-flannel --all-containers=true

# 3. æŸ¥çœ‹flannelé…ç½®
kubectl get configmap -n kube-flannel kube-flannel-cfg -o yaml
```

**åœ¨WorkerèŠ‚ç‚¹ï¼š**
```bash
# 4. CNIç›®å½•çŠ¶æ€
ls -la /opt/cni/bin/ /etc/cni/net.d/

# 5. Containerdæ—¥å¿—
journalctl -xeu containerd -n 50 --no-pager

# 6. é•œåƒåˆ—è¡¨
crictl images
```

---

## ğŸ¯ **æœ€å¯èƒ½çš„åŸå› **

æ ¹æ®ç»éªŒï¼ŒInit:0/2 å¡ä½é€šå¸¸æ˜¯ä»¥ä¸‹åŸå› ä¹‹ä¸€ï¼š

1. **é•œåƒæ‹‰å–å¤±è´¥**ï¼ˆæœ€å¸¸è§ï¼‰
2. **CNIç›®å½•æƒé™é—®é¢˜** 
3. **SELinuxæˆ–é˜²ç«å¢™é˜»æ­¢**
4. **ç½‘ç»œé—®é¢˜å¯¼è‡´æ— æ³•ä¸‹è½½CNIæ’ä»¶**

è¯·å…ˆæ‰§è¡Œç¬¬1æ­¥çš„å‘½ä»¤ï¼Œå°† `kubectl describe pod` å’Œ `kubectl logs` çš„è¾“å‡ºç»™æˆ‘ï¼Œæˆ‘å¯ä»¥å¿«é€Ÿå®šä½å…·ä½“åŸå› ï¼

---

_**User (2025-10-22 10:21Z)**_

@kube-flannel.yml wokeræ‰§è¡Œè¿™ä¸ªèƒ½è§£å†³å—

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·é—®åœ¨workerèŠ‚ç‚¹æ‰§è¡Œkube-flannel.ymlèƒ½å¦è§£å†³é—®é¢˜ã€‚è®©æˆ‘å…ˆçœ‹çœ‹è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚

ä»æ–‡ä»¶å†…å®¹æ¥çœ‹ï¼š
1. è¿™ä¸ªæ˜¯flannelçš„DaemonSeté…ç½®
2. é•œåƒä½¿ç”¨çš„æ˜¯ `ghcr.io/flannel-io/flannel:v0.27.4` å’Œ `ghcr.io/flannel-io/flannel-cni-plugin:v1.8.0-flannel1`
3. **é—®é¢˜åœ¨è¿™é‡Œ**ï¼šé•œåƒæºæ˜¯ `ghcr.io`ï¼ˆGitHub Container Registryï¼‰ï¼Œåœ¨å›½å†…è®¿é—®å¾ˆå¯èƒ½å¤±è´¥ï¼

ç”¨æˆ·ä¹‹å‰çœ‹åˆ°çš„é—®é¢˜å°±æ˜¯Init:0/2å¡ä½ï¼Œå¾ˆå¯èƒ½å°±æ˜¯å› ä¸ºæ— æ³•æ‹‰å–è¿™äº›init containerçš„é•œåƒã€‚

**ä¸åº”è¯¥åœ¨workerèŠ‚ç‚¹æ‰§è¡Œè¿™ä¸ªyamlæ–‡ä»¶**ï¼Œå› ä¸ºï¼š
1. kubectl applyåº”è¯¥åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ
2. è¿™ä¸ªyamlä¼šåœ¨æ•´ä¸ªé›†ç¾¤åˆ›å»ºDaemonSetï¼Œä¼šå½±å“æ‰€æœ‰èŠ‚ç‚¹
3. å…³é”®é—®é¢˜æ˜¯é•œåƒæºä½¿ç”¨äº†ghcr.ioï¼Œéœ€è¦æ›¿æ¢ä¸ºå›½å†…é•œåƒæº

è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯ï¼š
1. åœ¨masterèŠ‚ç‚¹ä¿®æ”¹è¿™ä¸ªyamlæ–‡ä»¶ï¼Œæ›¿æ¢é•œåƒæºä¸ºé˜¿é‡Œäº‘æˆ–å…¶ä»–å›½å†…é•œåƒ
2. ç„¶ååœ¨masterèŠ‚ç‚¹é‡æ–°apply
3. æˆ–è€…åœ¨workerèŠ‚ç‚¹ç›´æ¥æ‰‹åŠ¨æ‹‰å–é•œåƒ</details></think>

---

## âš ï¸ **ä¸å»ºè®®åœ¨WorkerèŠ‚ç‚¹æ‰§è¡Œkube-flannel.yml**

è¿™ä¸ªYAMLæ–‡ä»¶åº”è¯¥**åªåœ¨MasterèŠ‚ç‚¹**æ‰§è¡Œï¼Œå› ä¸ºï¼š
1. WorkerèŠ‚ç‚¹é€šå¸¸æ²¡æœ‰é…ç½®kubectlè¿æ¥API Serverçš„æƒé™
2. è¿™ä¸ªæ–‡ä»¶ä¼šåœ¨æ•´ä¸ªé›†ç¾¤åˆ›å»ºDaemonSetèµ„æº

## ğŸ” **æˆ‘å‘ç°äº†é—®é¢˜æ ¹æºï¼**

æŸ¥çœ‹æ‚¨çš„ `kube-flannel.yml` æ–‡ä»¶ï¼Œ**é—®é¢˜å°±åœ¨è¿™é‡Œ**ï¼š

```yaml
image: ghcr.io/flannel-io/flannel:v0.27.4           # ä¸»å®¹å™¨é•œåƒ
image: ghcr.io/flannel-io/flannel-cni-plugin:v1.8.0-flannel1  # initå®¹å™¨é•œåƒ
```

**ä½¿ç”¨çš„æ˜¯ `ghcr.io`ï¼ˆGitHub Container Registryï¼‰é•œåƒæºï¼Œåœ¨å›½å†…è®¿é—®éå¸¸å›°éš¾ï¼**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆinitå®¹å™¨å¡åœ¨ `Init:0/2` çš„åŸå›  - **é•œåƒæ‹‰å–å¤±è´¥**ã€‚

---

## âœ… **æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šä¿®æ”¹YAMLæ–‡ä»¶å¹¶é‡æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰**

åœ¨ **MasterèŠ‚ç‚¹** åˆ›å»ºä¿®æ”¹åçš„é…ç½®æ–‡ä»¶ï¼š

```bash
# å¤‡ä»½åŸæ–‡ä»¶
cp kube-flannel.yml kube-flannel.yml.bak

# æ›¿æ¢é•œåƒä¸ºå›½å†…é˜¿é‡Œäº‘é•œåƒ
sed -i 's#ghcr.io/flannel-io/flannel:v0.27.4#docker.io/flannel/flannel:v0.22.0#g' kube-flannel.yml
sed -i 's#ghcr.io/flannel-io/flannel-cni-plugin:v1.8.0-flannel1#docker.io/flannel/flannel-cni-plugin:v1.2.0#g' kube-flannel.yml

# æˆ–è€…ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼ˆæ›´å¿«ï¼‰
# å…ˆåˆ é™¤æ—§çš„flannel
kubectl delete -f kube-flannel.yml.bak

# é‡æ–°éƒ¨ç½²ï¼ˆä½¿ç”¨ä¿®æ”¹åçš„æ–‡ä»¶ï¼‰
kubectl apply -f kube-flannel.yml

# è§‚å¯Ÿpodå¯åŠ¨æƒ…å†µ
kubectl get pods -n kube-flannel -w
```

### **æ–¹æ¡ˆ2ï¼šä½¿ç”¨å·²éªŒè¯çš„Flannelç‰ˆæœ¬ï¼ˆæ›´ç¨³å¦¥ï¼‰**

åœ¨ **MasterèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# åˆ é™¤å½“å‰çš„flannel
kubectl delete -f kube-flannel.yml

# ä¸‹è½½å¹¶ä½¿ç”¨v0.22.0ç‰ˆæœ¬ï¼ˆå›½å†…è®¿é—®æ›´ç¨³å®šï¼‰
wget https://raw.githubusercontent.com/flannel-io/flannel/v0.22.0/Documentation/kube-flannel.yml -O kube-flannel-v0.22.0.yml

# å¦‚æœwgetå¤±è´¥ï¼Œä½¿ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºæ–‡ä»¶
cat > kube-flannel-v0.22.0.yml << 'EOF'
# å°†ä¸‹é¢æä¾›çš„é…ç½®ç²˜è´´è¿›å»
EOF

# åº”ç”¨æ–°é…ç½®
kubectl apply -f kube-flannel-v0.22.0.yml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n kube-flannel -o wide
```

### **æ–¹æ¡ˆ3ï¼šåœ¨WorkerèŠ‚ç‚¹æ‰‹åŠ¨é¢„æ‹‰å–é•œåƒï¼ˆå¿«é€Ÿä¸´æ—¶æ–¹æ¡ˆï¼‰**

å¦‚æœä¸æƒ³åˆ é™¤é‡å»ºï¼Œå¯ä»¥åœ¨ **WorkerèŠ‚ç‚¹ (172.16.1.10)** æ‰§è¡Œï¼š

```bash
# æ–¹å¼1ï¼šä½¿ç”¨docker.ioé•œåƒæº
crictl pull docker.io/flannel/flannel:v0.22.0
crictl pull docker.io/flannel/flannel-cni-plugin:v1.2.0

# æ–¹å¼2ï¼šå¦‚æœä¸Šé¢ä¸è¡Œï¼Œä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿ
crictl pull registry.cn-hangzhou.aliyuncs.com/google_containers/flannel:v0.22.0

# æ–¹å¼3ï¼šå…ˆåœ¨å¯ä»¥è®¿é—®ghcr.ioçš„æœºå™¨æ‹‰å–ï¼Œç„¶åå¯¼å‡ºå¯¼å…¥
# è¿™ä¸ªæ–¹å¼æ¯”è¾ƒå¤æ‚ï¼Œä¸æ¨è
```

**æ³¨æ„**ï¼šå³ä½¿æ‰‹åŠ¨æ‹‰å–äº†é•œåƒï¼Œä½†å¦‚æœYAMLä¸­é…ç½®çš„é•œåƒåç§°ä¸åŒ¹é…ï¼Œè¿˜æ˜¯ä¼šå¤±è´¥ã€‚æ‰€ä»¥**æ¨èæ–¹æ¡ˆ1æˆ–2**ã€‚

---

## ğŸ¯ **æˆ‘å»ºè®®çš„å®Œæ•´æ“ä½œæ­¥éª¤**

### **åœ¨MasterèŠ‚ç‚¹æ‰§è¡Œï¼š**

```bash
# 1. å…ˆåˆ é™¤å½“å‰å¡ä½çš„flannel
kubectl delete -f kube-flannel.yml

# 2. ä¿®æ”¹YAMLæ–‡ä»¶ï¼Œæ›¿æ¢ä¸ºå¯è®¿é—®çš„é•œåƒæº
cat > kube-flannel-fixed.yml << 'EOF'
apiVersion: v1
kind: Namespace
metadata:
  labels:
    k8s-app: flannel
    pod-security.kubernetes.io/enforce: privileged
  name: kube-flannel
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: flannel
  name: flannel
  namespace: kube-flannel
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    k8s-app: flannel
  name: flannel
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes/status
  verbs:
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    k8s-app: flannel
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-flannel
---
apiVersion: v1
data:
  cni-conf.json: |
    {
      "name": "cbr0",
      "cniVersion": "0.3.1",
      "plugins": [
        {
          "type": "flannel",
          "delegate": {
            "hairpinMode": true,
            "isDefaultGateway": true
          }
        },
        {
          "type": "portmap",
          "capabilities": {
            "portMappings": true
          }
        }
      ]
    }
  net-conf.json: |
    {
      "Network": "10.244.0.0/16",
      "EnableNFTables": false,
      "Backend": {
        "Type": "vxlan"
      }
    }
kind: ConfigMap
metadata:
  labels:
    app: flannel
    k8s-app: flannel
    tier: node
  name: kube-flannel-cfg
  namespace: kube-flannel
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: flannel
    k8s-app: flannel
    tier: node
  name: kube-flannel-ds
  namespace: kube-flannel
spec:
  selector:
    matchLabels:
      app: flannel
      k8s-app: flannel
  template:
    metadata:
      labels:
        app: flannel
        k8s-app: flannel
        tier: node
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      containers:
      - args:
        - --ip-masq
        - --kube-subnet-mgr
        command:
        - /opt/bin/flanneld
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: EVENT_QUEUE_DEPTH
          value: "5000"
        image: docker.io/flannel/flannel:v0.22.0
        name: kube-flannel
        resources:
          requests:
            cpu: 100m
            memory: 50Mi
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
          privileged: false
        volumeMounts:
        - mountPath: /run/flannel
          name: run
        - mountPath: /etc/kube-flannel/
          name: flannel-cfg
        - mountPath: /run/xtables.lock
          name: xtables-lock
      hostNetwork: true
      initContainers:
      - args:
        - -f
        - /flannel
        - /opt/cni/bin/flannel
        command:
        - cp
        image: docker.io/flannel/flannel-cni-plugin:v1.2.0
        name: install-cni-plugin
        volumeMounts:
        - mountPath: /opt/cni/bin
          name: cni-plugin
      - args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
        command:
        - cp
        image: docker.io/flannel/flannel:v0.22.0
        name: install-cni
        volumeMounts:
        - mountPath: /etc/cni/net.d
          name: cni
        - mountPath: /etc/kube-flannel/
          name: flannel-cfg
      priorityClassName: system-node-critical
      serviceAccountName: flannel
      tolerations:
      - effect: NoSchedule
        operator: Exists
      volumes:
      - hostPath:
          path: /run/flannel
        name: run
      - hostPath:
          path: /opt/cni/bin
        name: cni-plugin
      - hostPath:
          path: /etc/cni/net.d
        name: cni
      - configMap:
          name: kube-flannel-cfg
        name: flannel-cfg
      - hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
        name: xtables-lock
EOF

# 3. åº”ç”¨ä¿®å¤åçš„é…ç½®
kubectl apply -f kube-flannel-fixed.yml

# 4. è§‚å¯Ÿpodå¯åŠ¨ï¼ˆç­‰å¾…2-3åˆ†é’Ÿï¼‰
kubectl get pods -n kube-flannel -w

# 5. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
```

---

## ğŸ“Š **é¢„æœŸç»“æœ**

å¤§çº¦2-3åˆ†é’Ÿåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```bash
# kubectl get pods -n kube-flannel -o wide
NAME                    READY   STATUS    RESTARTS   AGE
kube-flannel-ds-xxxxx   1/1     Running   0          2m
kube-flannel-ds-yyyyy   1/1     Running   0          2m

# kubectl get nodes
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   95m   v1.28.2
k8s-woker01-gz   Ready    <none>          15m   v1.28.0  âœ…
```

---

## ğŸ’¡ **æ€»ç»“**

**é—®é¢˜æ ¹æº**ï¼šä½¿ç”¨äº† `ghcr.io` é•œåƒæºï¼Œå›½å†…æ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨MasterèŠ‚ç‚¹ä¿®æ”¹YAMLä½¿ç”¨ `docker.io` é•œåƒæºå¹¶é‡æ–°éƒ¨ç½²

**ä¸è¦åœ¨WorkerèŠ‚ç‚¹æ‰§è¡Œè¿™ä¸ªYAML**ï¼Œåº”è¯¥åœ¨MasterèŠ‚ç‚¹æ“ä½œï¼

---

_**User (2025-10-22 10:21Z)**_

ä½¿ç”¨ ghcr.io ï¼Œå›½å†…å¯ä»¥è®¿é—®å•Šï¼Œæˆ‘masteréƒ½èµ·æ¥äº†

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·è¯´å¾—å¯¹ï¼masterèŠ‚ç‚¹ä¸Šçš„flannelå·²ç»ç”¨`ghcr.io`é•œåƒæˆåŠŸè¿è¡Œäº†ï¼š
```
kube-flannel-ds-sgrls   1/1     Running    0          44m    172.16.0.10   k8s-master-gz
```

æ‰€ä»¥é—®é¢˜ä¸æ˜¯é•œåƒæºè®¿é—®çš„é—®é¢˜ã€‚è®©æˆ‘é‡æ–°åˆ†æï¼š

1. MasterèŠ‚ç‚¹ä¸Šçš„flannel podè¿è¡Œæ­£å¸¸ï¼ˆä½¿ç”¨ghcr.ioé•œåƒï¼‰
2. WorkerèŠ‚ç‚¹ä¸Šçš„flannel podå¡åœ¨Init:0/2çŠ¶æ€

è¿™è¯´æ˜ï¼š
- é•œåƒå¯ä»¥è®¿é—®ï¼ˆMasterå·²ç»è¯æ˜äº†ï¼‰
- é—®é¢˜å¯èƒ½åœ¨WorkerèŠ‚ç‚¹æœ¬èº«

å¸¸è§åŸå› ï¼š
1. WorkerèŠ‚ç‚¹ä¸Šé•œåƒæ‹‰å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯è¯¥èŠ‚ç‚¹çš„ç½‘ç»œé—®é¢˜ï¼‰
2. WorkerèŠ‚ç‚¹çš„CNIç›®å½•ä¸å­˜åœ¨æˆ–æƒé™é—®é¢˜
3. WorkerèŠ‚ç‚¹çš„containerdé…ç½®é—®é¢˜
4. WorkerèŠ‚ç‚¹çš„SELinux/é˜²ç«å¢™é—®é¢˜

æˆ‘éœ€è¦è®©ç”¨æˆ·æ£€æŸ¥WorkerèŠ‚ç‚¹çš„å…·ä½“æƒ…å†µã€‚</details></think>

---

æ‚¨è¯´å¾—å¯¹ï¼æˆ‘çœ‹åˆ°MasterèŠ‚ç‚¹çš„flannelç¡®å®å·²ç»ç”¨`ghcr.io`æˆåŠŸè¿è¡Œäº†ï¼š

```
kube-flannel-ds-sgrls   1/1     Running    0          44m    172.16.0.10   k8s-master-gz
```

æ‰€ä»¥é—®é¢˜**ä¸æ˜¯é•œåƒæºçš„é—®é¢˜**ï¼Œè€Œæ˜¯**WorkerèŠ‚ç‚¹ç‰¹æœ‰çš„é—®é¢˜**ã€‚

---

## ğŸ” **é‡æ–°åˆ†æé—®é¢˜**

æ—¢ç„¶Masterå¯ä»¥æ‹‰å–é•œåƒï¼ŒWorkerèŠ‚ç‚¹å¡åœ¨Init:0/2ï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

### **1. WorkerèŠ‚ç‚¹é•œåƒæ‹‰å–é€Ÿåº¦æ…¢æˆ–è¶…æ—¶**

è¯·åœ¨ **MasterèŠ‚ç‚¹** æŸ¥çœ‹Workerä¸Šçš„flannel podè¯¦ç»†çŠ¶æ€ï¼š

```bash
# æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯ï¼Œç‰¹åˆ«å…³æ³¨Eventséƒ¨åˆ†
kubectl describe pod kube-flannel-ds-x4kxg -n kube-flannel | tail -50

# æŸ¥çœ‹initå®¹å™¨çš„å…·ä½“çŠ¶æ€
kubectl get pod kube-flannel-ds-x4kxg -n kube-flannel -o jsonpath='{.status.initContainerStatuses[*]}' | jq .
```

### **2. WorkerèŠ‚ç‚¹çš„CNIç›®å½•é—®é¢˜**

åœ¨ **WorkerèŠ‚ç‚¹ (k8s-woker01-gz)** æ£€æŸ¥ï¼š

```bash
# æ£€æŸ¥CNIç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /opt/cni/bin/
ls -la /etc/cni/net.d/

# å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒä»¬
mkdir -p /opt/cni/bin
mkdir -p /etc/cni/net.d

# æ£€æŸ¥ç›®å½•æƒé™ï¼ˆåº”è¯¥æ˜¯root:rootï¼Œ755ï¼‰
ls -ld /opt/cni /opt/cni/bin /etc/cni /etc/cni/net.d
```

### **3. åœ¨WorkerèŠ‚ç‚¹æ£€æŸ¥é•œåƒæ‹‰å–æƒ…å†µ**

åœ¨ **WorkerèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹æ˜¯å¦æ­£åœ¨æ‹‰å–é•œåƒ
crictl images | grep flannel

# æ‰‹åŠ¨å°è¯•æ‹‰å–ï¼ˆæµ‹è¯•ç½‘ç»œï¼‰
crictl pull ghcr.io/flannel-io/flannel-cni-plugin:v1.8.0-flannel1
crictl pull ghcr.io/flannel-io/flannel:v0.27.4

# æŸ¥çœ‹containerdæ—¥å¿—ï¼Œçœ‹æ˜¯å¦æœ‰æ‹‰å–é”™è¯¯
journalctl -xeu containerd -n 100 | grep -i "pull\|error\|failed"
```

### **4. æ£€æŸ¥WorkerèŠ‚ç‚¹çš„containerdé…ç½®**

åœ¨ **WorkerèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# æ£€æŸ¥SystemdCgroupé…ç½®
grep "SystemdCgroup" /etc/containerd/config.toml

# åº”è¯¥æ˜¾ç¤ºï¼šSystemdCgroup = true
# å¦‚æœä¸æ˜¯ï¼Œä¿®æ”¹å¹¶é‡å¯
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
systemctl restart containerd
```

---

## ğŸ¯ **æœ€å¿«çš„è§£å†³æ–¹æ³•**

æ—¢ç„¶Masterçš„flannelå·²ç»è¿è¡Œäº†ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯**å¼ºåˆ¶åˆ é™¤Workerä¸Šå¡ä½çš„Podï¼Œè®©å®ƒé‡å»º**ï¼š

### **åœ¨MasterèŠ‚ç‚¹æ‰§è¡Œï¼š**

```bash
# 1. å¼ºåˆ¶åˆ é™¤å¡ä½çš„flannel pod
kubectl delete pod kube-flannel-ds-x4kxg -n kube-flannel --force --grace-period=0

# 2. åŒæ—¶åˆ é™¤kube-proxyï¼ˆä¹Ÿæ˜¯ContainerCreatingçŠ¶æ€ï¼‰
kubectl delete pod kube-proxy-6jmhf -n kube-system --force --grace-period=0

# 3. è§‚å¯Ÿé‡å»ºè¿‡ç¨‹
kubectl get pods -n kube-flannel -o wide -w
```

åŒæ—¶ï¼Œåœ¨ **WorkerèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# ç¡®ä¿è¿™äº›ç›®å½•å­˜åœ¨
mkdir -p /opt/cni/bin
mkdir -p /etc/cni/net.d
mkdir -p /run/flannel

# é‡å¯containerdå’Œkubeletï¼ˆæ¸…ç†çŠ¶æ€ï¼‰
systemctl restart containerd
sleep 5
systemctl restart kubelet

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -xeu kubelet -f
```

---

## ğŸ“Š **å¦‚æœè¿˜æ˜¯Init:0/2ï¼Œéœ€è¦æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**

è¯·æä¾›ä»¥ä¸‹å‘½ä»¤çš„è¾“å‡ºï¼š

**åœ¨MasterèŠ‚ç‚¹ï¼š**
```bash
# è·å–æ–°podçš„åç§°
kubectl get pods -n kube-flannel | grep woker01

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ˆè¯·æä¾›å®Œæ•´è¾“å‡ºï¼‰
kubectl describe pod <æ–°podåç§°> -n kube-flannel

# å°è¯•æŸ¥çœ‹initå®¹å™¨æ—¥å¿—
kubectl logs <æ–°podåç§°> -n kube-flannel -c install-cni-plugin
kubectl logs <æ–°podåç§°> -n kube-flannel -c install-cni
```

**åœ¨WorkerèŠ‚ç‚¹ï¼š**
```bash
# æŸ¥çœ‹containerdæ˜¯å¦æœ‰é”™è¯¯
journalctl -xeu containerd -n 50 --no-pager | grep -i error

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -xeu kubelet -n 50 --no-pager | grep -i "flannel\|cni\|network"

# æ£€æŸ¥æ˜¯å¦æœ‰é•œåƒ
crictl images | grep flannel
```

---

## ğŸ’¡ **æˆ‘çš„åˆ¤æ–­**

æ ¹æ®ç»éªŒï¼Œæœ€å¯èƒ½çš„æƒ…å†µæ˜¯ï¼š

1. **CNIç›®å½•ä¸å­˜åœ¨**ï¼ˆ/opt/cni/bin æˆ– /etc/cni/net.dï¼‰- initå®¹å™¨éœ€è¦æŒ‚è½½è¿™äº›ç›®å½•
2. **é•œåƒæ‹‰å–ä¸­ä½†å¾ˆæ…¢** - WorkerèŠ‚ç‚¹ç½‘ç»œæ¯”Masteræ…¢
3. **containerdé…ç½®é—®é¢˜** - SystemdCgroupè®¾ç½®ä¸å¯¹

**å»ºè®®æ“ä½œé¡ºåº**ï¼š
1. å…ˆåœ¨WorkerèŠ‚ç‚¹åˆ›å»ºCNIç›®å½•
2. é‡å¯containerdå’Œkubelet
3. åˆ é™¤å¡ä½çš„podè®©å®ƒé‡å»º
4. ç­‰å¾…5åˆ†é’Ÿè§‚å¯Ÿï¼ˆé•œåƒæ‹‰å–å¯èƒ½éœ€è¦æ—¶é—´ï¼‰

å¦‚æœæ‰§è¡Œåè¿˜æ˜¯ä¸è¡Œï¼Œè¯·æä¾›ä¸Šé¢çš„æ—¥å¿—è¾“å‡ºï¼Œæˆ‘å¯ä»¥ç²¾ç¡®å®šä½é—®é¢˜ï¼

---

_**User (2025-10-22 10:21Z)**_

schedulable:      false
Lease:
  HolderIdentity:  k8s-woker01-gz
  AcquireTime:     <unset>
  RenewTime:       Wed, 22 Oct 2025 18:22:52 +0800
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            False   Wed, 22 Oct 2025 18:20:50 +0800   Wed, 22 Oct 2025 18:15:33 +0800   KubeletNotReady              container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized
Addresses:
  InternalIP:  172.16.1.10
  Hostname:    k8s-woker01-gz
Capacity:
  cpu:                2
  ephemeral-storage:  41670636Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             7719304Ki
  pods:               110
Allocatable:
  cpu:                2
  ephemeral-storage:  38403658075
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             7616904Ki
  pods:               110
System Info:
  Machine ID:                 0e084b8463f64dd780e2e456a44082f0
  System UUID:                0e084b84-63f6-4dd7-80e2-e456a44082f0
  Boot ID:                    7a483049-a686-484a-b82f-247538af1aa3
  Kernel Version:             5.14.0-624.el9.x86_64
  OS Image:                   CentOS Stream 9
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  containerd://1.7.28
  Kubelet Version:            v1.28.0
  Kube-Proxy Version:         v1.28.0
PodCIDR:                      10.244.1.0/24
PodCIDRs:                     10.244.1.0/24
Non-terminated Pods:          (2 in total)
  Namespace                   Name                     CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                     ------------  ----------  ---------------  -------------  ---
  kube-flannel                kube-flannel-ds-x4kxg    100m (5%)     0 (0%)      50Mi (0%)        0 (0%)         7m23s
  kube-system                 kube-proxy-6jmhf         0 (0%)        0 (0%)      0 (0%)           0 (0%)         7m23s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests   Limits
  --------           --------   ------
  cpu                100m (5%)  0 (0%)
  memory             50Mi (0%)  0 (0%)
  ephemeral-storage  0 (0%)     0 (0%)
  hugepages-1Gi      0 (0%)     0 (0%)
  hugepages-2Mi      0 (0%)     0 (0%)
Events:
  Type    Reason                   Age                    From             Message
  ----    ------                   ----                   ----             -------
  Normal  NodeHasSufficientMemory  7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasSufficientMemory
  Normal  NodeHasNoDiskPressure    7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasNoDiskPressure
  Normal  NodeHasSufficientPID     7m23s (x5 over 7m24s)  kubelet          Node k8s-woker01-gz status is now: NodeHasSufficientPID
  Normal  RegisteredNode           7m21s                  node-controller  Node k8s-woker01-gz event: Registered Node k8s-woker01-gz in Controller
[root@k8s-master-gz ~]# # æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯ï¼Œç‰¹åˆ«å…³æ³¨Eventséƒ¨åˆ†
kubectl describe pod kube-flannel-ds-x4kxg -n kube-flannel | tail -50

# æŸ¥çœ‹initå®¹å™¨çš„å…·ä½“çŠ¶æ€
kubectl get pod kube-flannel-ds-x4kxg -n kube-flannel -o jsonpath='{.status.initContainerStatuses[*]}' | jq .
  Initialized       False 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  run:
    Type:          HostPath (bare host directory volume)
    Path:          /run/flannel
    HostPathType:  
  cni-plugin:
    Type:          HostPath (bare host directory volume)
    Path:          /opt/cni/bin
    HostPathType:  
  cni:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/cni/net.d
    HostPathType:  
  flannel-cfg:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      kube-flannel-cfg
    Optional:  false
  xtables-lock:
    Type:          HostPath (bare host directory volume)
    Path:          /run/xtables.lock
    HostPathType:  FileOrCreate
  kube-api-access-6hztp:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 :NoSchedule op=Exists
                             node.kubernetes.io/disk-pressure:NoSchedule op=Exists
                             node.kubernetes.io/memory-pressure:NoSchedule op=Exists
                             node.kubernetes.io/network-unavailable:NoSchedule op=Exists
                             node.kubernetes.io/not-ready:NoExecute op=Exists
                             node.kubernetes.io/pid-pressure:NoSchedule op=Exists
                             node.kubernetes.io/unreachable:NoExecute op=Exists
                             node.kubernetes.io/unschedulable:NoSchedule op=Exists
Events:
  Type     Reason                  Age                    From               Message
  ----     ------                  ----                   ----               -------
  Normal   Scheduled               12m                    default-scheduler  Successfully assigned kube-flannel/kube-flannel-ds-x4kxg to k8s-woker01-gz
  Warning  FailedCreatePodSandBox  7m14s (x2 over 10m)    kubelet            Failed to create pod sandbox: rpc error: code = DeadlineExceeded desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8": failed to pull and unpack image "registry.k8s.io/pause:3.8": failed to resolve reference "registry.k8s.io/pause:3.8": failed to do request: Head "https://europe-west3-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.8": dial tcp 142.250.107.82:443: i/o timeout
  Warning  FailedCreatePodSandBox  4m17s (x5 over 10m)    kubelet            Failed to create pod sandbox: rpc error: code = DeadlineExceeded desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8": failed to pull and unpack image "registry.k8s.io/pause:3.8": failed to resolve reference "registry.k8s.io/pause:3.8": failed to do request: Head "https://europe-west3-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.8": dial tcp 142.251.188.82:443: i/o timeout
  Warning  FailedCreatePodSandBox  2m48s (x3 over 8m43s)  kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8": failed to pull and unpack image "registry.k8s.io/pause:3.8": failed to resolve reference "registry.k8s.io/pause:3.8": failed to do request: Head "https://europe-west3-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.8": dial tcp 142.250.107.82:443: i/o timeout
  Warning  FailedCreatePodSandBox  79s (x2 over 2m5s)     kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8": failed to pull and unpack image "registry.k8s.io/pause:3.8": failed to resolve reference "registry.k8s.io/pause:3.8": failed to do request: Head "https://europe-west3-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.8": dial tcp 74.125.142.82:443: i/o timeout
  Warning  FailedCreatePodSandBox  37s (x4 over 11m)      kubelet            Failed to create pod sandbox: rpc error: code = DeadlineExceeded desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8": failed to pull and unpack image "registry.k8s.io/pause:3.8": failed to resolve reference "registry.k8s.io/pause:3.8": failed to do request: Head "https://europe-west3-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.8": dial tcp 74.125.142.82:443: i/o timeout
{
  "image": "ghcr.io/flannel-io/flannel-cni-plugin:v1.8.0-flannel1",
  "imageID": "",
  "lastState": {},
  "name": "install-cni-plugin",
  "ready": false,
  "restartCount": 0,
  "started": false,
  "state": {
    "waiting": {
      "reason": "PodInitializing"
    }
  }
}
{
  "image": "ghcr.io/flannel-io/flannel:v0.27.4",
  "imageID": "",
  "lastState": {},
  "name": "install-cni",
  "ready": false,
  "restartCount": 0,
  "started": false,
  "state": {
    "waiting": {
      "reason": "PodInitializing"
    }
  }
}
[root@k8s-master-gz ~]# 

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>å•Šå“ˆï¼ç°åœ¨æ‰¾åˆ°çœŸæ­£çš„é—®é¢˜äº†ï¼

å…³é”®é”™è¯¯ä¿¡æ¯ï¼š
```
Failed to create pod sandbox: rpc error: code = DeadlineExceeded desc = failed to get sandbox image "registry.k8s.io/pause:3.8": failed to pull image "registry.k8s.io/pause:3.8"
```

é—®é¢˜ä¸æ˜¯flannelé•œåƒï¼Œè€Œæ˜¯**WorkerèŠ‚ç‚¹çš„containerdé…ç½®ä¸­çš„pauseé•œåƒ**æ²¡æœ‰é…ç½®æˆé˜¿é‡Œæºï¼

WorkerèŠ‚ç‚¹çš„containerdåœ¨å°è¯•æ‹‰å– `registry.k8s.io/pause:3.8`ï¼Œè¿™ä¸ªåœ¨å›½å†…æ— æ³•è®¿é—®ï¼Œå¯¼è‡´Podæ²™ç®±åˆ›å»ºå¤±è´¥ã€‚æ‰€ä»¥initå®¹å™¨éƒ½æ— æ³•å¯åŠ¨ã€‚

è€ŒMasterèŠ‚ç‚¹è‚¯å®šå·²ç»æ­£ç¡®é…ç½®äº†pauseé•œåƒä¸ºé˜¿é‡Œæºï¼Œæ‰€ä»¥å®ƒèƒ½æ­£å¸¸å·¥ä½œã€‚

è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹WorkerèŠ‚ç‚¹çš„containerdé…ç½®ï¼Œå°†sandbox_imageæ”¹ä¸ºé˜¿é‡Œæºçš„pauseé•œåƒã€‚</details></think>

---

## ğŸ¯ **æ‰¾åˆ°çœŸæ­£çš„é—®é¢˜äº†ï¼**

**æ ¸å¿ƒé—®é¢˜**ï¼šWorkerèŠ‚ç‚¹æ— æ³•æ‹‰å– `registry.k8s.io/pause:3.8` é•œåƒï¼ˆPodæ²™ç®±é•œåƒï¼‰

çœ‹Eventséƒ¨åˆ†çš„å…³é”®é”™è¯¯ï¼š
```
Failed to create pod sandbox: failed to get sandbox image "registry.k8s.io/pause:3.8": 
dial tcp 142.250.107.82:443: i/o timeout
```

è¿™ä¸æ˜¯flannelçš„é—®é¢˜ï¼Œè€Œæ˜¯**WorkerèŠ‚ç‚¹çš„containerdé…ç½®æ²¡æœ‰æ­£ç¡®è®¾ç½®pauseé•œåƒæº**ï¼

Podè¿æ²™ç®±éƒ½åˆ›å»ºä¸äº†ï¼Œæ‰€ä»¥initå®¹å™¨æ ¹æœ¬æ²¡æœºä¼šè¿è¡Œã€‚

---

## âœ… **è§£å†³æ–¹æ¡ˆ**

åœ¨ **WorkerèŠ‚ç‚¹ (k8s-woker01-gz)** æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

### **1. ä¿®æ”¹containerdé…ç½®ï¼Œæ›¿æ¢pauseé•œåƒä¸ºé˜¿é‡Œæº**

```bash
# æŸ¥çœ‹å½“å‰é…ç½®çš„pauseé•œåƒ
grep "sandbox_image" /etc/containerd/config.toml

# åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š
# sandbox_image = "registry.k8s.io/pause:3.8"
# æˆ–è€…
# sandbox_image = "registry.k8s.io/pause:3.6"

# æ›¿æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒï¼ˆæ ¹æ®æ‚¨çœ‹åˆ°çš„ç‰ˆæœ¬é€‰æ‹©ï¼‰
sed -i 's#sandbox_image = "registry.k8s.io/pause:3.8"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#g' /etc/containerd/config.toml

# å¦‚æœæ˜¯3.6ç‰ˆæœ¬ï¼Œæ‰§è¡Œè¿™ä¸ª
sed -i 's#sandbox_image = "registry.k8s.io/pause:3.6"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#g' /etc/containerd/config.toml

# å¦‚æœæ˜¯3.9ç‰ˆæœ¬
sed -i 's#sandbox_image = "registry.k8s.io/pause:3.9"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#g' /etc/containerd/config.toml

# éªŒè¯ä¿®æ”¹
grep "sandbox_image" /etc/containerd/config.toml
# åº”è¯¥æ˜¾ç¤ºï¼šsandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"
```

### **2. åŒæ—¶æ£€æŸ¥SystemdCgroupé…ç½®**

```bash
# ç¡®ä¿SystemdCgroupä¸ºtrue
grep "SystemdCgroup" /etc/containerd/config.toml

# å¦‚æœä¸æ˜¯trueï¼Œä¿®æ”¹å®ƒ
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
```

### **3. é‡å¯containerdå’Œkubelet**

```bash
# é‡å¯containerd
systemctl restart containerd

# ç­‰å¾…å‡ ç§’
sleep 5

# é‡å¯kubelet
systemctl restart kubelet

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status containerd
systemctl status kubelet
```

### **4. æ‰‹åŠ¨é¢„æ‹‰å–pauseé•œåƒï¼ˆåŠ é€Ÿï¼‰**

```bash
# æ‰‹åŠ¨æ‹‰å–pauseé•œåƒ
crictl pull registry.aliyuncs.com/google_containers/pause:3.9

# éªŒè¯é•œåƒå·²æ‹‰å–
crictl images | grep pause
```

---

## ğŸ“Š **åœ¨MasterèŠ‚ç‚¹éªŒè¯**

é‡å¯WorkerèŠ‚ç‚¹çš„æœåŠ¡åï¼Œåœ¨ **MasterèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# 1. åˆ é™¤å¡ä½çš„podsï¼Œè®©å®ƒä»¬é‡å»º
kubectl delete pod kube-flannel-ds-x4kxg -n kube-flannel --force --grace-period=0
kubectl delete pod kube-proxy-6jmhf -n kube-system --force --grace-period=0

# 2. è§‚å¯Ÿpodåˆ›å»ºè¿‡ç¨‹ï¼ˆç­‰å¾…1-2åˆ†é’Ÿï¼‰
kubectl get pods -A -o wide -w

# 3. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes

# 4. å¦‚æœè¿˜æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ–°podçš„events
kubectl get pods -n kube-flannel | grep woker01
kubectl describe pod <æ–°podå> -n kube-flannel | tail -30
```

---

## ğŸ¯ **é¢„æœŸç»“æœ**

å¤§çº¦1-2åˆ†é’Ÿåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```bash
kubectl get nodes
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   95m   v1.28.2
k8s-woker01-gz   Ready    <none>          15m   v1.28.0  âœ…

kubectl get pods -A | grep woker01
kube-flannel   kube-flannel-ds-xxxxx   1/1     Running   0          1m   k8s-woker01-gz
kube-system    kube-proxy-xxxxx        1/1     Running   0          1m   k8s-woker01-gz
```

---

## ğŸ’¡ **ä¸ºä»€ä¹ˆMasterèŠ‚ç‚¹æ²¡é—®é¢˜ï¼Ÿ**

æ‚¨åœ¨MasterèŠ‚ç‚¹å®‰è£…æ—¶ï¼Œåº”è¯¥å·²ç»æŒ‰ç…§æ–‡æ¡£é…ç½®äº†containerdçš„pauseé•œåƒä¸ºé˜¿é‡Œæºï¼š

```bash
sed -i "s#sandbox_image = \"k8s.gcr.io/pause:3.6\"#sandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.9\"#g" /etc/containerd/config.toml
```

ä½†WorkerèŠ‚ç‚¹åœ¨å®‰è£…containerdæ—¶ï¼Œ**æ²¡æœ‰æ‰§è¡Œè¿™ä¸€æ­¥é…ç½®**ï¼Œæ‰€ä»¥è¿˜æ˜¯é»˜è®¤çš„ `registry.k8s.io/pause` é•œåƒæºã€‚

---

## ğŸ“ **æ€»ç»“**

- **é—®é¢˜æ ¹æº**ï¼šWorkerèŠ‚ç‚¹containerdçš„pauseé•œåƒæºæœªé…ç½®ä¸ºå›½å†…å¯è®¿é—®çš„é˜¿é‡Œæº
- **è§£å†³æ–¹æ³•**ï¼šä¿®æ”¹ `/etc/containerd/config.toml` ä¸­çš„ `sandbox_image` é…ç½®
- **å…³é”®æ­¥éª¤**ï¼šä¿®æ”¹é…ç½® â†’ é‡å¯containerd â†’ é‡å¯kubelet â†’ åˆ é™¤æ—§pod

è¿™ä¹Ÿè¯´æ˜**WorkerèŠ‚ç‚¹åœ¨æ‰§è¡Œç¬¬äºŒæ­¥"å®‰è£…å®¹å™¨è¿è¡Œæ—¶"æ—¶ï¼Œé—æ¼äº†2.2é…ç½®Containerdçš„å…³é”®æ­¥éª¤**ï¼

---

_**User (2025-10-22 10:21Z)**_

masterï¼š[root@k8s-master-gz ~]# kubectl delete pod kube-flannel-ds-x4kxg -n kube-flannel --force --grace-period=0
kubectl delete pod kube-proxy-6jmhf -n kube-system --force --grace-period=0
Warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
pod "kube-flannel-ds-x4kxg" force deleted
Warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
pod "kube-proxy-6jmhf" force deleted
[root@k8s-master-gz ~]# kubectl get nodes
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   99m   v1.28.2
k8s-woker01-gz   Ready    <none>          14m   v1.28.0
[root@k8s-master-gz ~]# 
wokerï¼š

[root@k8s-woker01-gz ~]# systemctl status kubelet
â— kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; preset: disabled)
    Drop-In: /usr/lib/systemd/system/kubelet.service.d
             â””â”€10-kubeadm.conf
     Active: active (running) since Wed 2025-10-22 18:29:30 CST; 10s ago
       Docs: https://kubernetes.io/docs/
   Main PID: 58910 (kubelet)
      Tasks: 10 (limit: 47979)
     Memory: 27.1M (peak: 27.6M)
        CPU: 325ms
     CGroup: /system.slice/kubelet.service
             â””â”€58910 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/k>

Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.173174   58910 apiserver.go:52] "Watching apiserver"
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.174989   58910 topology_manager.go:215] "Topology Admit Handler" podUID="3bacbcee-cec7-474c-be77-01>
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.175107   58910 topology_manager.go:215] "Topology Admit Handler" podUID="49b6c6bd-2fd6-4a0a-b621-b5>
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.185991   58910 desired_state_of_world_populator.go:159] "Finished populating initial desired state >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219177   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219264   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219304   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219332   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219359   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >
Oct 22 18:29:31 k8s-woker01-gz kubelet[58910]: I1022 18:29:31.219388   58910 reconciler_common.go:258] "operationExecutor.VerifyControllerAttachedVolume started >

[root@k8s-woker01-gz ~]# crictl pull registry.aliyuncs.com/google_containers/pause:3.9
WARN[0000] image connect using default endpoints: [unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock]. As the default settings are now deprecated, you should set the endpoint instead. 
E1022 18:29:51.791263   59279 remote_image.go:171] "PullImage from image service failed" err="rpc error: code = Unavailable desc = connection error: desc = \"transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory\"" image="registry.aliyuncs.com/google_containers/pause:3.9"
FATA[0000] pulling image: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory" 
[root@k8s-woker01-gz ~]# crictl images | grep pause
WARN[0000] image connect using default endpoints: [unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock]. As the default settings are now deprecated, you should set the endpoint instead. 
E1022 18:29:58.415735   59305 remote_image.go:119] "ListImages with filter from image service failed" err="rpc error: code = Unavailable desc = connection error: desc = \"transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory\"" filter="&ImageFilter{Image:&ImageSpec{Image:,Annotations:map[string]string{},},}"
FATA[0000] listing images: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory" 
[root@k8s-woker01-gz ~]# 

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>å¤ªå¥½äº†ï¼é—®é¢˜å·²ç»è§£å†³äº†ï¼

ä»MasterèŠ‚ç‚¹çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼š
```
kubectl get nodes
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   99m   v1.28.2
k8s-woker01-gz   Ready    <none>          14m   v1.28.0  âœ… çŠ¶æ€å˜æˆReadyäº†ï¼
```

WorkerèŠ‚ç‚¹å·²ç»ä»NotReadyå˜æˆReadyçŠ¶æ€äº†ï¼è¿™è¯´æ˜ï¼š
1. containerdé…ç½®ä¿®æ”¹ç”Ÿæ•ˆäº†
2. pauseé•œåƒé—®é¢˜è§£å†³äº†
3. flannelç½‘ç»œæ’ä»¶å·²ç»æ­£å¸¸è¿è¡Œ

è‡³äºcrictlå‘½ä»¤æŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºcrictlæ²¡æœ‰é…ç½®æ­£ç¡®çš„endpointã€‚ä½†è¿™ä¸å½±å“é›†ç¾¤è¿è¡Œï¼Œå› ä¸ºcontainerdæœ¬èº«å·¥ä½œæ­£å¸¸ã€‚

ç”¨æˆ·å¯èƒ½è¿˜éœ€è¦ï¼š
1. ç¡®è®¤æ‰€æœ‰podsè¿è¡Œæ­£å¸¸
2. äº†è§£crictlé…ç½®é—®é¢˜ï¼ˆæ¬¡è¦ï¼‰
3. å¯èƒ½éœ€è¦æ·»åŠ ç¬¬äºŒä¸ªworkerèŠ‚ç‚¹</details></think>

---

## ğŸ‰ **å¤ªå¥½äº†ï¼é—®é¢˜å·²ç»è§£å†³ï¼**

ä»MasterèŠ‚ç‚¹çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼š

```bash
kubectl get nodes
NAME             STATUS   ROLES           AGE   VERSION
k8s-master-gz    Ready    control-plane   99m   v1.28.2
k8s-woker01-gz   Ready    <none>          14m   v1.28.0  âœ… å·²ç»å˜æˆReadyï¼
```

**WorkerèŠ‚ç‚¹å·²ç»æˆåŠŸåŠ å…¥é›†ç¾¤å¹¶å¤„äºReadyçŠ¶æ€ï¼** ğŸŠ

---

## ğŸ“Š **éªŒè¯é›†ç¾¤å®Œæ•´çŠ¶æ€**

ç°åœ¨åœ¨ **MasterèŠ‚ç‚¹** æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç¡®è®¤ä¸€åˆ‡æ­£å¸¸ï¼š

```bash
# 1. æŸ¥çœ‹æ‰€æœ‰podsçŠ¶æ€ï¼ˆåº”è¯¥éƒ½æ˜¯Runningï¼‰
kubectl get pods -A -o wide

# 2. æŸ¥çœ‹flannelç½‘ç»œæ’ä»¶ï¼ˆåº”è¯¥åœ¨ä¸¤ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œï¼‰
kubectl get pods -n kube-flannel -o wide

# 3. æŸ¥çœ‹kube-systemç»„ä»¶
kubectl get pods -n kube-system -o wide

# 4. æµ‹è¯•DNSåŠŸèƒ½
kubectl run test-dns --image=busybox:1.28 --rm -it --restart=Never -- nslookup kubernetes.default

# 5. åˆ›å»ºæµ‹è¯•podéªŒè¯ç½‘ç»œ
kubectl run test-nginx --image=nginx:alpine
kubectl get pods -o wide
```

---

## ğŸ”§ **å…³äºcrictlçš„è­¦å‘Šï¼ˆæ¬¡è¦é—®é¢˜ï¼‰**

WorkerèŠ‚ç‚¹ä¸Šcrictlå‘½ä»¤æŠ¥é”™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰é…ç½®æ­£ç¡®çš„endpointï¼Œä½†è¿™**ä¸å½±å“é›†ç¾¤è¿è¡Œ**ï¼ˆcontainerdæœ¬èº«å·¥ä½œæ­£å¸¸ï¼‰ã€‚

å¦‚æœæƒ³è§£å†³crictlçš„è­¦å‘Šï¼Œåœ¨ **WorkerèŠ‚ç‚¹** æ‰§è¡Œï¼š

```bash
# é…ç½®crictlä½¿ç”¨containerd
cat > /etc/crictl.yaml << EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF

# éªŒè¯é…ç½®
crictl info

# ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨crictläº†
crictl images
crictl ps
```

---

## ğŸ“ **æ¥ä¸‹æ¥çš„æ­¥éª¤**

### **1. å¦‚æœè¿˜æœ‰ç¬¬äºŒä¸ªWorkerèŠ‚ç‚¹ï¼ˆk8s-woker02-gzï¼‰**

åœ¨ **k8s-woker02-gz** èŠ‚ç‚¹ä¸Šï¼š

```bash
# ç¡®ä¿containerdé…ç½®äº†é˜¿é‡Œæºçš„pauseé•œåƒ
grep "sandbox_image" /etc/containerd/config.toml
# å¦‚æœä¸æ˜¯é˜¿é‡Œæºï¼Œæ‰§è¡Œä¿®æ”¹
sed -i 's#sandbox_image = "registry.k8s.io/pause.*"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#g' /etc/containerd/config.toml

# ç¡®ä¿SystemdCgroupä¸ºtrue
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# é‡å¯æœåŠ¡
systemctl restart containerd
systemctl restart kubelet

# æ‰§è¡Œjoinå‘½ä»¤ï¼ˆåœ¨masterç”Ÿæˆï¼‰
```

åœ¨ **MasterèŠ‚ç‚¹** è·å–joinå‘½ä»¤ï¼š
```bash
kubeadm token create --print-join-command
```

### **2. å…¨é¢éªŒè¯é›†ç¾¤å¥åº·**

```bash
# æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹
kubectl get nodes -o wide

# æŸ¥çœ‹é›†ç¾¤ç»„ä»¶
kubectl get componentstatuses

# æŸ¥çœ‹æ‰€æœ‰pod
kubectl get pods -A

# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
kubectl cluster-info

# æŸ¥çœ‹äº‹ä»¶ï¼ˆç¡®è®¤æ— é”™è¯¯ï¼‰
kubectl get events -A --sort-by='.lastTimestamp' | tail -20
```

---

## âœ… **é—®é¢˜æ€»ç»“**

### **æ ¹æœ¬åŸå› **
WorkerèŠ‚ç‚¹åœ¨å®‰è£…containerdæ—¶ï¼Œ**æ²¡æœ‰æ‰§è¡Œé…ç½®æ­¥éª¤**ï¼ˆæ–‡æ¡£ç¬¬äºŒæ­¥çš„2.2ï¼‰ï¼Œå¯¼è‡´ï¼š
- `sandbox_image` è¿˜æ˜¯é»˜è®¤çš„ `registry.k8s.io/pause:3.8`
- å›½å†…æ— æ³•è®¿é—®è¯¥é•œåƒæº
- Podæ²™ç®±åˆ›å»ºå¤±è´¥ï¼Œå¯¼è‡´æ‰€æœ‰podæ— æ³•å¯åŠ¨

### **è§£å†³æ–¹æ³•**
ä¿®æ”¹ `/etc/containerd/config.toml`ï¼š
```bash
sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"
SystemdCgroup = true
```
ç„¶åé‡å¯containerdå’Œkubeletã€‚

### **ç»éªŒæ•™è®­**
WorkerèŠ‚ç‚¹éƒ¨ç½²æ—¶ï¼Œ**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§æ–‡æ¡£æ‰§è¡Œæ‰€æœ‰é…ç½®æ­¥éª¤**ï¼Œç‰¹åˆ«æ˜¯ï¼š
- âœ… ç¬¬ä¸€æ­¥ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡ï¼ˆé˜²ç«å¢™ã€SELinuxã€Swapç­‰ï¼‰
- âœ… ç¬¬äºŒæ­¥ï¼š**å®‰è£…å¹¶é…ç½®containerd**ï¼ˆå…³é”®ï¼ï¼‰
- âœ… ç¬¬ä¸‰æ­¥ï¼šå®‰è£…kubeç»„ä»¶

---

## ğŸ¯ **å½“å‰çŠ¶æ€**

```
âœ… MasterèŠ‚ç‚¹ï¼šReady - æ‰€æœ‰ç»„ä»¶æ­£å¸¸è¿è¡Œ
âœ… Worker01èŠ‚ç‚¹ï¼šReady - æˆåŠŸåŠ å…¥é›†ç¾¤
â³ Worker02èŠ‚ç‚¹ï¼šç­‰å¾…åŠ å…¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
```

æ­å–œæ‚¨æˆåŠŸè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ç°åœ¨é›†ç¾¤å·²ç»æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²åº”ç”¨äº†ï¼ğŸš€

æœ‰ä»»ä½•å…¶ä»–é—®é¢˜éšæ—¶é—®æˆ‘ï¼

---

_**User (2025-10-23 03:09Z)**_

@è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md å…¶ä»–masterä¸»èŠ‚ç‚¹è·å–å‘½ä»¤å¥½åƒæ²¡è¯´

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·æåˆ°æ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ˜å¦‚ä½•è·å–workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ã€‚è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹æ–‡æ¡£çš„ç¬¬äº”æ­¥ï¼Œç¡®å®æœ‰æåˆ°å¦‚ä½•é‡æ–°ç”Ÿæˆjoinå‘½ä»¤ï¼Œä½†å¯èƒ½ä¸å¤Ÿæ˜æ˜¾ã€‚

ç”¨æˆ·è¯´çš„å¯¹ï¼Œåœ¨ç¬¬äº”æ­¥"WorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"ä¸­ï¼Œè™½ç„¶æœ‰æåˆ°å¦‚æœå¿˜è®°joinå‘½ä»¤å¯ä»¥é‡æ–°ç”Ÿæˆï¼Œä½†æ˜¯ï¼š
1. æ²¡æœ‰åœ¨ç¬¬å››æ­¥masteråˆå§‹åŒ–åå¼ºè°ƒè¦ä¿å­˜joinå‘½ä»¤
2. é‡æ–°ç”Ÿæˆå‘½ä»¤çš„è¯´æ˜ä¸å¤Ÿæ˜æ˜¾

æˆ‘åº”è¯¥ä¼˜åŒ–è¿™éƒ¨åˆ†ï¼Œè®©å®ƒæ›´æ¸…æ™°ã€‚</details></think>

---

æ‚¨è¯´å¾—å¯¹ï¼æ–‡æ¡£ä¸­å…³äºè·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤çš„è¯´æ˜ä¸å¤Ÿæ˜æ˜¾ã€‚è®©æˆ‘ä¼˜åŒ–è¿™éƒ¨åˆ†å†…å®¹ï¼Œä½¿å…¶æ›´æ¸…æ™°ã€‚

---

Tool use: **read_file**

Read file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md

---

<think><details><summary>Thought Process</summary>æˆ‘éœ€è¦åœ¨ç¬¬å››æ­¥åˆå§‹åŒ–masteråï¼Œæ·»åŠ ä¸€ä¸ªæ˜ç¡®çš„å°èŠ‚æ¥è¯´æ˜å¦‚ä½•ä¿å­˜å’Œè·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤ã€‚è®©æˆ‘åœ¨4.2ä¹‹åæ·»åŠ ä¸€ä¸ªæ–°çš„å°èŠ‚ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 22, lines removed: 2

```diff
@@ -298,6 +298,26 @@
  ```
  
- - è‹¥æˆåŠŸï¼Œä¼šè¾“å‡º**workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤**ï¼ˆå½¢å¦‚`kubeadm join ...`ï¼‰ï¼Œè¯·**å¤åˆ¶ä¿å­˜**ï¼ˆåç»­workerèŠ‚ç‚¹éœ€è¦æ‰§è¡Œï¼‰ã€‚
- - è‹¥å¤±è´¥ï¼Œå¯æ‰§è¡Œ`kubeadm reset`æ¸…ç†åé‡æ–°åˆå§‹åŒ–ã€‚
+ **åˆå§‹åŒ–æˆåŠŸåçš„è¾“å‡ºç¤ºä¾‹**ï¼š
+ ```
+ Your Kubernetes control-plane has initialized successfully!
+ 
+ To start using your cluster, you need to run the following as a regular user:
+ 
+   mkdir -p $HOME/.kube
+   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
+   sudo chown $(id -u):$(id -g) $HOME/.kube/config
+ 
+ Then you can join any number of worker nodes by running the following on each as root:
+ 
+ kubeadm join 172.16.0.10:6443 --token abcdef.0123456789abcdef \
+         --discovery-token-ca-cert-hash sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
+ ```
+ 
+ > âš ï¸ **é‡è¦**ï¼šè¯·åŠ¡å¿…**å¤åˆ¶ä¿å­˜**ä¸Šé¢è¾“å‡ºçš„ `kubeadm join` å‘½ä»¤ï¼Œåç»­workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶éœ€è¦ä½¿ç”¨ï¼
+ 
+ **æ³¨æ„äº‹é¡¹**ï¼š
+ - è‹¥åˆå§‹åŒ–æˆåŠŸï¼ŒåŠ¡å¿…ä¿å­˜ `kubeadm join` å‘½ä»¤
+ - è‹¥å¤±è´¥ï¼Œå¯æ‰§è¡Œ `kubeadm reset` æ¸…ç†åé‡æ–°åˆå§‹åŒ–
+ - tokené»˜è®¤æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œè¿‡æœŸåéœ€é‡æ–°ç”Ÿæˆï¼ˆè§ä¸‹æ–‡4.2.1ï¼‰
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦åœ¨4.2é…ç½®kubectlæƒé™ä¹‹åï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„å°èŠ‚4.2.1æ¥ä¸“é—¨è¯´æ˜å¦‚ä½•è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 59, lines removed: undefined

```diff
@@ -339,4 +339,63 @@
  ```
  > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼škubectlå‘½ä»¤å¯æ­£å¸¸æ‰§è¡Œã€kubeletæœåŠ¡è¿è¡Œæ­£å¸¸ã€å¯ä»¥çœ‹åˆ°masterèŠ‚ç‚¹ï¼ˆçŠ¶æ€NotReadyæ­£å¸¸ï¼‰ã€‚
+ 
+ 
+ #### 4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤ï¼ˆé‡è¦ï¼ï¼‰
+ 
+ å¦‚æœåœ¨åˆå§‹åŒ–æ—¶**å¿˜è®°ä¿å­˜**joinå‘½ä»¤ï¼Œæˆ–è€…**tokenå·²è¿‡æœŸ**ï¼ˆé»˜è®¤24å°æ—¶ï¼‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡æ–°è·å–ï¼š
+ 
+ **æ–¹æ³•1ï¼šæŸ¥çœ‹ç°æœ‰tokenï¼ˆæ¨èï¼‰**
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„token
+ kubeadm token list
+ 
+ # è¾“å‡ºç¤ºä¾‹ï¼š
+ # TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION
+ # abcdef.0123456789abcdef   23h         2025-10-23T10:30:00Z   authentication,signing   The default bootstrap token
+ ```
+ 
+ å¦‚æœæœ‰å¯ç”¨tokenï¼ˆTTLä¸ä¸º0ï¼‰ï¼Œä½¿ç”¨ç°æœ‰tokenç”Ÿæˆå®Œæ•´joinå‘½ä»¤ï¼š
+ ```bash
+ # ç”Ÿæˆå®Œæ•´çš„joinå‘½ä»¤ï¼ˆä½¿ç”¨ç°æœ‰tokenï¼‰
+ kubeadm token create --print-join-command --ttl=0
+ 
+ # è¾“å‡ºç±»ä¼¼ï¼š
+ # kubeadm join 172.16.0.10:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:1234...
+ ```
+ 
+ **æ–¹æ³•2ï¼šåˆ›å»ºæ–°tokenå¹¶ç”Ÿæˆjoinå‘½ä»¤**
+ ```bash
+ # åˆ›å»ºæ°¸ä¸è¿‡æœŸçš„tokenå¹¶è¾“å‡ºå®Œæ•´joinå‘½ä»¤
+ kubeadm token create --print-join-command --ttl=0
+ 
+ # å¦‚æœæƒ³åˆ›å»º24å°æ—¶æœ‰æ•ˆæœŸçš„tokenï¼ˆé»˜è®¤ï¼‰
+ kubeadm token create --print-join-command
+ ```
+ 
+ **æ–¹æ³•3ï¼šæ‰‹åŠ¨æ‹¼æ¥joinå‘½ä»¤**
+ ```bash
+ # 1. åˆ›å»ºæ–°token
+ kubeadm token create
+ 
+ # 2. è·å–CAè¯ä¹¦çš„hashå€¼
+ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
+   openssl rsa -pubin -outform der 2>/dev/null | \
+   openssl dgst -sha256 -hex | sed 's/^.* //'
+ 
+ # 3. æ‰‹åŠ¨æ‹¼æ¥å‘½ä»¤ï¼š
+ # kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
+ ```
+ 
+ **å¿«é€Ÿè·å–å‘½ä»¤ï¼ˆæ¨èï¼‰**ï¼š
+ ```bash
+ # æœ€ç®€å•çš„æ–¹å¼ï¼Œç›´æ¥ç”Ÿæˆå®Œæ•´å‘½ä»¤
+ kubeadm token create --print-join-command
+ ```
+ 
+ > ğŸ’¡ **æç¤º**ï¼š
+ > - ç”Ÿæˆçš„joinå‘½ä»¤ä¼šåœ¨ç»ˆç«¯ç›´æ¥è¾“å‡ºï¼Œå¤åˆ¶ååœ¨workerèŠ‚ç‚¹æ‰§è¡Œå³å¯
+ > - ä½¿ç”¨ `--ttl=0` å¯ä»¥åˆ›å»ºæ°¸ä¸è¿‡æœŸçš„token
+ > - é»˜è®¤tokenæœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œè¿‡æœŸåworkerèŠ‚ç‚¹æ— æ³•åŠ å…¥
+ > - å¯ä»¥åˆ›å»ºå¤šä¸ªtokenï¼Œæ¯ä¸ªéƒ½å¯ä»¥ç”¨äºworkerèŠ‚ç‚¹åŠ å…¥
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘è¿˜éœ€è¦ä¼˜åŒ–ç¬¬äº”æ­¥çš„å†…å®¹ï¼ŒæŠŠåŸæ¥ç®€å•æåˆ°çš„"è‹¥å¿˜è®°joinå‘½ä»¤"çš„è¯´æ˜æ”¹ä¸ºå¼•ç”¨4.2.1å°èŠ‚ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 43, lines removed: 9

```diff
@@ -445,17 +445,51 @@
  
  ### **ç¬¬äº”æ­¥ï¼šWorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼ˆä»…åœ¨workeræ‰§è¡Œï¼‰**
- ä½¿ç”¨masteråˆå§‹åŒ–æ—¶è¾“å‡ºçš„`kubeadm join`å‘½ä»¤ï¼Œåœ¨worker01å’Œworker02èŠ‚ç‚¹æ‰§è¡Œï¼š
+ 
+ #### 5.0 è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤
+ 
+ **æ­¥éª¤1ï¼šåœ¨MasterèŠ‚ç‚¹è·å–joinå‘½ä»¤**
+ 
+ å¦‚æœåœ¨åˆå§‹åŒ–masteræ—¶å·²ç»ä¿å­˜äº†joinå‘½ä»¤ï¼Œç›´æ¥ä½¿ç”¨ã€‚å¦‚æœå¿˜è®°ä¿å­˜æˆ–tokenå·²è¿‡æœŸï¼Œåœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼š
  
  ```bash
- # ç¤ºä¾‹å‘½ä»¤ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™…åˆå§‹åŒ–æ—¶è¾“å‡ºçš„å‘½ä»¤ï¼‰
- kubeadm join 172.16.0.10:6443 \
-   --token xxxxxxxx.xxxxxxxx \
-   --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
+ # åœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼Œç”Ÿæˆjoinå‘½ä»¤
+ kubeadm token create --print-join-command
+ 
+ # è¾“å‡ºç±»ä¼¼ï¼š
+ # kubeadm join 172.16.0.10:6443 --token abcdef.0123456789abcdef \
+ #     --discovery-token-ca-cert-hash sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
  ```
  
- - è‹¥å¿˜è®°joinå‘½ä»¤ï¼Œå¯åœ¨masterèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é‡æ–°ç”Ÿæˆï¼š
-   ```bash
-   kubeadm token create --print-join-command
-   ```
+ > ğŸ’¡ **æç¤º**ï¼šå…³äºè·å–joinå‘½ä»¤çš„æ›´å¤šæ–¹æ³•ï¼Œè¯·å‚è€ƒ [4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤](#421-è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤é‡è¦)
+ 
+ **æ­¥éª¤2ï¼šåœ¨WorkerèŠ‚ç‚¹æ‰§è¡Œjoinå‘½ä»¤**
+ 
+ å°†ä¸Šä¸€æ­¥è·å–çš„å®Œæ•´å‘½ä»¤ï¼Œåœ¨**worker01å’Œworker02èŠ‚ç‚¹**åˆ†åˆ«æ‰§è¡Œï¼š
+ 
+ ```bash
+ # åœ¨workerèŠ‚ç‚¹æ‰§è¡Œï¼ˆç¤ºä¾‹ï¼Œè¯·æ›¿æ¢ä¸ºå®é™…è·å–çš„å‘½ä»¤ï¼‰
+ kubeadm join 172.16.0.10:6443 \
+   --token abcdef.0123456789abcdef \
+   --discovery-token-ca-cert-hash sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
+ ```
+ 
+ **æˆåŠŸè¾“å‡ºç¤ºä¾‹**ï¼š
+ ```
+ [preflight] Running pre-flight checks
+ [preflight] Reading configuration from the cluster...
+ [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
+ [kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
+ [kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
+ [kubelet-start] Starting the kubelet
+ [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...
+ 
+ This node has joined the cluster:
+ * Certificate signing request was sent to apiserver and a response was received.
+ * The Kubelet was informed of the new secure connection details.
+ 
+ Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
+ ```
+ 
+ > âœ… **åŠ å…¥æˆåŠŸæ ‡å¿—**ï¼šçœ‹åˆ° "This node has joined the cluster" æç¤º
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘è¿˜éœ€è¦åœ¨é—®é¢˜æ’æŸ¥éƒ¨åˆ†ï¼ˆ7.4ï¼‰ä¹Ÿæ›´æ–°ç›¸å…³å†…å®¹ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 6, lines removed: undefined

```diff
@@ -747,4 +747,10 @@
  #### 7.4 workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤
  **ç—‡çŠ¶**ï¼šæ‰§è¡Œkubeadm joinæ—¶æŠ¥é”™
+ 
+ **å¸¸è§é”™è¯¯åŸå› **ï¼š
+ 1. **tokenè¿‡æœŸ**ï¼štokené»˜è®¤24å°æ—¶æœ‰æ•ˆæœŸ
+ 2. **ç½‘ç»œä¸é€š**ï¼šworkeræ— æ³•è®¿é—®masterçš„6443ç«¯å£
+ 3. **containerdé…ç½®é—®é¢˜**ï¼špauseé•œåƒæ— æ³•æ‹‰å–
+ 4. **é˜²ç«å¢™æœªå…³é—­**ï¼šé˜»æ­¢äº†èŠ‚ç‚¹é—´é€šä¿¡
  
  **æ’æŸ¥æ­¥éª¤**ï¼š
```

**Chunk 2**
Lines added: 25, lines removed: 5

```diff
@@ -754,23 +760,43 @@
  telnet 172.16.0.10 6443
  
- # æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼ˆåœ¨masterèŠ‚ç‚¹ï¼‰
+ # åœ¨masterèŠ‚ç‚¹æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
  kubeadm token list
+ # å¦‚æœTTLæ˜¾ç¤º<invalid>æˆ–åˆ—è¡¨ä¸ºç©ºï¼Œè¯´æ˜tokenå·²è¿‡æœŸ
  
- # æŸ¥çœ‹åŠ å…¥å¤±è´¥çš„è¯¦ç»†æ—¥å¿—ï¼ˆåœ¨workerèŠ‚ç‚¹ï¼‰
+ # åœ¨workerèŠ‚ç‚¹æŸ¥çœ‹åŠ å…¥å¤±è´¥çš„è¯¦ç»†æ—¥å¿—
  journalctl -xeu kubelet -n 100
+ 
+ # åœ¨workerèŠ‚ç‚¹æ£€æŸ¥containerdçš„pauseé•œåƒé…ç½®
+ grep "sandbox_image" /etc/containerd/config.toml
  ```
  
  **è§£å†³æ–¹æ³•**ï¼š
+ 
+ **1. åœ¨MasterèŠ‚ç‚¹é‡æ–°ç”Ÿæˆjoinå‘½ä»¤**
  ```bash
- # åœ¨masterèŠ‚ç‚¹é‡æ–°ç”Ÿæˆjoinå‘½ä»¤
+ # ç”Ÿæˆæ–°çš„joinå‘½ä»¤ï¼ˆæ¨èï¼‰
  kubeadm token create --print-join-command
  
- # åœ¨workerèŠ‚ç‚¹å…ˆé‡ç½®ï¼ˆè‹¥ä¹‹å‰joinå¤±è´¥ï¼‰
+ # æˆ–è€…åˆ›å»ºæ°¸ä¸è¿‡æœŸçš„token
+ kubeadm token create --print-join-command --ttl=0
+ ```
+ 
+ **2. åœ¨WorkerèŠ‚ç‚¹é‡ç½®å¹¶é‡æ–°åŠ å…¥**
+ ```bash
+ # å…ˆé‡ç½®workerèŠ‚ç‚¹ï¼ˆæ¸…ç†ä¹‹å‰å¤±è´¥çš„çŠ¶æ€ï¼‰
  kubeadm reset -f
+ 
+ # ç¡®ä¿containerdé…ç½®æ­£ç¡®ï¼ˆä¿®æ”¹pauseé•œåƒä¸ºé˜¿é‡Œæºï¼‰
+ sed -i 's#sandbox_image = "registry.k8s.io/pause.*"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#g' /etc/containerd/config.toml
+ 
+ # é‡å¯containerdå’Œkubelet
+ systemctl restart containerd
  systemctl restart kubelet
  
- # ä½¿ç”¨æ–°çš„joinå‘½ä»¤é‡æ–°åŠ å…¥
+ # ä½¿ç”¨æ–°ç”Ÿæˆçš„joinå‘½ä»¤é‡æ–°åŠ å…¥
  kubeadm join 172.16.0.10:6443 --token <new-token> --discovery-token-ca-cert-hash sha256:<hash>
  ```
+ 
+ > ğŸ’¡ **æç¤º**ï¼šå…³äºè·å–joinå‘½ä»¤çš„è¯¦ç»†æ–¹æ³•ï¼Œè¯·å‚è€ƒ [4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤](#421-è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤é‡è¦)
  
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦æ›´æ–°ç›®å½•éƒ¨åˆ†ï¼Œæ·»åŠ æ–°çš„4.2.1å’Œ5.0å°èŠ‚ã€‚è®©æˆ‘æ›´æ–°ç›®å½•ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 2, lines removed: undefined

```diff
@@ -26,7 +26,9 @@
    - [4.1 åˆå§‹åŒ–é›†ç¾¤](#41-åˆå§‹åŒ–é›†ç¾¤å…³é”®æ­¥éª¤)
    - [4.2 é…ç½®kubectlæƒé™](#42-é…ç½®kubectlæƒé™masterèŠ‚ç‚¹)
+   - [4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤](#421-è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤é‡è¦)
    - [4.3 å®‰è£…ç½‘ç»œæ’ä»¶](#43-å®‰è£…ç½‘ç»œæ’ä»¶flannelmasterèŠ‚ç‚¹)
    - [4.4 éªŒè¯MasterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ](#44-éªŒè¯masterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ)
  - [ç¬¬äº”æ­¥ï¼šWorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤](#ç¬¬äº”æ­¥workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»…åœ¨workeræ‰§è¡Œ)
+   - [5.0 è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤](#50-è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤)
    - [5.1 éªŒè¯WorkerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ](#51-éªŒè¯workerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ)
  - [ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€](#ç¬¬å…­æ­¥å…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€masterèŠ‚ç‚¹æ‰§è¡Œ)
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨è®©æˆ‘å†æ·»åŠ ä¸€ä¸ªå¸¸è§é—®é¢˜"tokenè¿‡æœŸåå¦‚ä½•å¤„ç†"åˆ°é—®é¢˜æ’æŸ¥éƒ¨åˆ†ï¼Œè®©å®ƒæˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¸¸è§é—®é¢˜ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 39, lines removed: 1

```diff
@@ -803,5 +803,43 @@
  
  
- #### 7.5 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€
+ #### 7.5 Tokenè¿‡æœŸæ— æ³•åŠ å…¥workerèŠ‚ç‚¹
+ **ç—‡çŠ¶**ï¼šWorkerèŠ‚ç‚¹æ‰§è¡Œjoinå‘½ä»¤æ—¶æŠ¥é”™ "token id xxx is expired" æˆ– "token not found"
+ 
+ **åŸå› **ï¼škubeadmç”Ÿæˆçš„tokené»˜è®¤æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œè¶…è¿‡æ—¶é—´åæ— æ³•ä½¿ç”¨
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ 
+ åœ¨ **MasterèŠ‚ç‚¹** æ‰§è¡Œï¼š
+ ```bash
+ # æŸ¥çœ‹å½“å‰tokençŠ¶æ€
+ kubeadm token list
+ 
+ # æ–¹æ³•1ï¼šç”Ÿæˆæ–°çš„joinå‘½ä»¤ï¼ˆæœ€ç®€å•ï¼‰
+ kubeadm token create --print-join-command
+ 
+ # æ–¹æ³•2ï¼šç”Ÿæˆæ°¸ä¸è¿‡æœŸçš„token
+ kubeadm token create --print-join-command --ttl=0
+ 
+ # æ–¹æ³•3ï¼šåˆ é™¤æ—§tokenå¹¶åˆ›å»ºæ–°token
+ kubeadm token delete <old-token-id>
+ kubeadm token create --print-join-command
+ ```
+ 
+ ç„¶ååœ¨ **WorkerèŠ‚ç‚¹** ä½¿ç”¨æ–°ç”Ÿæˆçš„joinå‘½ä»¤ï¼š
+ ```bash
+ # å¦‚æœä¹‹å‰joinå¤±è´¥ï¼Œå…ˆé‡ç½®
+ kubeadm reset -f
+ 
+ # ä½¿ç”¨æ–°çš„joinå‘½ä»¤
+ kubeadm join 172.16.0.10:6443 --token <new-token> --discovery-token-ca-cert-hash sha256:<hash>
+ ```
+ 
+ > ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š
+ > - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é»˜è®¤24å°æ—¶æœ‰æ•ˆæœŸï¼Œå®šæœŸæ›´æ–°token
+ > - æµ‹è¯•ç¯å¢ƒå¯ä»¥ä½¿ç”¨ `--ttl=0` åˆ›å»ºæ°¸ä¸è¿‡æœŸçš„token
+ > - æ›´å¤šè·å–joinå‘½ä»¤çš„æ–¹æ³•ï¼Œè¯·å‚è€ƒ [4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤](#421-è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤é‡è¦)
+ 
+ 
+ #### 7.6 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€
  **ç—‡çŠ¶**ï¼š`kubectl get pods -n kube-system` æ˜¾ç¤ºcorednsä¸ºPending
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦æ›´æ–°åé¢çš„7.6å’Œ7.7çš„ç¼–å·ï¼Œå› ä¸ºæˆ‘æ·»åŠ äº†7.5ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -866,5 +866,5 @@
  
  
- #### 7.6 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤
+ #### 7.7 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤
  ```bash
  # æŸ¥çœ‹æ‰€æœ‰podçŠ¶æ€å’Œé‡å¯æ¬¡æ•°
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æ›´æ–°7.7çš„ç¼–å·</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -889,5 +889,5 @@
  
  
- #### 7.7 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•
+ #### 7.8 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•
  åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´ï¼š
  ```bash
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦æ›´æ–°ç›®å½•ä¸­çš„ç¬¬ä¸ƒæ­¥éƒ¨åˆ†ï¼Œæ·»åŠ æ–°çš„7.5å¹¶æ›´æ–°7.6ã€7.7ã€7.8çš„ç¼–å·ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 4, lines removed: 3

```diff
@@ -44,7 +44,8 @@
    - [7.3 èŠ‚ç‚¹çŠ¶æ€NotReady](#73-èŠ‚ç‚¹çŠ¶æ€notready)
    - [7.4 workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤](#74-workerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤)
-   - [7.5 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€](#75-corednsä¸€ç›´å¤„äºpendingçŠ¶æ€)
-   - [7.6 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤](#76-é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤)
-   - [7.7 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•](#77-éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•)
+   - [7.5 Tokenè¿‡æœŸæ— æ³•åŠ å…¥workerèŠ‚ç‚¹](#75-tokenè¿‡æœŸæ— æ³•åŠ å…¥workerèŠ‚ç‚¹)
+   - [7.6 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€](#76-corednsä¸€ç›´å¤„äºpendingçŠ¶æ€)
+   - [7.7 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤](#77-é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤)
+   - [7.8 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•](#78-éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•)
  - [æ€»ç»“](#æ€»ç»“)
  
```

</details>

---

<think><details><summary>Thought Process</summary>å¾ˆå¥½ï¼ç°åœ¨æˆ‘å·²ç»å®Œæˆäº†æ‰€æœ‰çš„æ›´æ–°ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹åšäº†ä»€ä¹ˆï¼š

1. åœ¨4.1ä¸­æ·»åŠ äº†åˆå§‹åŒ–æˆåŠŸåçš„è¾“å‡ºç¤ºä¾‹ï¼Œå¼ºè°ƒè¦ä¿å­˜joinå‘½ä»¤
2. æ–°å¢äº†4.2.1å°èŠ‚ï¼Œè¯¦ç»†è¯´æ˜äº†3ç§è·å–workerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤çš„æ–¹æ³•
3. åœ¨ç¬¬äº”æ­¥æ·»åŠ äº†5.0å°èŠ‚ï¼Œè¯¦ç»†è¯´æ˜äº†å¦‚ä½•è·å–å’Œæ‰§è¡Œjoinå‘½ä»¤ï¼ŒåŒ…æ‹¬æˆåŠŸè¾“å‡ºç¤ºä¾‹
4. ä¼˜åŒ–äº†7.4é—®é¢˜æ’æŸ¥éƒ¨åˆ†ï¼Œæ·»åŠ äº†æ›´è¯¦ç»†çš„é”™è¯¯åŸå› å’Œè§£å†³æ–¹æ³•
5. æ–°å¢äº†7.5å°èŠ‚ï¼Œä¸“é—¨å¤„ç†tokenè¿‡æœŸçš„é—®é¢˜
6. æ›´æ–°äº†æ‰€æœ‰ç›¸å…³çš„ç›®å½•é“¾æ¥

ç°åœ¨æ–‡æ¡£æ›´åŠ å®Œå–„äº†ï¼Œç”¨æˆ·ä¸ä¼šå†å›°æƒ‘å¦‚ä½•è·å–workerèŠ‚ç‚¹çš„joinå‘½ä»¤ã€‚</details></think>

---

å®Œæˆï¼æˆ‘å·²ç»ä¼˜åŒ–äº†æ–‡æ¡£ï¼Œæ·»åŠ äº†å…³äºè·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤çš„è¯¦ç»†è¯´æ˜ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦æ”¹è¿›ï¼š

## ğŸ“ **ä¼˜åŒ–å†…å®¹æ€»ç»“**

### **1. ç¬¬å››æ­¥ - å¢å¼ºMasteråˆå§‹åŒ–è¯´æ˜**
- âœ… åœ¨ **4.1** ä¸­æ·»åŠ äº†åˆå§‹åŒ–æˆåŠŸåçš„**å®Œæ•´è¾“å‡ºç¤ºä¾‹**
- âœ… çªå‡ºå¼ºè°ƒ**å¿…é¡»ä¿å­˜joinå‘½ä»¤**çš„é‡è¦æ€§
- âœ… **æ–°å¢ 4.2.1 å°èŠ‚**ï¼šè¯¦ç»†è¯´æ˜å¦‚ä½•è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤

### **2. æ–°å¢ 4.2.1 - è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤ï¼ˆé‡è¦ï¼ï¼‰**
æä¾›äº†**3ç§è·å–æ–¹æ³•**ï¼š
- **æ–¹æ³•1**ï¼šæŸ¥çœ‹ç°æœ‰tokenå¹¶ç”Ÿæˆå‘½ä»¤
- **æ–¹æ³•2**ï¼šåˆ›å»ºæ–°tokenå¹¶ç”Ÿæˆå‘½ä»¤ï¼ˆæ¨èï¼‰
- **æ–¹æ³•3**ï¼šæ‰‹åŠ¨æ‹¼æ¥joinå‘½ä»¤

åŒ…å«ï¼š
- å¿«é€Ÿè·å–å‘½ä»¤ï¼š`kubeadm token create --print-join-command`
- åˆ›å»ºæ°¸ä¸è¿‡æœŸtokenï¼š`--ttl=0`
- Tokenç®¡ç†å‘½ä»¤ï¼š`kubeadm token list`

### **3. ç¬¬äº”æ­¥ - é‡æ–°ç»„ç»‡WorkeråŠ å…¥æµç¨‹**
- âœ… **æ–°å¢ 5.0 å°èŠ‚**ï¼šè¯¦ç»†çš„ä¸¤æ­¥éª¤æµç¨‹
  - æ­¥éª¤1ï¼šåœ¨MasterèŠ‚ç‚¹è·å–joinå‘½ä»¤
  - æ­¥éª¤2ï¼šåœ¨WorkerèŠ‚ç‚¹æ‰§è¡Œjoinå‘½ä»¤
- âœ… æ·»åŠ äº†**æˆåŠŸåŠ å…¥çš„å®Œæ•´è¾“å‡ºç¤ºä¾‹**
- âœ… å¼•ç”¨4.2.1è·å–æ›´å¤šæ–¹æ³•

### **4. ç¬¬ä¸ƒæ­¥ - å¢å¼ºé—®é¢˜æ’æŸ¥**
- âœ… **ä¼˜åŒ– 7.4**ï¼šworkerèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤
  - æ·»åŠ äº†4ä¸ªå¸¸è§é”™è¯¯åŸå› 
  - è¯¦ç»†çš„æ’æŸ¥æ­¥éª¤
  - å®Œæ•´çš„è§£å†³æ–¹æ³•ï¼ˆåŒ…æ‹¬containerdé…ç½®ä¿®å¤ï¼‰
  
- âœ… **æ–°å¢ 7.5**ï¼šTokenè¿‡æœŸæ— æ³•åŠ å…¥workerèŠ‚ç‚¹
  - ä¸“é—¨å¤„ç†tokenè¿‡æœŸé—®é¢˜
  - æä¾›3ç§è§£å†³æ–¹æ³•
  - ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µå»ºè®®

### **5. æ›´æ–°ç›®å½•ç»“æ„**
æ‰€æœ‰æ–°å¢å°èŠ‚éƒ½å·²æ·»åŠ åˆ°ç›®å½•ä¸­ï¼Œæ–¹ä¾¿å¿«é€Ÿå¯¼èˆªã€‚

---

## ğŸ¯ **ç°åœ¨ç”¨æˆ·å¯ä»¥è½»æ¾æ‰¾åˆ°å¦‚ä½•è·å–joinå‘½ä»¤**

**å¿«é€ŸæŸ¥æ‰¾è·¯å¾„**ï¼š
1. **ç›®å½•** â†’ 4.2.1 è·å–WorkerèŠ‚ç‚¹åŠ å…¥å‘½ä»¤
2. **ç¬¬äº”æ­¥** â†’ 5.0 è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤
3. **é—®é¢˜æ’æŸ¥** â†’ 7.4 å’Œ 7.5

**ä¸€å¥è¯å¿«é€Ÿæ–¹æ¡ˆ**ï¼š
```bash
# åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ
kubeadm token create --print-join-command
```

æ–‡æ¡£ç°åœ¨æ›´åŠ å®Œå–„ï¼Œç”¨æˆ·ä¸ä¼šå†å›°æƒ‘äº†ï¼ğŸ‰

---

_**User (2025-10-23 03:09Z)**_

é‚£å¦‚æœè¿˜æœ‰æ–°çš„æœºå™¨éœ€è¦åŠ å…¥masterå½“ä½œmaster2å‘¢ï¼Ÿï¼ˆä¸æ˜¯workerï¼‰

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·é—®çš„æ˜¯å¦‚ä½•æ·»åŠ ç¬¬äºŒä¸ªMasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰ï¼Œè€Œä¸æ˜¯WorkerèŠ‚ç‚¹ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œå› ä¸ºå½“å‰æ–‡æ¡£åªæ¶µç›–äº†å•Masterçš„éƒ¨ç½²æ–¹å¼ã€‚

Kubernetesé«˜å¯ç”¨é›†ç¾¤éœ€è¦ï¼š
1. å¤šä¸ªMasterèŠ‚ç‚¹ï¼ˆé€šå¸¸3ä¸ªæˆ–5ä¸ªï¼‰
2. è´Ÿè½½å‡è¡¡å™¨ï¼ˆHAProxyæˆ–Nginxï¼‰åˆ†å‘åˆ°å¤šä¸ªAPI Server
3. ä½¿ç”¨ `--control-plane` å‚æ•°åŠ å…¥
4. éœ€è¦ä¸Šä¼ è¯ä¹¦

æˆ‘åº”è¯¥åœ¨æ–‡æ¡£ä¸­æ·»åŠ è¿™éƒ¨åˆ†å†…å®¹ã€‚è®©æˆ‘æ·»åŠ ä¸€ä¸ªæ–°çš„ç« èŠ‚æ¥è¯´æ˜å¦‚ä½•æ·»åŠ é¢å¤–çš„MasterèŠ‚ç‚¹ã€‚</details></think>

---

å¥½é—®é¢˜ï¼æ·»åŠ é¢å¤–çš„MasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨HAé›†ç¾¤ï¼‰å’Œæ·»åŠ WorkerèŠ‚ç‚¹çš„æµç¨‹ä¸åŒã€‚è®©æˆ‘ä¸ºæ–‡æ¡£æ·»åŠ è¿™éƒ¨åˆ†é‡è¦å†…å®¹ã€‚

---

Tool use: **read_file**

Read file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md

---

<think><details><summary>Thought Process</summary>æˆ‘éœ€è¦åœ¨ç¬¬äº”æ­¥ä¹‹åæ·»åŠ ä¸€ä¸ªæ–°ç« èŠ‚ï¼Œä¸“é—¨è®²è§£å¦‚ä½•æ·»åŠ é¢å¤–çš„MasterèŠ‚ç‚¹ã€‚è¿™åº”è¯¥æ˜¯ç¬¬äº”æ­¥å’Œç¬¬å…­æ­¥ä¹‹é—´çš„æ–°ç« èŠ‚ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 6, lines removed: undefined

```diff
@@ -32,4 +32,10 @@
    - [5.0 è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤](#50-è·å–å¹¶æ‰§è¡Œjoinå‘½ä»¤)
    - [5.1 éªŒè¯WorkerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ](#51-éªŒè¯workerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ)
+ - [ç¬¬äº”æ­¥è¡¥å……ï¼šæ·»åŠ é¢å¤–MasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰](#ç¬¬äº”æ­¥è¡¥å……æ·»åŠ é¢å¤–masterèŠ‚ç‚¹é«˜å¯ç”¨é›†ç¾¤)
+   - [5A.1 é«˜å¯ç”¨æ¶æ„è¯´æ˜](#5a1-é«˜å¯ç”¨æ¶æ„è¯´æ˜)
+   - [5A.2 å‰ææ¡ä»¶](#5a2-å‰ææ¡ä»¶)
+   - [5A.3 è·å–MasteråŠ å…¥å‘½ä»¤](#5a3-è·å–masteråŠ å…¥å‘½ä»¤)
+   - [5A.4 åœ¨æ–°MasterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥](#5a4-åœ¨æ–°masterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥)
+   - [5A.5 éªŒè¯å¤šMasteré›†ç¾¤](#5a5-éªŒè¯å¤šmasteré›†ç¾¤)
  - [ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€](#ç¬¬å…­æ­¥å…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€masterèŠ‚ç‚¹æ‰§è¡Œ)
    - [6.1 èŠ‚ç‚¹çŠ¶æ€éªŒè¯](#61-èŠ‚ç‚¹çŠ¶æ€éªŒè¯)
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨æˆ‘éœ€è¦åœ¨ç¬¬äº”æ­¥WorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¹‹åï¼Œæ·»åŠ æ–°çš„ç« èŠ‚å†…å®¹ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 406, lines removed: undefined

```diff
@@ -532,4 +532,410 @@
  > âœ… **éªŒè¯æˆåŠŸæ ‡å‡†**ï¼šworkerèŠ‚ç‚¹kubeletè¿è¡Œæ­£å¸¸ã€åœ¨masterä¸Šå¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸ºReadyã€flannelåœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œã€‚
  
+ 
+ ---
+ 
+ ## **ç¬¬äº”æ­¥è¡¥å……ï¼šæ·»åŠ é¢å¤–MasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰**
+ 
+ > âš ï¸ **è¯´æ˜**ï¼šæœ¬èŠ‚å†…å®¹é€‚ç”¨äºéœ€è¦éƒ¨ç½²**é«˜å¯ç”¨ï¼ˆHAï¼‰Kubernetesé›†ç¾¤**çš„åœºæ™¯ã€‚å¦‚æœåªéœ€è¦å•Masteré›†ç¾¤ï¼Œå¯ä»¥è·³è¿‡æ­¤ç« èŠ‚ã€‚
+ 
+ ### **5A.1 é«˜å¯ç”¨æ¶æ„è¯´æ˜**
+ 
+ **ä¸ºä»€ä¹ˆéœ€è¦å¤šMasterèŠ‚ç‚¹ï¼Ÿ**
+ - å•MasterèŠ‚ç‚¹å­˜åœ¨å•ç‚¹æ•…éšœé£é™©
+ - MasterèŠ‚ç‚¹å®•æœºä¼šå¯¼è‡´é›†ç¾¤ç®¡ç†åŠŸèƒ½ä¸å¯ç”¨
+ - ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®éƒ¨ç½²å¤šMasteré«˜å¯ç”¨æ¶æ„
+ 
+ **é«˜å¯ç”¨æ¶æ„è¦æ±‚**ï¼š
+ ```
+                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+                       â”‚  Load Balancer  â”‚  (HAProxy/Nginx/VIP)
+                       â”‚   172.16.0.100  â”‚
+                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                                â”‚
+           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+           â”‚                    â”‚                    â”‚
+     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
+     â”‚  Master1  â”‚        â”‚  Master2  â”‚      â”‚  Master3  â”‚
+     â”‚172.16.0.10â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚172.16.0.11â”‚â—„â”€â”€â”€â”€â–ºâ”‚172.16.0.12â”‚
+     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+          â”‚                     â”‚                   â”‚
+     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
+     â”‚                   â”‚             â”‚                â”‚
+ â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
+ â”‚Worker1 â”‚        â”‚Worker2  â”‚   â”‚Worker3  â”‚    â”‚ Worker4  â”‚
+ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+ ```
+ 
+ **ç»„ä»¶è¯´æ˜**ï¼š
+ - **Load Balancerï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰**ï¼šå¿…éœ€ï¼Œåˆ†å‘API Serverè¯·æ±‚
+ - **å¤šä¸ªMasterèŠ‚ç‚¹**ï¼šé€šå¸¸3ä¸ªæˆ–5ä¸ªï¼ˆå¥‡æ•°ä¸ªï¼Œä¾¿äºetcdé›†ç¾¤é€‰ä¸¾ï¼‰
+ - **Etcdé›†ç¾¤**ï¼šè‡ªåŠ¨åœ¨å¤šä¸ªMasterèŠ‚ç‚¹é—´å½¢æˆé«˜å¯ç”¨
+ 
+ ---
+ 
+ ### **5A.2 å‰ææ¡ä»¶**
+ 
+ åœ¨æ·»åŠ æ–°MasterèŠ‚ç‚¹ä¹‹å‰ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
+ 
+ #### 1. ç¬¬ä¸€ä¸ªMasterå¿…é¡»ä½¿ç”¨ç‰¹å®šå‚æ•°åˆå§‹åŒ–
+ 
+ å¦‚æœæ‚¨å·²ç»æŒ‰ç…§å‰é¢æ­¥éª¤åˆå§‹åŒ–äº†**å•Masteré›†ç¾¤**ï¼Œè¦æ”¹ä¸ºé«˜å¯ç”¨é›†ç¾¤éœ€è¦ï¼š
+ 
+ **âŒ å·²æœ‰å•Masteré›†ç¾¤æ”¹é€ ï¼ˆå¤æ‚ï¼‰**ï¼š
+ - éœ€è¦é‡æ–°åˆå§‹åŒ–æ•´ä¸ªé›†ç¾¤
+ - æˆ–ä½¿ç”¨ `kubeadm alpha phase` ç›¸å…³å‘½ä»¤ï¼ˆä¸æ¨èï¼‰
+ 
+ **âœ… å…¨æ–°éƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤ï¼ˆæ¨èï¼‰**ï¼š
+ 
+ åœ¨ç¬¬4.1æ­¥åˆå§‹åŒ–ç¬¬ä¸€ä¸ªMasteræ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š
+ 
+ ```bash
+ # é«˜å¯ç”¨é›†ç¾¤åˆå§‹åŒ–å‘½ä»¤ï¼ˆä¸å•Masterä¸åŒï¼‰
+ kubeadm init \
+   --image-repository registry.aliyuncs.com/google_containers \
+   --kubernetes-version v1.28.0 \
+   --pod-network-cidr=10.244.0.0/16 \
+   --control-plane-endpoint "172.16.0.100:6443" \  # è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼ˆé‡è¦ï¼ï¼‰
+   --upload-certs \  # è‡ªåŠ¨ä¸Šä¼ è¯ä¹¦åˆ°é›†ç¾¤ï¼ˆé‡è¦ï¼ï¼‰
+   --apiserver-advertise-address=172.16.0.10  # å½“å‰Masterçš„IP
+ ```
+ 
+ **å…³é”®å‚æ•°è¯´æ˜**ï¼š
+ - `--control-plane-endpoint`ï¼š**è´Ÿè½½å‡è¡¡å™¨çš„VIPæˆ–åŸŸå**ï¼ˆå¿…éœ€ï¼‰
+ - `--upload-certs`ï¼šè‡ªåŠ¨ä¸Šä¼ è¯ä¹¦ï¼Œå…è®¸å…¶ä»–MasteråŠ å…¥ï¼ˆå¿…éœ€ï¼‰
+ 
+ #### 2. å‡†å¤‡è´Ÿè½½å‡è¡¡å™¨
+ 
+ æ‚¨éœ€è¦æå‰é…ç½®è´Ÿè½½å‡è¡¡å™¨ï¼ˆé€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹æ¡ˆï¼‰ï¼š
+ 
+ **æ–¹æ¡ˆAï¼šä½¿ç”¨HAProxyï¼ˆæ¨èï¼‰**
+ ```bash
+ # åœ¨ç‹¬ç«‹æœåŠ¡å™¨æˆ–Master1ä¸Šå®‰è£…HAProxy
+ dnf install -y haproxy
+ 
+ # é…ç½®HAProxyï¼ˆ/etc/haproxy/haproxy.cfgï¼‰
+ cat >> /etc/haproxy/haproxy.cfg << EOF
+ 
+ frontend kubernetes-frontend
+     bind *:6443
+     mode tcp
+     option tcplog
+     default_backend kubernetes-backend
+ 
+ backend kubernetes-backend
+     mode tcp
+     option tcp-check
+     balance roundrobin
+     server master1 172.16.0.10:6443 check fall 3 rise 2
+     server master2 172.16.0.11:6443 check fall 3 rise 2
+     server master3 172.16.0.12:6443 check fall 3 rise 2
+ EOF
+ 
+ # å¯åŠ¨HAProxy
+ systemctl restart haproxy
+ systemctl enable haproxy
+ ```
+ 
+ **æ–¹æ¡ˆBï¼šä½¿ç”¨Nginxï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰**
+ ```bash
+ # å®‰è£…Nginx
+ dnf install -y nginx nginx-mod-stream
+ 
+ # é…ç½®Nginxï¼ˆ/etc/nginx/nginx.confï¼‰
+ # åœ¨ http å—ä¹‹å¤–æ·»åŠ ï¼š
+ stream {
+     upstream kubernetes {
+         server 172.16.0.10:6443 max_fails=3 fail_timeout=30s;
+         server 172.16.0.11:6443 max_fails=3 fail_timeout=30s;
+         server 172.16.0.12:6443 max_fails=3 fail_timeout=30s;
+     }
+     server {
+         listen 6443;
+         proxy_pass kubernetes;
+     }
+ }
+ 
+ # å¯åŠ¨Nginx
+ systemctl restart nginx
+ systemctl enable nginx
+ ```
+ 
+ **æ–¹æ¡ˆCï¼šä½¿ç”¨Keepalived VIPï¼ˆç”Ÿäº§æ¨èï¼‰**
+ - åœ¨å¤šä¸ªMasterèŠ‚ç‚¹ä¸Šé…ç½®Keepalived
+ - æä¾›æµ®åŠ¨VIPï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
+ - é…ç½®è¾ƒå¤æ‚ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ
+ 
+ #### 3. æ–°MasterèŠ‚ç‚¹å‡†å¤‡
+ 
+ æ–°çš„MasterèŠ‚ç‚¹ï¼ˆå¦‚master2ï¼‰å¿…é¡»å®Œæˆï¼š
+ - âœ… ç¬¬ä¸€æ­¥ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡ï¼ˆé˜²ç«å¢™ã€SELinuxã€Swapç­‰ï¼‰
+ - âœ… ç¬¬äºŒæ­¥ï¼šå®‰è£…å¹¶é…ç½®Containerd
+ - âœ… ç¬¬ä¸‰æ­¥ï¼šå®‰è£…kubeletã€kubeadmã€kubectl
+ - âœ… ç¡®ä¿èƒ½è®¿é—®è´Ÿè½½å‡è¡¡å™¨å’Œç¬¬ä¸€ä¸ªMasterèŠ‚ç‚¹
+ 
+ ---
+ 
+ ### **5A.3 è·å–MasteråŠ å…¥å‘½ä»¤**
+ 
+ åœ¨**ç¬¬ä¸€ä¸ªMasterèŠ‚ç‚¹ï¼ˆmaster1ï¼‰**æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–æ–°MasteråŠ å…¥çš„å‘½ä»¤ï¼š
+ 
+ #### æ–¹æ³•1ï¼šä»åˆå§‹åŒ–è¾“å‡ºè·å–ï¼ˆæ¨èï¼‰
+ 
+ å¦‚æœåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨äº† `--upload-certs`ï¼Œè¾“å‡ºä¸­ä¼šåŒ…å«MasteråŠ å…¥å‘½ä»¤ï¼š
+ 
+ ```
+ You can now join any number of control-plane nodes by running the following command on each as root:
+ 
+   kubeadm join 172.16.0.100:6443 --token abcdef.0123456789abcdef \
+         --discovery-token-ca-cert-hash sha256:1234...abcd \
+         --control-plane --certificate-key abc123...def456
+ ```
+ 
+ > ğŸ’¡ **é‡è¦**ï¼šå¿…é¡»ä¿å­˜åŒ…å« `--control-plane` å’Œ `--certificate-key` çš„å®Œæ•´å‘½ä»¤ï¼
+ 
+ #### æ–¹æ³•2ï¼šé‡æ–°ç”Ÿæˆè¯ä¹¦å¯†é’¥ï¼ˆå¦‚æœå¿˜è®°ä¿å­˜ï¼‰
+ 
+ ```bash
+ # 1. é‡æ–°ä¸Šä¼ è¯ä¹¦åˆ°é›†ç¾¤ï¼ˆcertificate-keyæœ‰æ•ˆæœŸ2å°æ—¶ï¼‰
+ kubeadm init phase upload-certs --upload-certs
+ 
+ # è¾“å‡ºç±»ä¼¼ï¼š
+ # [upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
+ # [upload-certs] Using certificate key:
+ # abc123def456abc123def456abc123def456abc123def456abc123def456abcd
+ 
+ # 2. åˆ›å»ºtoken
+ kubeadm token create --print-join-command
+ 
+ # è¾“å‡ºç±»ä¼¼ï¼š
+ # kubeadm join 172.16.0.100:6443 --token xyz789.abc123def456 \
+ #     --discovery-token-ca-cert-hash sha256:1234...abcd
+ 
+ # 3. æ‰‹åŠ¨æ‹¼æ¥å®Œæ•´çš„MasteråŠ å…¥å‘½ä»¤ï¼š
+ kubeadm join 172.16.0.100:6443 \
+   --token xyz789.abc123def456 \
+   --discovery-token-ca-cert-hash sha256:1234...abcd \
+   --control-plane \
+   --certificate-key abc123def456abc123def456abc123def456abc123def456abc123def456abcd
+ ```
+ 
+ #### æ–¹æ³•3ï¼šä¸€é”®ç”Ÿæˆå®Œæ•´å‘½ä»¤ï¼ˆæœ€ç®€å•ï¼‰
+ 
+ ```bash
+ # åˆ›å»ºtokenå¹¶ä¸Šä¼ è¯ä¹¦ï¼Œè¾“å‡ºå®Œæ•´å‘½ä»¤
+ kubeadm token create --print-join-command --certificate-key $(kubeadm init phase upload-certs --upload-certs 2>/dev/null | tail -1)
+ ```
+ 
+ **å…³é”®å‚æ•°è¯´æ˜**ï¼š
+ - `--control-plane`ï¼šè¡¨ç¤ºåŠ å…¥ä¸ºMasterèŠ‚ç‚¹ï¼ˆè€ŒéWorkerï¼‰
+ - `--certificate-key`ï¼šç”¨äºè§£å¯†é›†ç¾¤è¯ä¹¦ï¼ˆ2å°æ—¶æœ‰æ•ˆæœŸï¼‰
+ - è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼š`172.16.0.100:6443`ï¼ˆè€Œémaster1çš„IPï¼‰
+ 
+ ---
+ 
+ ### **5A.4 åœ¨æ–°MasterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥**
+ 
+ åœ¨**æ–°çš„MasterèŠ‚ç‚¹ï¼ˆå¦‚master2ã€master3ï¼‰**ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
+ 
+ #### æ­¥éª¤1ï¼šæ‰§è¡ŒMasteråŠ å…¥å‘½ä»¤
+ 
+ ```bash
+ # åœ¨æ–°MasterèŠ‚ç‚¹æ‰§è¡Œï¼ˆä½¿ç”¨ä¸Šä¸€æ­¥è·å–çš„å®Œæ•´å‘½ä»¤ï¼‰
+ kubeadm join 172.16.0.100:6443 \
+   --token abcdef.0123456789abcdef \
+   --discovery-token-ca-cert-hash sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef \
+   --control-plane \
+   --certificate-key abc123def456abc123def456abc123def456abc123def456abc123def456abcd
+ ```
+ 
+ **æˆåŠŸè¾“å‡ºç¤ºä¾‹**ï¼š
+ ```
+ [preflight] Running pre-flight checks
+ [preflight] Reading configuration from the cluster...
+ [preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
+ [preflight] Running pre-flight checks before initializing the new control plane instance
+ [download-certs] Downloading the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
+ [certs] Using certificateDir folder "/etc/kubernetes/pki"
+ [certs] Generating "apiserver" certificate and key
+ [certs] Generating "apiserver-kubelet-client" certificate and key
+ ...
+ [mark-control-plane] Marking the node master2 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
+ [kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
+ [kubelet-start] Starting the kubelet
+ 
+ This node has joined the cluster and a new control plane instance was created:
+ 
+ * Certificate signing request was sent to apiserver and approval was received.
+ * The Kubelet was informed of the new secure connection details.
+ * Control plane label and taint were applied to the new node.
+ * The Kubernetes control plane instances scaled up.
+ 
+ To start administering your cluster from this node, you need to run the following as a regular user:
+ 
+         mkdir -p $HOME/.kube
+         sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
+         sudo chown $(id -u):$(id -g) $HOME/.kube/config
+ 
+ Run 'kubectl get nodes' to see this node join the cluster.
+ ```
+ 
+ > âœ… **åŠ å…¥æˆåŠŸæ ‡å¿—**ï¼šçœ‹åˆ° "This node has joined the cluster and a new control plane instance was created"
+ 
+ #### æ­¥éª¤2ï¼šé…ç½®kubectlï¼ˆåœ¨æ–°MasterèŠ‚ç‚¹ï¼‰
+ 
+ ```bash
+ # é…ç½®æ–°MasterèŠ‚ç‚¹çš„kubectlæƒé™
+ mkdir -p $HOME/.kube
+ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
+ chown $(id -u):$(id -g) $HOME/.kube/config
+ 
+ # éªŒè¯å¯ä»¥è®¿é—®é›†ç¾¤
+ kubectl get nodes
+ ```
+ 
+ #### æ­¥éª¤3ï¼šæ£€æŸ¥etcdé›†ç¾¤çŠ¶æ€ï¼ˆé‡è¦ï¼‰
+ 
+ ```bash
+ # åœ¨ä»»ä¸€MasterèŠ‚ç‚¹æ‰§è¡Œï¼ŒæŸ¥çœ‹etcdæˆå‘˜
+ kubectl exec -it -n kube-system etcd-master1 -- etcdctl \
+   --endpoints=https://127.0.0.1:2379 \
+   --cacert=/etc/kubernetes/pki/etcd/ca.crt \
+   --cert=/etc/kubernetes/pki/etcd/server.crt \
+   --key=/etc/kubernetes/pki/etcd/server.key \
+   member list
+ 
+ # åº”è¯¥çœ‹åˆ°å¤šä¸ªetcdæˆå‘˜
+ ```
+ 
+ ---
+ 
+ ### **5A.5 éªŒè¯å¤šMasteré›†ç¾¤**
+ 
+ #### 5A.5.1 éªŒè¯èŠ‚ç‚¹è§’è‰²
+ 
+ åœ¨**ä»»ä¸€MasterèŠ‚ç‚¹**æ‰§è¡Œï¼š
+ 
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåº”çœ‹åˆ°å¤šä¸ªcontrol-planeèŠ‚ç‚¹ï¼‰
+ kubectl get nodes
+ 
+ # é¢„æœŸè¾“å‡ºï¼š
+ # NAME       STATUS   ROLES           AGE   VERSION
+ # master1    Ready    control-plane   30m   v1.28.0
+ # master2    Ready    control-plane   5m    v1.28.0
+ # master3    Ready    control-plane   3m    v1.28.0
+ # worker1    Ready    <none>          10m   v1.28.0
+ # worker2    Ready    <none>          10m   v1.28.0
+ 
+ # æŸ¥çœ‹control-planeèŠ‚ç‚¹è¯¦æƒ…
+ kubectl get nodes --selector='node-role.kubernetes.io/control-plane'
+ ```
+ 
+ #### 5A.5.2 éªŒè¯Masterç»„ä»¶åˆ†å¸ƒ
+ 
+ ```bash
+ # æŸ¥çœ‹æ‰€æœ‰MasterèŠ‚ç‚¹ä¸Šçš„å…³é”®ç»„ä»¶
+ kubectl get pods -n kube-system -o wide | grep -E "apiserver|controller|scheduler|etcd"
+ 
+ # åº”è¯¥çœ‹åˆ°æ¯ä¸ªMasterèŠ‚ç‚¹ä¸Šéƒ½æœ‰ï¼š
+ # - kube-apiserver-masterX
+ # - kube-controller-manager-masterX
+ # - kube-scheduler-masterX
+ # - etcd-masterX
+ ```
+ 
+ #### 5A.5.3 æµ‹è¯•é«˜å¯ç”¨æ€§
+ 
+ ```bash
+ # 1. åœ¨Master2ä¸ŠæŸ¥çœ‹é›†ç¾¤çŠ¶æ€
+ kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes
+ 
+ # 2. æµ‹è¯•API Serverè´Ÿè½½å‡è¡¡ï¼ˆå¯é€‰ï¼‰
+ # ä¸´æ—¶åœæ­¢Master1çš„API Server
+ ssh root@172.16.0.10 "systemctl stop kubelet"
+ 
+ # ä»å…¶ä»–èŠ‚ç‚¹è®¿é—®é›†ç¾¤ï¼ˆåº”ä»ç„¶å¯ç”¨ï¼‰
+ kubectl get nodes
+ 
+ # æ¢å¤Master1
+ ssh root@172.16.0.10 "systemctl start kubelet"
+ ```
+ 
+ #### 5A.5.4 éªŒè¯etcdé›†ç¾¤å¥åº·
+ 
+ ```bash
+ # æŸ¥çœ‹etcdé›†ç¾¤å¥åº·çŠ¶æ€
+ kubectl exec -it -n kube-system etcd-master1 -- etcdctl \
+   --endpoints=https://172.16.0.10:2379,https://172.16.0.11:2379,https://172.16.0.12:2379 \
+   --cacert=/etc/kubernetes/pki/etcd/ca.crt \
+   --cert=/etc/kubernetes/pki/etcd/server.crt \
+   --key=/etc/kubernetes/pki/etcd/server.key \
+   endpoint health
+ 
+ # é¢„æœŸè¾“å‡ºï¼š
+ # https://172.16.0.10:2379 is healthy: successfully committed proposal: took = 2.345ms
+ # https://172.16.0.11:2379 is healthy: successfully committed proposal: took = 2.567ms
+ # https://172.16.0.12:2379 is healthy: successfully committed proposal: took = 2.123ms
+ ```
+ 
+ ---
+ 
+ ### **5A.6 å¸¸è§é—®é¢˜**
+ 
+ #### é—®é¢˜1ï¼šcertificate-keyè¿‡æœŸ
+ 
+ **ç—‡çŠ¶**ï¼šåŠ å…¥æ—¶æŠ¥é”™ "error execution phase control-plane-prepare/download-certs"
+ 
+ **è§£å†³**ï¼š
+ ```bash
+ # åœ¨Master1é‡æ–°ä¸Šä¼ è¯ä¹¦
+ kubeadm init phase upload-certs --upload-certs
+ 
+ # ä½¿ç”¨æ–°çš„certificate-keyé‡æ–°åŠ å…¥
+ ```
+ 
+ #### é—®é¢˜2ï¼šæ— æ³•è®¿é—®è´Ÿè½½å‡è¡¡å™¨
+ 
+ **ç—‡çŠ¶**ï¼šåŠ å…¥æ—¶æŠ¥é”™ "connection refused" æˆ– "i/o timeout"
+ 
+ **æ’æŸ¥**ï¼š
+ ```bash
+ # åœ¨æ–°MasterèŠ‚ç‚¹æµ‹è¯•è´Ÿè½½å‡è¡¡å™¨è¿é€šæ€§
+ telnet 172.16.0.100 6443
+ curl -k https://172.16.0.100:6443/healthz
+ ```
+ 
+ #### é—®é¢˜3ï¼šetcdé›†ç¾¤ä¸å¥åº·
+ 
+ **ç—‡çŠ¶**ï¼šMasterèŠ‚ç‚¹NotReadyï¼Œetcd podå¯åŠ¨å¤±è´¥
+ 
+ **æ’æŸ¥**ï¼š
+ ```bash
+ # æŸ¥çœ‹etcdæ—¥å¿—
+ kubectl logs -n kube-system etcd-master2 --tail=50
+ 
+ # æ£€æŸ¥etcdæ•°æ®ç›®å½•æƒé™
+ ls -la /var/lib/etcd
+ ```
+ 
+ ---
+ 
+ ### **5A.7 é«˜å¯ç”¨é›†ç¾¤æœ€ä½³å®è·µ**
+ 
+ 1. **MasterèŠ‚ç‚¹æ•°é‡**ï¼šæ¨è3ä¸ªæˆ–5ä¸ªï¼ˆå¥‡æ•°ï¼‰ï¼Œé¿å…è„‘è£‚
+ 2. **è´Ÿè½½å‡è¡¡å™¨**ï¼šå»ºè®®ä½¿ç”¨ç‹¬ç«‹çš„LBæˆ–Keepalived VIP
+ 3. **èŠ‚ç‚¹åˆ†å¸ƒ**ï¼šMasterèŠ‚ç‚¹åº”åˆ†å¸ƒåœ¨ä¸åŒæœºæ¶/å¯ç”¨åŒº
+ 4. **å®šæœŸå¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½etcdæ•°æ®
+ 5. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§MasterèŠ‚ç‚¹å’Œetcdé›†ç¾¤å¥åº·çŠ¶æ€
+ 
+ ---
+ 
+ > ğŸ“ **å°ç»“**ï¼š
+ > - é«˜å¯ç”¨é›†ç¾¤éœ€è¦è´Ÿè½½å‡è¡¡å™¨ + å¤šä¸ªMasterèŠ‚ç‚¹
+ > - ä½¿ç”¨ `--control-plane` å‚æ•°å°†èŠ‚ç‚¹åŠ å…¥ä¸ºMaster
+ > - å¿…é¡»åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ `--upload-certs` å’Œ `--control-plane-endpoint`
+ > - å•Masteré›†ç¾¤æ”¹é€ ä¸ºé«˜å¯ç”¨éœ€è¦é‡æ–°éƒ¨ç½²
+ 
+ ---
  
  ### **ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€ï¼ˆmasterèŠ‚ç‚¹æ‰§è¡Œï¼‰**
```

</details>

---

<think><details><summary>Thought Process</summary>Perfect! I've successfully added a comprehensive section on adding additional Master nodes for high availability. Now I should make sure the section numbering is correct in the document, since I added a new section between step 5 and step 6.</details></think>

---

å®Œæˆï¼æˆ‘å·²ç»ä¸ºæ–‡æ¡£æ·»åŠ äº†è¯¦ç»†çš„**é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æŒ‡å—**ã€‚ä»¥ä¸‹æ˜¯æ–°å¢å†…å®¹çš„æ€»ç»“ï¼š

## ğŸ“š **æ–°å¢ç« èŠ‚ï¼šç¬¬äº”æ­¥è¡¥å…… - æ·»åŠ é¢å¤–MasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰**

### **åŒ…å«çš„ä¸»è¦å†…å®¹ï¼š**

#### **5A.1 é«˜å¯ç”¨æ¶æ„è¯´æ˜**
- âœ… è¯¦ç»†çš„æ¶æ„å›¾ï¼ˆLoad Balancer + å¤šMaster + å¤šWorkerï¼‰
- âœ… ä¸ºä»€ä¹ˆéœ€è¦å¤šMasterèŠ‚ç‚¹
- âœ… ç»„ä»¶è¯´æ˜å’Œæ¶æ„è¦æ±‚

#### **5A.2 å‰ææ¡ä»¶**
- âœ… **å…³é”®åŒºåˆ«**ï¼šå•Master vs é«˜å¯ç”¨Masterçš„åˆå§‹åŒ–å‚æ•°å¯¹æ¯”
- âœ… å¿…éœ€çš„ä¸¤ä¸ªå‚æ•°ï¼š
  - `--control-plane-endpoint`ï¼šè´Ÿè½½å‡è¡¡å™¨åœ°å€
  - `--upload-certs`ï¼šè‡ªåŠ¨ä¸Šä¼ è¯ä¹¦
- âœ… **3ç§è´Ÿè½½å‡è¡¡å™¨æ–¹æ¡ˆ**ï¼š
  - HAProxyï¼ˆæ¨èï¼‰
  - Nginx Stream
  - Keepalived VIPï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… æ–°MasterèŠ‚ç‚¹å‡†å¤‡æ¸…å•

#### **5A.3 è·å–MasteråŠ å…¥å‘½ä»¤**
- âœ… **3ç§æ–¹æ³•**è·å–Master joinå‘½ä»¤ï¼š
  - æ–¹æ³•1ï¼šä»åˆå§‹åŒ–è¾“å‡ºè·å–
  - æ–¹æ³•2ï¼šé‡æ–°ç”Ÿæˆè¯ä¹¦å¯†é’¥
  - æ–¹æ³•3ï¼šä¸€é”®ç”Ÿæˆå®Œæ•´å‘½ä»¤ï¼ˆæœ€ç®€å•ï¼‰
- âœ… å…³é”®å‚æ•°è¯´æ˜ï¼š
  - `--control-plane`ï¼šæ ‡è¯†ä¸ºMasterèŠ‚ç‚¹
  - `--certificate-key`ï¼šè¯ä¹¦å¯†é’¥ï¼ˆ2å°æ—¶æœ‰æ•ˆæœŸï¼‰

#### **5A.4 åœ¨æ–°MasterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥**
- âœ… å®Œæ•´çš„åŠ å…¥æµç¨‹ï¼ˆ3ä¸ªæ­¥éª¤ï¼‰
- âœ… æˆåŠŸè¾“å‡ºç¤ºä¾‹
- âœ… é…ç½®kubectl
- âœ… æ£€æŸ¥etcdé›†ç¾¤çŠ¶æ€

#### **5A.5 éªŒè¯å¤šMasteré›†ç¾¤**
- âœ… éªŒè¯èŠ‚ç‚¹è§’è‰²ï¼ˆ5A.5.1ï¼‰
- âœ… éªŒè¯Masterç»„ä»¶åˆ†å¸ƒï¼ˆ5A.5.2ï¼‰
- âœ… æµ‹è¯•é«˜å¯ç”¨æ€§ï¼ˆ5A.5.3ï¼‰
- âœ… éªŒè¯etcdé›†ç¾¤å¥åº·ï¼ˆ5A.5.4ï¼‰

#### **5A.6 å¸¸è§é—®é¢˜**
- âœ… certificate-keyè¿‡æœŸ
- âœ… æ— æ³•è®¿é—®è´Ÿè½½å‡è¡¡å™¨
- âœ… etcdé›†ç¾¤ä¸å¥åº·

#### **5A.7 é«˜å¯ç”¨é›†ç¾¤æœ€ä½³å®è·µ**
- âœ… MasterèŠ‚ç‚¹æ•°é‡å»ºè®®
- âœ… è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©
- âœ… èŠ‚ç‚¹åˆ†å¸ƒç­–ç•¥
- âœ… å¤‡ä»½å’Œç›‘æ§å»ºè®®

---

## ğŸ¯ **å…³é”®çŸ¥è¯†ç‚¹**

### **å•Master vs é«˜å¯ç”¨Master åˆå§‹åŒ–å¯¹æ¯”**

**å•Masterï¼ˆå½“å‰æ–‡æ¡£çš„æ–¹å¼ï¼‰**ï¼š
```bash
kubeadm init \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.28.0 \
  --pod-network-cidr=10.244.0.0/16 \
  --apiserver-advertise-address=172.16.0.10
```

**é«˜å¯ç”¨Masterï¼ˆéœ€è¦æ·»åŠ Master2æ—¶ï¼‰**ï¼š
```bash
kubeadm init \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.28.0 \
  --pod-network-cidr=10.244.0.0/16 \
  --control-plane-endpoint "172.16.0.100:6443" \  # æ–°å¢ï¼šLBåœ°å€
  --upload-certs \  # æ–°å¢ï¼šä¸Šä¼ è¯ä¹¦
  --apiserver-advertise-address=172.16.0.10
```

### **è·å–Master joinå‘½ä»¤ï¼ˆä¸€é”®ï¼‰**

```bash
# åœ¨å·²æœ‰MasterèŠ‚ç‚¹æ‰§è¡Œ
kubeadm token create --print-join-command --certificate-key $(kubeadm init phase upload-certs --upload-certs 2>/dev/null | tail -1)
```

### **Worker join vs Master join çš„åŒºåˆ«**

**WorkerèŠ‚ç‚¹åŠ å…¥**ï¼š
```bash
kubeadm join 172.16.0.10:6443 --token xxx --discovery-token-ca-cert-hash sha256:xxx
```

**MasterèŠ‚ç‚¹åŠ å…¥**ï¼š
```bash
kubeadm join 172.16.0.100:6443 --token xxx --discovery-token-ca-cert-hash sha256:xxx \
  --control-plane \  # å…³é”®åŒºåˆ«
  --certificate-key yyy  # å…³é”®åŒºåˆ«
```

---

## âš ï¸ **é‡è¦æé†’**

1. **å•Masteré›†ç¾¤æ— æ³•ç›´æ¥å‡çº§ä¸ºé«˜å¯ç”¨**
   - éœ€è¦é‡æ–°åˆå§‹åŒ–æ•´ä¸ªé›†ç¾¤
   - æˆ–è€…ä½¿ç”¨å¤æ‚çš„æ‰‹åŠ¨è¿ç§»æµç¨‹

2. **å»ºè®®åœ¨é¡¹ç›®å¼€å§‹æ—¶å°±å†³å®šæ¶æ„**
   - ç”Ÿäº§ç¯å¢ƒï¼šå¼ºçƒˆå»ºè®®é«˜å¯ç”¨ï¼ˆ3 Masterï¼‰
   - æµ‹è¯•/å¼€å‘ç¯å¢ƒï¼šå•Masterå³å¯

3. **è´Ÿè½½å‡è¡¡å™¨æ˜¯å¿…éœ€çš„**
   - æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡LBè®¿é—®API Server
   - LBæœ¬èº«ä¹Ÿéœ€è¦é«˜å¯ç”¨ï¼ˆKeepalived VIPï¼‰

ç°åœ¨æ–‡æ¡£å·²ç»å®Œæ•´è¦†ç›–äº†å•Masterå’Œé«˜å¯ç”¨å¤šMasterä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼ğŸ‰

---

_**User (2025-10-23 03:32Z)**_

é‚£å¦‚æœé«˜å¯ç”¨æ¶æ„åŠ å…¥äº†è´Ÿè½½å‡è¡¡å™¨ï¼Œé‚£æˆ‘å¦‚æœç”¨æˆ·æ¥çš„è¯·æ±‚æ˜¯ç»™è´Ÿè½½å‡è¡¡å™¨è¿˜æ˜¯ç»™masterç»„ä¸­çš„masterèŠ‚ç‚¹ï¼Ÿ

---

_**Assistant (claude-4.5-sonnet-thinking)**_

<think><details><summary>Thought Process</summary>ç”¨æˆ·é—®äº†ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼šåœ¨é«˜å¯ç”¨æ¶æ„ä¸­ï¼Œç”¨æˆ·è¯·æ±‚åº”è¯¥å‘é€åˆ°è´Ÿè½½å‡è¡¡å™¨è¿˜æ˜¯ç›´æ¥å‘é€åˆ°MasterèŠ‚ç‚¹ï¼Ÿ

è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°Kubernetesé«˜å¯ç”¨æ¶æ„çš„æ ¸å¿ƒæ¦‚å¿µï¼š

1. **æ‰€æœ‰APIè¯·æ±‚éƒ½åº”è¯¥å‘é€åˆ°è´Ÿè½½å‡è¡¡å™¨**
   - kubectlå‘½ä»¤
   - kubeletï¼ˆworkerèŠ‚ç‚¹ï¼‰
   - åº”ç”¨ç¨‹åºè®¿é—®API Server
   - å…¶ä»–MasterèŠ‚ç‚¹ä¹‹é—´ä¹Ÿé€šè¿‡LBé€šä¿¡

2. **ä¸ºä»€ä¹ˆè¦é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Ÿ**
   - é«˜å¯ç”¨ï¼šä»»ä½•ä¸€ä¸ªMasterå®•æœºï¼ŒLBä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–Master
   - è´Ÿè½½åˆ†æ‹…ï¼šè¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªMasterçš„API Server
   - ç»Ÿä¸€å…¥å£ï¼šåªéœ€è¦è®°ä½ä¸€ä¸ªLBåœ°å€

3. **ä»€ä¹ˆæ—¶å€™ç›´æ¥è®¿é—®Masterï¼Ÿ**
   - å‡ ä¹ä¸éœ€è¦
   - é™¤éæ˜¯ç´§æ€¥æ•…éšœæ’æŸ¥

æˆ‘åº”è¯¥åœ¨æ–‡æ¡£ä¸­æ·»åŠ ä¸€ä¸ªæ¸…æ™°çš„è¯´æ˜ç« èŠ‚ï¼Œè§£é‡Šè¿™ä¸ªæ¶æ„ä¸­çš„æµé‡èµ°å‘ã€‚</details></think>

---

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘åœ¨æ–‡æ¡£ä¸­æ·»åŠ ä¸€ä¸ªæ¸…æ™°çš„è¯´æ˜ç« èŠ‚ï¼Œè§£é‡Šé«˜å¯ç”¨æ¶æ„ä¸­çš„æµé‡èµ°å‘ã€‚

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 150, lines removed: undefined

```diff
@@ -571,4 +571,154 @@
  - **å¤šä¸ªMasterèŠ‚ç‚¹**ï¼šé€šå¸¸3ä¸ªæˆ–5ä¸ªï¼ˆå¥‡æ•°ä¸ªï¼Œä¾¿äºetcdé›†ç¾¤é€‰ä¸¾ï¼‰
  - **Etcdé›†ç¾¤**ï¼šè‡ªåŠ¨åœ¨å¤šä¸ªMasterèŠ‚ç‚¹é—´å½¢æˆé«˜å¯ç”¨
+ 
+ ---
+ 
+ ### **5A.1.1 æµé‡èµ°å‘è¯´æ˜ï¼ˆé‡è¦ï¼ï¼‰**
+ 
+ > ğŸ’¡ **æ ¸å¿ƒåŸåˆ™**ï¼šåœ¨é«˜å¯ç”¨æ¶æ„ä¸­ï¼Œ**æ‰€æœ‰è®¿é—®API Serverçš„è¯·æ±‚éƒ½å¿…é¡»ç»è¿‡è´Ÿè½½å‡è¡¡å™¨**ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—®æŸä¸ªMasterèŠ‚ç‚¹ã€‚
+ 
+ #### **è°éœ€è¦è®¿é—®API Serverï¼Ÿ**
+ 
+ 1. **kubectlå‘½ä»¤**ï¼ˆç®¡ç†å‘˜/ç”¨æˆ·ï¼‰
+ 2. **kubelet**ï¼ˆæ‰€æœ‰Workerå’ŒMasterèŠ‚ç‚¹ï¼‰
+ 3. **kube-proxy**ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰
+ 4. **åº”ç”¨ç¨‹åºPod**ï¼ˆéœ€è¦è®¿é—®K8s APIæ—¶ï¼‰
+ 5. **å…¶ä»–MasterèŠ‚ç‚¹çš„ç»„ä»¶**ï¼ˆcontroller-managerã€schedulerç­‰ï¼‰
+ 
+ #### **æµé‡è·¯å¾„å¯¹æ¯”**
+ 
+ **âŒ é”™è¯¯æ–¹å¼ï¼ˆå•ç‚¹æ•…éšœï¼‰**ï¼š
+ ```
+ kubectl/WorkerèŠ‚ç‚¹ â”€â”€â”€â”€â”€â”€â–º Master1 (172.16.0.10:6443)
+                            â†“ å®•æœºåæ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨
+ ```
+ 
+ **âœ… æ­£ç¡®æ–¹å¼ï¼ˆé«˜å¯ç”¨ï¼‰**ï¼š
+ ```
+ kubectl/WorkerèŠ‚ç‚¹ â”€â”€â”€â”€â”€â”€â–º Load Balancer (172.16.0.100:6443)
+                            â”œâ”€â”€â–º Master1 (172.16.0.10:6443) âœ“
+                            â”œâ”€â”€â–º Master2 (172.16.0.11:6443) âœ“
+                            â””â”€â”€â–º Master3 (172.16.0.12:6443) âœ“
+                            ä»»ä½•ä¸€ä¸ªMasterå®•æœºï¼ŒLBè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–Master
+ ```
+ 
+ #### **å…·ä½“ç¤ºä¾‹**
+ 
+ **1. kubectlå‘½ä»¤é…ç½®**
+ 
+ æŸ¥çœ‹æ‚¨çš„kubectlé…ç½®æ–‡ä»¶ï¼ˆ`~/.kube/config`ï¼‰ï¼Œserveråœ°å€åº”è¯¥æ˜¯**è´Ÿè½½å‡è¡¡å™¨åœ°å€**ï¼š
+ 
+ ```yaml
+ apiVersion: v1
+ clusters:
+ - cluster:
+     certificate-authority-data: ...
+     server: https://172.16.0.100:6443  # âœ… è´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼Œä¸æ˜¯å•ä¸ªMaster
+   name: kubernetes
+ ```
+ 
+ **âŒ é”™è¯¯é…ç½®**ï¼š
+ ```yaml
+ server: https://172.16.0.10:6443  # å•ä¸ªMasterï¼Œå¤±å»é«˜å¯ç”¨æ„ä¹‰
+ ```
+ 
+ **2. WorkerèŠ‚ç‚¹kubeleté…ç½®**
+ 
+ WorkerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿåº”è¯¥æŒ‡å‘è´Ÿè½½å‡è¡¡å™¨ï¼š
+ 
+ ```bash
+ # âœ… æ­£ç¡®çš„joinå‘½ä»¤ï¼ˆæŒ‡å‘LBï¼‰
+ kubeadm join 172.16.0.100:6443 --token xxx --discovery-token-ca-cert-hash sha256:xxx
+ 
+ # âŒ é”™è¯¯çš„joinå‘½ä»¤ï¼ˆæŒ‡å‘å•ä¸ªMasterï¼‰
+ kubeadm join 172.16.0.10:6443 --token xxx --discovery-token-ca-cert-hash sha256:xxx
+ ```
+ 
+ **3. åº”ç”¨ç¨‹åºè®¿é—®K8s API**
+ 
+ åº”ç”¨ç¨‹åºå†…éƒ¨è®¿é—®API Serveræ—¶ï¼š
+ 
+ ```bash
+ # âœ… é€šè¿‡Serviceè®¿é—®ï¼ˆæ¨èï¼‰
+ curl https://kubernetes.default.svc.cluster.local:443
+ 
+ # âœ… æˆ–é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¤–éƒ¨è®¿é—®ï¼‰
+ curl https://172.16.0.100:6443
+ 
+ # âŒ ä¸è¦ç›´æ¥è®¿é—®å•ä¸ªMaster
+ curl https://172.16.0.10:6443
+ ```
+ 
+ #### **ä¸ºä»€ä¹ˆå¿…é¡»é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Ÿ**
+ 
+ | ç‰¹æ€§ | é€šè¿‡è´Ÿè½½å‡è¡¡å™¨ | ç›´æ¥è®¿é—®MasterèŠ‚ç‚¹ |
+ |------|----------------|-------------------|
+ | **é«˜å¯ç”¨** | âœ… Masterå®•æœºè‡ªåŠ¨åˆ‡æ¢ | âŒ å•ç‚¹æ•…éšœ |
+ | **è´Ÿè½½å‡è¡¡** | âœ… è¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªMaster | âŒ å•èŠ‚ç‚¹å‹åŠ›å¤§ |
+ | **æ•…éšœè½¬ç§»** | âœ… è‡ªåŠ¨ï¼ˆç§’çº§ï¼‰ | âŒ éœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½® |
+ | **ç»´æŠ¤ä¾¿åˆ©** | âœ… å¯ä»¥é€ä¸ªå‡çº§Master | âŒ å‡çº§æœŸé—´é›†ç¾¤ä¸å¯ç”¨ |
+ | **ç”Ÿäº§å¯ç”¨** | âœ… ç¬¦åˆæœ€ä½³å®è·µ | âŒ ä¸æ¨è |
+ 
+ #### **ç‰¹æ®Šæƒ…å†µï¼šä½•æ—¶ç›´æ¥è®¿é—®Masterï¼Ÿ**
+ 
+ ä»…åœ¨ä»¥ä¸‹**ç´§æ€¥æ•…éšœæ’æŸ¥**åœºæ™¯å¯ä»¥ç›´æ¥è®¿é—®å•ä¸ªMasterï¼š
+ 
+ ```bash
+ # åœºæ™¯1ï¼šè´Ÿè½½å‡è¡¡å™¨æ•…éšœï¼Œä¸´æ—¶è®¿é—®Master1
+ kubectl --server=https://172.16.0.10:6443 get nodes
+ 
+ # åœºæ™¯2ï¼šè°ƒè¯•ç‰¹å®šMasterèŠ‚ç‚¹çš„API Server
+ curl -k https://172.16.0.10:6443/healthz
+ 
+ # åœºæ™¯3ï¼šæ£€æŸ¥å•ä¸ªMasterçš„ç»„ä»¶çŠ¶æ€
+ ssh root@172.16.0.10
+ crictl ps
+ ```
+ 
+ **âš ï¸ æ³¨æ„**ï¼šè¿™äº›æ“ä½œä»…ç”¨äºä¸´æ—¶æ’æŸ¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹**å§‹ç»ˆé€šè¿‡è´Ÿè½½å‡è¡¡å™¨è®¿é—®**ã€‚
+ 
+ #### **éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®**
+ 
+ åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®è®¤æŒ‡å‘è´Ÿè½½å‡è¡¡å™¨ï¼š
+ 
+ ```bash
+ # æ£€æŸ¥kubectlé…ç½®
+ kubectl config view | grep server
+ # è¾“å‡ºåº”è¯¥æ˜¯ï¼šserver: https://172.16.0.100:6443
+ 
+ # æ£€æŸ¥kubeleté…ç½®ï¼ˆåœ¨workerèŠ‚ç‚¹ï¼‰
+ grep "server:" /etc/kubernetes/kubelet.conf
+ # è¾“å‡ºåº”è¯¥æ˜¯ï¼šserver: https://172.16.0.100:6443
+ 
+ # æ£€æŸ¥kube-proxyé…ç½®
+ kubectl get cm kube-proxy -n kube-system -o yaml | grep server
+ # è¾“å‡ºåº”è¯¥æ˜¯ï¼šserver: https://172.16.0.100:6443
+ ```
+ 
+ #### **æ¶æ„æ€»ç»“**
+ 
+ ```
+ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+ â”‚  æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆkubectl/kubelet/åº”ç”¨ï¼‰             â”‚
+ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                         â”‚
+                         â–¼
+             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+             â”‚   è´Ÿè½½å‡è¡¡å™¨ï¼ˆVIPï¼‰    â”‚  â—„â”€â”€â”€ å”¯ä¸€å…¥å£
+             â”‚   172.16.0.100:6443   â”‚
+             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                         â”‚
+         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+         â”‚               â”‚               â”‚
+         â–¼               â–¼               â–¼
+    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+    â”‚ Master1 â”‚    â”‚ Master2 â”‚    â”‚ Master3 â”‚
+    â”‚ API-6443â”‚    â”‚ API-6443â”‚    â”‚ API-6443â”‚
+    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+ ```
+ 
+ > ğŸ“ **è®°ä½**ï¼š
+ > - ç”¨æˆ·/åº”ç”¨ â†’ **è´Ÿè½½å‡è¡¡å™¨** â†’ Masteré›†ç¾¤ âœ…
+ > - ç”¨æˆ·/åº”ç”¨ â†’ ç›´æ¥è®¿é—®Master â†’ âŒ å¤±å»é«˜å¯ç”¨æ„ä¹‰
  
  ---
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨è¿˜éœ€è¦æ›´æ–°ç›®å½•ï¼Œæ·»åŠ è¿™ä¸ªæ–°çš„å°èŠ‚ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -34,4 +34,5 @@
  - [ç¬¬äº”æ­¥è¡¥å……ï¼šæ·»åŠ é¢å¤–MasterèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰](#ç¬¬äº”æ­¥è¡¥å……æ·»åŠ é¢å¤–masterèŠ‚ç‚¹é«˜å¯ç”¨é›†ç¾¤)
    - [5A.1 é«˜å¯ç”¨æ¶æ„è¯´æ˜](#5a1-é«˜å¯ç”¨æ¶æ„è¯´æ˜)
+   - [5A.1.1 æµé‡èµ°å‘è¯´æ˜](#5a11-æµé‡èµ°å‘è¯´æ˜é‡è¦)
    - [5A.2 å‰ææ¡ä»¶](#5a2-å‰ææ¡ä»¶)
    - [5A.3 è·å–MasteråŠ å…¥å‘½ä»¤](#5a3-è·å–masteråŠ å…¥å‘½ä»¤)
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨è¿˜åº”è¯¥åœ¨é—®é¢˜æ’æŸ¥ç« èŠ‚æ·»åŠ ä¸€ä¸ªå…³äºè´Ÿè½½å‡è¡¡å™¨æ•…éšœçš„æ’æŸ¥å†…å®¹ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 116, lines removed: 1

```diff
@@ -1453,5 +1453,120 @@
  
  
- #### 7.8 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•
+ #### 7.8 é«˜å¯ç”¨é›†ç¾¤è´Ÿè½½å‡è¡¡å™¨é—®é¢˜
+ 
+ > æ­¤éƒ¨åˆ†ä»…é€‚ç”¨äºéƒ¨ç½²äº†é«˜å¯ç”¨é›†ç¾¤ï¼ˆå¤šMasterï¼‰çš„ç”¨æˆ·
+ 
+ **ç—‡çŠ¶**ï¼škubectlå‘½ä»¤è¶…æ—¶ã€WorkerèŠ‚ç‚¹æ— æ³•åŠ å…¥ã€é›†ç¾¤ç®¡ç†åŠŸèƒ½ä¸å¯ç”¨
+ 
+ **å¸¸è§åŸå› **ï¼š
+ 1. è´Ÿè½½å‡è¡¡å™¨æœåŠ¡æœªå¯åŠ¨
+ 2. è´Ÿè½½å‡è¡¡å™¨é…ç½®é”™è¯¯
+ 3. é˜²ç«å¢™é˜»æ­¢6443ç«¯å£
+ 4. åç«¯MasterèŠ‚ç‚¹å…¨éƒ¨ä¸å¯ç”¨
+ 
+ **æ’æŸ¥æ­¥éª¤**ï¼š
+ 
+ **1. æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨æœåŠ¡çŠ¶æ€**
+ ```bash
+ # å¦‚æœä½¿ç”¨HAProxy
+ systemctl status haproxy
+ 
+ # å¦‚æœä½¿ç”¨Nginx
+ systemctl status nginx
+ 
+ # å¦‚æœä½¿ç”¨Keepalivedï¼ˆæ£€æŸ¥VIPï¼‰
+ ip addr show | grep 172.16.0.100
+ ```
+ 
+ **2. æµ‹è¯•è´Ÿè½½å‡è¡¡å™¨è¿é€šæ€§**
+ ```bash
+ # ä»ä»»æ„èŠ‚ç‚¹æµ‹è¯•LBç«¯å£
+ telnet 172.16.0.100 6443
+ nc -zv 172.16.0.100 6443
+ 
+ # æµ‹è¯•API Serverå¥åº·æ£€æŸ¥
+ curl -k https://172.16.0.100:6443/healthz
+ # åº”è¯¥è¿”å›ï¼šok
+ ```
+ 
+ **3. æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨é…ç½®**
+ ```bash
+ # HAProxyæ£€æŸ¥
+ cat /etc/haproxy/haproxy.cfg | grep -A 10 "backend kubernetes"
+ 
+ # Nginxæ£€æŸ¥
+ cat /etc/nginx/nginx.conf | grep -A 10 "upstream kubernetes"
+ 
+ # ç¡®è®¤åç«¯MasterèŠ‚ç‚¹é…ç½®æ­£ç¡®
+ # åº”è¯¥åŒ…å«æ‰€æœ‰MasterèŠ‚ç‚¹çš„IP:6443
+ ```
+ 
+ **4. æ£€æŸ¥åç«¯MasterèŠ‚ç‚¹å¥åº·çŠ¶æ€**
+ ```bash
+ # é€ä¸ªæµ‹è¯•MasterèŠ‚ç‚¹çš„API Server
+ curl -k https://172.16.0.10:6443/healthz
+ curl -k https://172.16.0.11:6443/healthz
+ curl -k https://172.16.0.12:6443/healthz
+ # è‡³å°‘æœ‰ä¸€ä¸ªåº”è¯¥è¿”å›ï¼šok
+ ```
+ 
+ **è§£å†³æ–¹æ³•**ï¼š
+ 
+ **åœºæ™¯1ï¼šè´Ÿè½½å‡è¡¡å™¨æœåŠ¡æœªå¯åŠ¨**
+ ```bash
+ # é‡å¯HAProxy
+ systemctl restart haproxy
+ systemctl enable haproxy
+ 
+ # æˆ–é‡å¯Nginx
+ systemctl restart nginx
+ systemctl enable nginx
+ ```
+ 
+ **åœºæ™¯2ï¼šè´Ÿè½½å‡è¡¡å™¨é…ç½®é”™è¯¯**
+ ```bash
+ # ä¿®æ­£HAProxyé…ç½®
+ vim /etc/haproxy/haproxy.cfg
+ # ç¡®ä¿backendé…ç½®æ­£ç¡®ï¼ŒåŒ…å«æ‰€æœ‰MasterèŠ‚ç‚¹
+ 
+ # é‡å¯æœåŠ¡
+ systemctl restart haproxy
+ 
+ # æŸ¥çœ‹æ—¥å¿—
+ journalctl -xeu haproxy -f
+ ```
+ 
+ **åœºæ™¯3ï¼šä¸´æ—¶ç»•è¿‡è´Ÿè½½å‡è¡¡å™¨ï¼ˆç´§æ€¥æƒ…å†µï¼‰**
+ ```bash
+ # ä¸´æ—¶ä¿®æ”¹kubectlé…ç½®ï¼Œç›´æ¥è®¿é—®å¯ç”¨çš„MasterèŠ‚ç‚¹
+ kubectl config set-cluster kubernetes --server=https://172.16.0.10:6443
+ 
+ # å®Œæˆç´§æ€¥æ“ä½œåï¼Œæ¢å¤LBé…ç½®
+ kubectl config set-cluster kubernetes --server=https://172.16.0.100:6443
+ ```
+ 
+ **åœºæ™¯4ï¼šKeepalived VIPæ¼‚ç§»é—®é¢˜**
+ ```bash
+ # æ£€æŸ¥VIPåœ¨å“ªä¸ªèŠ‚ç‚¹
+ ip addr show | grep 172.16.0.100
+ 
+ # æŸ¥çœ‹KeepalivedçŠ¶æ€
+ systemctl status keepalived
+ 
+ # æŸ¥çœ‹Keepalivedæ—¥å¿—
+ journalctl -xeu keepalived -n 50
+ 
+ # é‡å¯Keepalived
+ systemctl restart keepalived
+ ```
+ 
+ **æœ€ä½³å®è·µ**ï¼š
+ - ç›‘æ§è´Ÿè½½å‡è¡¡å™¨å¥åº·çŠ¶æ€
+ - é…ç½®è´Ÿè½½å‡è¡¡å™¨è‡ªèº«çš„é«˜å¯ç”¨ï¼ˆKeepalivedï¼‰
+ - å®šæœŸæµ‹è¯•æ•…éšœåˆ‡æ¢
+ - ä¿ç•™å•MasterèŠ‚ç‚¹ç›´è¿æ–¹å¼ä½œä¸ºåº”æ€¥å¤‡ç”¨
+ 
+ 
+ #### 7.9 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•
  åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´ï¼š
  ```bash
```

</details>

---

<think><details><summary>Thought Process</summary>éœ€è¦æ›´æ–°ç›®å½•ä¸­çš„7.8å’Œ7.9</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 2, lines removed: 1

```diff
@@ -54,5 +54,6 @@
    - [7.6 corednsä¸€ç›´å¤„äºPendingçŠ¶æ€](#76-corednsä¸€ç›´å¤„äºpendingçŠ¶æ€)
    - [7.7 é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤](#77-é€šç”¨é—®é¢˜æ’æŸ¥å‘½ä»¤)
-   - [7.8 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•](#78-éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•)
+   - [7.8 é«˜å¯ç”¨é›†ç¾¤è´Ÿè½½å‡è¡¡å™¨é—®é¢˜](#78-é«˜å¯ç”¨é›†ç¾¤è´Ÿè½½å‡è¡¡å™¨é—®é¢˜)
+   - [7.9 éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•](#79-éªŒè¯ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥æ¸…å•)
  - [æ€»ç»“](#æ€»ç»“)
  
```

</details>

---

<think><details><summary>Thought Process</summary>ç°åœ¨è¿˜éœ€è¦æ›´æ–°é™„å½•ä¸­çš„5A.6ï¼Œæ·»åŠ 5A.7å’Œ5A.8çš„å¼•ç”¨ã€‚</details></think>

---

Tool use: **search_replace**


<details><summary>Edit file: è¯¦ç»†ä½¿ç”¨é˜¿é‡Œæºå®‰è£…kubeadmã€kubeletã€kubectl.md</summary>

**Chunk 1**
Lines added: 2, lines removed: undefined

```diff
@@ -39,4 +39,6 @@
    - [5A.4 åœ¨æ–°MasterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥](#5a4-åœ¨æ–°masterèŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥)
    - [5A.5 éªŒè¯å¤šMasteré›†ç¾¤](#5a5-éªŒè¯å¤šmasteré›†ç¾¤)
+   - [5A.6 å¸¸è§é—®é¢˜](#5a6-å¸¸è§é—®é¢˜)
+   - [5A.7 é«˜å¯ç”¨é›†ç¾¤æœ€ä½³å®è·µ](#5a7-é«˜å¯ç”¨é›†ç¾¤æœ€ä½³å®è·µ)
  - [ç¬¬å…­æ­¥ï¼šå…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€](#ç¬¬å…­æ­¥å…¨é¢éªŒè¯é›†ç¾¤çŠ¶æ€masterèŠ‚ç‚¹æ‰§è¡Œ)
    - [6.1 èŠ‚ç‚¹çŠ¶æ€éªŒè¯](#61-èŠ‚ç‚¹çŠ¶æ€éªŒè¯)
```

</details>

---

<think><details><summary>Thought Process</summary>å¾ˆå¥½ï¼Œç°åœ¨æˆ‘å·²ç»å®Œæˆäº†å¯¹æ–‡æ¡£çš„ä¼˜åŒ–ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹åšäº†ä»€ä¹ˆã€‚</details></think>

---

å®Œç¾ï¼æˆ‘å·²ç»ä¸ºæ–‡æ¡£æ·»åŠ äº†è¯¦ç»†çš„æµé‡èµ°å‘è¯´æ˜å’Œè´Ÿè½½å‡è¡¡å™¨é—®é¢˜æ’æŸ¥ç« èŠ‚ã€‚è®©æˆ‘æ€»ç»“ä¸€ä¸‹æ–°å¢çš„å†…å®¹ï¼š

## ğŸ“ **æ–°å¢å†…å®¹æ€»ç»“**

### **1. æ–°å¢ 5A.1.1 - æµé‡èµ°å‘è¯´æ˜ï¼ˆé‡è¦ï¼ï¼‰**

è¿™ä¸ªç« èŠ‚è¯¦ç»†å›ç­”äº†æ‚¨çš„é—®é¢˜ï¼š"ç”¨æˆ·è¯·æ±‚åº”è¯¥å‘ç»™è´Ÿè½½å‡è¡¡å™¨è¿˜æ˜¯MasterèŠ‚ç‚¹ï¼Ÿ"

#### **æ ¸å¿ƒè¦ç‚¹**ï¼š
âœ… **æ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»é€šè¿‡è´Ÿè½½å‡è¡¡å™¨**ï¼ŒåŒ…æ‹¬ï¼š
- kubectlå‘½ä»¤
- WorkerèŠ‚ç‚¹çš„kubelet
- kube-proxy
- åº”ç”¨ç¨‹åºPod
- MasterèŠ‚ç‚¹ä¹‹é—´çš„ç»„ä»¶é€šä¿¡

#### **åŒ…å«å†…å®¹**ï¼š

**1. æµé‡è·¯å¾„å¯¹æ¯”å›¾**
```
æ­£ç¡®ï¼šå®¢æˆ·ç«¯ â†’ LB (172.16.0.100) â†’ Master1/2/3
é”™è¯¯ï¼šå®¢æˆ·ç«¯ â†’ Master1ç›´æ¥è®¿é—®ï¼ˆå•ç‚¹æ•…éšœï¼‰
```

**2. å…·ä½“é…ç½®ç¤ºä¾‹**
- kubectlé…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆ`~/.kube/config`ï¼‰
- Worker joinå‘½ä»¤å¯¹æ¯”
- åº”ç”¨ç¨‹åºè®¿é—®K8s APIçš„æ–¹å¼

**3. å¯¹æ¯”è¡¨æ ¼**
| ç‰¹æ€§ | é€šè¿‡LB | ç›´æ¥è®¿é—®Master |
|------|--------|--------------|
| é«˜å¯ç”¨ | âœ… | âŒ |
| è´Ÿè½½å‡è¡¡ | âœ… | âŒ |
| æ•…éšœè½¬ç§» | âœ…è‡ªåŠ¨ | âŒæ‰‹åŠ¨ |

**4. éªŒè¯å‘½ä»¤**
```bash
# æ£€æŸ¥kubectlé…ç½®
kubectl config view | grep server
# åº”è¯¥è¾“å‡ºï¼šserver: https://172.16.0.100:6443

# æ£€æŸ¥kubeleté…ç½®
grep "server:" /etc/kubernetes/kubelet.conf

# æ£€æŸ¥kube-proxyé…ç½®
kubectl get cm kube-proxy -n kube-system -o yaml | grep server
```

**5. ç‰¹æ®Šæƒ…å†µè¯´æ˜**
- ä»…åœ¨ç´§æ€¥æ•…éšœæ’æŸ¥æ—¶ç›´æ¥è®¿é—®Master
- æä¾›äº†ä¸´æ—¶ç»•è¿‡LBçš„å‘½ä»¤

**6. æ¶æ„æ€»ç»“å›¾**
æ¸…æ™°å±•ç¤ºäº†æ‰€æœ‰è¯·æ±‚â†’LBâ†’Masteré›†ç¾¤çš„æµå‘

---

### **2. æ–°å¢ 7.8 - é«˜å¯ç”¨é›†ç¾¤è´Ÿè½½å‡è¡¡å™¨é—®é¢˜**

ä¸“é—¨é’ˆå¯¹è´Ÿè½½å‡è¡¡å™¨æ•…éšœçš„æ’æŸ¥ç« èŠ‚ï¼š

#### **åŒ…å«çš„æ’æŸ¥åœºæ™¯**ï¼š

**åœºæ™¯1ï¼šè´Ÿè½½å‡è¡¡å™¨æœåŠ¡æœªå¯åŠ¨**
```bash
systemctl restart haproxy
systemctl restart nginx
```

**åœºæ™¯2ï¼šè´Ÿè½½å‡è¡¡å™¨é…ç½®é”™è¯¯**
- æ£€æŸ¥HAProxy/Nginxé…ç½®
- ç¡®è®¤åç«¯MasterèŠ‚ç‚¹åˆ—è¡¨

**åœºæ™¯3ï¼šä¸´æ—¶ç»•è¿‡è´Ÿè½½å‡è¡¡å™¨ï¼ˆç´§æ€¥æƒ…å†µï¼‰**
```bash
# ä¸´æ—¶ç›´è¿å¯ç”¨Master
kubectl config set-cluster kubernetes --server=https://172.16.0.10:6443
```

**åœºæ™¯4ï¼šKeepalived VIPæ¼‚ç§»é—®é¢˜**
- æ£€æŸ¥VIPä½ç½®
- æŸ¥çœ‹Keepalivedæ—¥å¿—
- é‡å¯Keepalived

#### **å®Œæ•´æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥LBæœåŠ¡çŠ¶æ€
2. æµ‹è¯•LBè¿é€šæ€§ï¼ˆtelnetã€curlï¼‰
3. æ£€æŸ¥LBé…ç½®æ–‡ä»¶
4. æ£€æŸ¥åç«¯Masterå¥åº·çŠ¶æ€

---

## ğŸ¯ **é—®é¢˜çš„æ ¸å¿ƒç­”æ¡ˆ**

### **ç”¨æˆ·è¯·æ±‚åº”è¯¥ç»™è°ï¼Ÿ**

**âœ… 100%ç»™è´Ÿè½½å‡è¡¡å™¨ï¼ˆ172.16.0.100:6443ï¼‰**

**åŸå› **ï¼š
1. **é«˜å¯ç”¨**ï¼šä»»ä½•Masterå®•æœºï¼Œè‡ªåŠ¨åˆ‡æ¢
2. **è´Ÿè½½åˆ†æ‹…**ï¼šè¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªMaster
3. **ç»Ÿä¸€å…¥å£**ï¼šåªéœ€è¦è®°ä½LBåœ°å€
4. **è¿ç»´ä¾¿åˆ©**ï¼šå¯ä»¥é€ä¸ªå‡çº§Masterè€Œä¸å½±å“æœåŠ¡

**âŒ ä¸è¦ç›´æ¥è®¿é—®MasterèŠ‚ç‚¹ï¼ˆ172.16.0.10:6443ï¼‰**

**é™¤é**ï¼š
- è´Ÿè½½å‡è¡¡å™¨å®Œå…¨æ•…éšœï¼ˆç´§æ€¥æ’æŸ¥ï¼‰
- è°ƒè¯•ç‰¹å®šMasterèŠ‚ç‚¹é—®é¢˜
- è¿™äº›éƒ½æ˜¯ä¸´æ—¶æ“ä½œï¼Œä¿®å¤åç«‹å³æ¢å¤LBæ–¹å¼

---

## ğŸ“Š **å®é™…å·¥ä½œæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·/ç®¡ç†å‘˜   â”‚
â”‚ kubectl cmd  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´Ÿè½½å‡è¡¡å™¨    â”‚  â—„â”€â”€ å”¯ä¸€å…¥å£ï¼Œæ°¸è¿œè®¿é—®è¿™é‡Œï¼
â”‚ 172.16.0.100 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ (è‡ªåŠ¨è´Ÿè½½å‡è¡¡)
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
   â–¼       â–¼       â–¼       â–¼
Master1  Master2  Master3  (ä»»ä½•ä¸€ä¸ªå®•æœºéƒ½ä¸å½±å“)
```

---

ç°åœ¨æ–‡æ¡£å·²ç»éå¸¸å®Œå–„äº†ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å•Masteré›†ç¾¤éƒ¨ç½²
- âœ… é«˜å¯ç”¨å¤šMasteré›†ç¾¤éƒ¨ç½²  
- âœ… WorkerèŠ‚ç‚¹åŠ å…¥æ–¹æ³•
- âœ… **æµé‡èµ°å‘è¯¦ç»†è¯´æ˜**ï¼ˆæ–°å¢ï¼‰
- âœ… å®Œæ•´çš„éªŒè¯æ­¥éª¤
- âœ… å…¨é¢çš„é—®é¢˜æ’æŸ¥ï¼ˆåŒ…æ‹¬LBé—®é¢˜ï¼‰
- âœ… ä¸¤ä¸ªè‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬

ç”¨æˆ·å†ä¹Ÿä¸ä¼šå¯¹"è¯·æ±‚åº”è¯¥å‘ç»™è°"æ„Ÿåˆ°å›°æƒ‘äº†ï¼ğŸ‰

---

